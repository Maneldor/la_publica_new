generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String           @id @default(cuid())
  email              String           @unique
  name               String?
  image              String?
  role               UserRole         @default(USER)
  communityId        String?
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  userType           UserType         @default(EMPLOYEE)
  ownedCompanyId     String?          @unique
  memberCompanyId    String?
  companyRole        CompanyRole?
  cargo              String?
  password           String?
  anunciosCreados    Anuncio[]        @relation("AnunciosCreados")
  comentariosCreados AnuncioComment[] @relation("ComentariosCreados")
  community          Comunidad?       @relation(fields: [communityId], references: [id])
  memberCompany      Company?         @relation("CompanyMembers", fields: [memberCompanyId], references: [id])
  ownedCompany       Company?         @relation("CompanyOwner", fields: [ownedCompanyId], references: [id])
  managedCompanies   Company[]        @relation("AccountManager")
  companiesApproved  Company[]        @relation("CompanyApprovedBy")
  companiesReviewed  Company[]        @relation("CompanyLastReviewedBy")
  companiesRejected  Company[]        @relation("CompanyRejectedBy")
  invoicesCreated    Invoice[]        @relation("InvoicesCreated")
  sentNotifications  Notification[]   @relation("NotificationSender")
  notifications      Notification[]   @relation("UserNotifications")
  paymentsProcessed  Payment[]        @relation("PaymentsProcessed")

  @@index([email])
  @@index([role])
  @@index([communityId])
  @@index([userType])
  @@index([ownedCompanyId])
  @@index([memberCompanyId])
}

model Comunidad {
  id          String    @id @default(cuid())
  nombre      String
  descripcion String?
  activa      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  anuncios    Anuncio[]
  usuarios    User[]

  @@index([activa])
}

model Anuncio {
  id                   String                @id @default(cuid())
  title                String
  content              String
  summary              String?
  type                 AnuncioType
  priority             Int                   @default(5)
  status               AnuncioStatus         @default(DRAFT)
  audience             AudienceType
  targetCommunities    String[]
  targetRoles          String[]
  publishAt            DateTime?
  expiresAt            DateTime?
  sendNotification     Boolean               @default(false)
  notificationChannels NotificationChannel[]
  imageUrl             String?
  attachmentUrl        String?
  externalUrl          String?
  tags                 String[]
  isSticky             Boolean               @default(false)
  allowComments        Boolean               @default(true)
  slug                 String?
  views                Int                   @default(0)
  reactions            Int                   @default(0)
  commentsCount        Int                   @default(0)
  sharesCount          Int                   @default(0)
  communityId          String?
  authorId             String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  author               User                  @relation("AnunciosCreados", fields: [authorId], references: [id])
  community            Comunidad?            @relation(fields: [communityId], references: [id], onDelete: Cascade)
  comments             AnuncioComment[]
  metrics              AnuncioMetrics?

  @@index([communityId, status, publishAt])
  @@index([type, audience])
  @@index([authorId])
  @@index([deletedAt])
  @@index([slug])
  @@index([publishAt, expiresAt])
}

model AnuncioComment {
  id               String           @id @default(cuid())
  content          String
  isPrivate        Boolean          @default(false)
  attachmentUrl    String?
  parentId         String?
  anuncioId        String
  authorId         String
  status           CommentStatus    @default(PENDING)
  moderatedBy      String?
  moderatedAt      DateTime?
  moderationReason String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  anuncio          Anuncio          @relation(fields: [anuncioId], references: [id], onDelete: Cascade)
  author           User             @relation("ComentariosCreados", fields: [authorId], references: [id])
  parent           AnuncioComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies          AnuncioComment[] @relation("CommentReplies")

  @@index([anuncioId, status])
  @@index([authorId])
  @@index([parentId])
}

model AnuncioMetrics {
  id                String    @id @default(cuid())
  anuncioId         String    @unique
  views             Int       @default(0)
  clicks            Int       @default(0)
  reactions         Int       @default(0)
  comments          Int       @default(0)
  shares            Int       @default(0)
  emailOpens        Int       @default(0)
  emailClicks       Int       @default(0)
  pushOpens         Int       @default(0)
  engagementRate    Float     @default(0)
  lastViewedAt      DateTime?
  lastInteractionAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  anuncio           Anuncio   @relation(fields: [anuncioId], references: [id], onDelete: Cascade)

  @@index([engagementRate])
  @@index([lastViewedAt])
}

model Company {
  id               String                 @id @default(cuid())
  name             String
  cif              String                 @unique
  email            String
  phone            String?
  address          String?
  logo             String?
  description      String?
  website          String?
  currentPlanId    String?
  accountManagerId String?
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  approvedAt       DateTime?
  approvedById     String?
  lastReviewedAt   DateTime?
  lastReviewedById String?
  rejectedAt       DateTime?
  rejectedById     String?
  rejectionReason  String?
  status           CompanyStatus          @default(PENDING)
  teamMembers      User[]                 @relation("CompanyMembers")
  owner            User?                  @relation("CompanyOwner")
  budgets          Budget[]
  offers           Offer[]
  accountManager   User?                  @relation("AccountManager", fields: [accountManagerId], references: [id])
  approvedBy       User?                  @relation("CompanyApprovedBy", fields: [approvedById], references: [id])
  currentPlan      PlanConfig?            @relation("CompanyCurrentPlan", fields: [currentPlanId], references: [id])
  lastReviewedBy   User?                  @relation("CompanyLastReviewedBy", fields: [lastReviewedById], references: [id])
  rejectedBy       User?                  @relation("CompanyRejectedBy", fields: [rejectedById], references: [id])
  profileChanges   CompanyProfileChange[]
  invoices         Invoice[]
  subscriptions    Subscription[]

  @@index([cif])
  @@index([currentPlanId])
  @@index([accountManagerId])
  @@index([status])
  @@index([createdAt])
  @@map("companies")
}

model PlanConfig {
  id                String         @id @default(cuid())
  planType          String         @unique
  nombre            String
  nombreCorto       String
  descripcion       String
  precioMensual     Float
  precioAnual       Float?
  limitesJSON       String
  caracteristicas   String
  color             String
  icono             String
  orden             Int            @default(0)
  destacado         Boolean        @default(false)
  activo            Boolean        @default(true)
  visible           Boolean        @default(true)
  esSistema         Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  displayNote       String?        @default("IVA incluido")
  priceIncludesVAT  Boolean        @default(true)
  badge             String?
  badgeColor        String?
  basePrice         Float
  description       String?
  durationMonths    Int            @default(12)
  features          Json
  firstYearDiscount Float          @default(0)
  hasFreeTrial      Boolean        @default(false)
  isActive          Boolean        @default(true)
  isDefault         Boolean        @default(false)
  isPioneer         Boolean        @default(false)
  isVisible         Boolean        @default(true)
  maxActiveOffers   Int?
  maxFeaturedOffers Int            @default(0)
  maxStorage        Int?
  maxTeamMembers    Int            @default(1)
  name              String
  nameEn            String?
  nameEs            String?
  priority          Int            @default(0)
  slug              String         @unique
  tier              PlanTier
  trialDurationDays Int?
  funcionalidades   String?
  budgetItems       BudgetItem[]
  companies         Company[]      @relation("CompanyCurrentPlan")
  invoiceItems      InvoiceItem[]
  subscriptions     Subscription[] @relation("SubscriptionPlan")

  @@index([tier])
  @@index([slug])
  @@index([planType])
  @@index([activo, visible])
  @@index([priority])
  @@index([orden])
  @@map("plan_configs")
}

model Subscription {
  id            String             @id @default(cuid())
  companyId     String
  planId        String
  status        SubscriptionStatus @default(ACTIVE)
  precioMensual Float
  precioAnual   Float?
  limites       Json
  startDate     DateTime           @default(now())
  endDate       DateTime?
  cancelledAt   DateTime?
  isAutoRenew   Boolean            @default(true)
  extras        Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  invoices      Invoice[]
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan          PlanConfig         @relation("SubscriptionPlan", fields: [planId], references: [id])

  @@index([companyId])
  @@index([planId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

model Invoice {
  id               String        @id @default(cuid())
  invoiceNumber    String        @unique
  invoiceSeries    String        @default("A")
  companyId        String
  subscriptionId   String?
  status           InvoiceStatus @default(DRAFT)
  issueDate        DateTime      @default(now())
  dueDate          DateTime
  paidDate         DateTime?
  periodStart      DateTime?
  periodEnd        DateTime?
  issuerName       String        @default("La Pública Servicios Digitales S.L.")
  issuerCif        String        @default("B12345678")
  issuerAddress    String        @default("Calle Ejemplo 123, 08001 Barcelona")
  issuerEmail      String        @default("facturacion@lapublica.es")
  issuerPhone      String?       @default("933123456")
  clientName       String
  clientCif        String
  clientEmail      String
  clientAddress    String
  clientPhone      String?
  clientCity       String?
  clientPostalCode String?
  clientCountry    String        @default("España")
  concept          String
  notes            String?
  subtotalAmount   Int
  taxAmount        Int
  totalAmount      Int
  taxRate          Float         @default(21.0)
  taxType          String        @default("IVA")
  discountPercent  Float?
  discountAmount   Int?
  paidAmount       Int           @default(0)
  pendingAmount    Int
  legalText        String        @default("Esta factura se emite conforme a la Ley 37/1992 del IVA y RD 1619/2012 de facturas")
  retentionPercent Float?
  retentionAmount  Int?
  pdfUrl           String?
  xmlUrl           String?
  createdById      String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  invoiceType      InvoiceType   @default(REGULAR)
  pricesIncludeVAT Boolean       @default(true)
  budgets          Budget?
  items            InvoiceItem[]
  company          Company       @relation(fields: [companyId], references: [id])
  createdBy        User?         @relation("InvoicesCreated", fields: [createdById], references: [id])
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])
  payments         Payment[]

  @@index([companyId, status])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@index([issueDate])
  @@index([clientCif])
  @@map("invoices")
}

model InvoiceItem {
  id              String          @id @default(cuid())
  invoiceId       String
  description     String
  concept         String?
  quantity        Float           @default(1.0)
  unitPrice       Int
  discountPercent Float?
  discountAmount  Int?
  subtotalAmount  Int
  taxRate         Float           @default(21.0)
  taxAmount       Int
  totalAmount     Int
  order           Int             @default(0)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  extraId         String?
  isProrated      Boolean         @default(false)
  itemType        InvoiceItemType @default(CUSTOM)
  planId          String?
  proratedDays    Int?
  extra           Extra?          @relation(fields: [extraId], references: [id])
  invoice         Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  plan            PlanConfig?     @relation(fields: [planId], references: [id])

  @@index([invoiceId])
  @@index([order])
  @@map("invoice_items")
}

model Payment {
  id              String        @id @default(cuid())
  invoiceId       String
  paymentNumber   String        @unique
  reference       String?
  externalId      String?
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Int
  feeAmount       Int?
  netAmount       Int
  paymentDate     DateTime      @default(now())
  processedDate   DateTime?
  settledDate     DateTime?
  paymentDetails  Json?
  description     String?
  notes           String?
  processedById   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  stripePaymentId String?       @unique
  stripeSessionId String?       @unique
  invoice         Invoice       @relation(fields: [invoiceId], references: [id])
  processedBy     User?         @relation("PaymentsProcessed", fields: [processedById], references: [id])

  @@index([invoiceId])
  @@index([paymentNumber])
  @@index([method])
  @@index([status])
  @@index([paymentDate])
  @@map("payments")
}

model Extra {
  id               String        @id @default(cuid())
  name             String
  slug             String        @unique
  description      String
  category         ExtraCategory
  basePrice        Decimal       @db.Decimal(10, 2)
  priceType        PriceType
  active           Boolean       @default(true)
  featured         Boolean       @default(false)
  requiresApproval Boolean       @default(false)
  icon             String?
  image            String?
  details          Json?
  order            Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  displayNote      String?       @default("IVA incluido")
  priceIncludesVAT Boolean       @default(true)
  budgetItems      BudgetItem[]
  invoiceItems     InvoiceItem[]

  @@index([category])
  @@index([active])
  @@index([slug])
  @@map("extras")
}

model Budget {
  id             String       @id @default(cuid())
  budgetNumber   String       @unique
  companyId      String
  issueDate      DateTime     @default(now())
  validUntil     DateTime
  approvedAt     DateTime?
  rejectedAt     DateTime?
  status         BudgetStatus @default(DRAFT)
  subtotal       Decimal      @db.Decimal(10, 2)
  taxRate        Decimal      @default(21.00) @db.Decimal(5, 2)
  taxAmount      Decimal      @db.Decimal(10, 2)
  discountAmount Decimal?     @db.Decimal(10, 2)
  total          Decimal      @db.Decimal(10, 2)
  clientName     String
  clientEmail    String
  clientPhone    String?
  clientNIF      String?
  invoiceId      String?      @unique
  notes          String?
  internalNotes  String?
  terms          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  createdBy      String?
  items          BudgetItem[]
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice        Invoice?     @relation(fields: [invoiceId], references: [id])

  @@index([companyId])
  @@index([status])
  @@index([budgetNumber])
  @@map("budgets")
}

model BudgetItem {
  id              String         @id @default(cuid())
  budgetId        String
  order           Int            @default(0)
  itemType        BudgetItemType
  planId          String?
  extraId         String?
  description     String
  quantity        Decimal        @default(1) @db.Decimal(10, 2)
  unitPrice       Decimal        @db.Decimal(10, 2)
  discountPercent Decimal?       @db.Decimal(5, 2)
  subtotal        Decimal        @db.Decimal(10, 2)
  billingCycle    BillingCycle?
  createdAt       DateTime       @default(now())
  budget          Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  extra           Extra?         @relation(fields: [extraId], references: [id])
  plan            PlanConfig?    @relation(fields: [planId], references: [id])

  @@index([budgetId])
  @@map("budget_items")
}

model Notification {
  id        String               @id @default(cuid())
  title     String
  message   String
  type      NotificationType
  priority  NotificationPriority @default(NORMAL)
  isRead    Boolean              @default(false)
  userId    String
  senderId  String?
  companyId String?
  metadata  Json?
  createdAt DateTime             @default(now())
  readAt    DateTime?
  sender    User?                @relation("NotificationSender", fields: [senderId], references: [id])
  user      User                 @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([type, priority])
  @@index([createdAt])
  @@map("notifications")
}

model CompanyProfileChange {
  id              String              @id @default(cuid())
  companyId       String
  type            ProfileChangeType
  status          ProfileChangeStatus @default(PENDING)
  oldValue        Json?
  newValue        Json?
  description     String?
  requestedById   String
  approvedById    String?
  rejectedById    String?
  rejectionReason String?
  createdAt       DateTime            @default(now())
  reviewedAt      DateTime?
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([type, status])
  @@index([createdAt])
  @@map("company_profile_changes")
}

model OfferCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String? // Emoji o nombre de icono Lucide
  color       String? // Color hex para UI
  isActive    Boolean  @default(true)
  offers      Offer[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
}

model Offer {
  id               String        @id @default(cuid())
  title            String
  slug             String        @unique
  shortDescription String?
  description      String
  images           String[]      @default([])
  price            Decimal?      @db.Decimal(10, 2)
  originalPrice    Decimal?      @db.Decimal(10, 2)
  currency         String        @default("EUR")
  priceType        PriceType     @default(FIXED)
  companyId        String
  categoryId       String
  status           OfferStatus   @default(DRAFT)
  publishedAt      DateTime?
  expiresAt        DateTime?
  priority         Int           @default(0)
  featured         Boolean       @default(false)
  featuredUntil    DateTime?
  contactMethod    ContactMethod @default(EMAIL)
  contactEmail     String?
  contactPhone     String?
  contactForm      String?
  externalUrl      String?
  requirements     String?
  benefits         String?
  duration         String?
  location         String?
  remote           Boolean       @default(false)
  tags             String[]      @default([])
  views            Int           @default(0)
  clicks           Int           @default(0)
  applications     Int           @default(0)
  shares           Int           @default(0)
  lastViewedAt     DateTime?
  seoTitle         String?
  seoDescription   String?
  seoKeywords      String[]      @default([])
  internalNotes    String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  company          Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category         OfferCategory @relation(fields: [categoryId], references: [id])

  @@index([companyId, status])
  @@index([categoryId, status])
  @@index([status, publishedAt])
  @@index([featured, featuredUntil])
  @@index([slug])
  @@index([priority])
  @@index([expiresAt])
  @@index([createdAt])
}

enum UserRole {
  USER
  MODERATOR
  COMMUNITY_MANAGER
  ADMIN
  SUPER_ADMIN
  COMPANY
}

enum AnuncioType {
  GENERAL
  URGENT
  EVENT
  MAINTENANCE
  NEWS
  ALERT
  PROMOTION
  REGULATION
}

enum AnuncioStatus {
  DRAFT
  PENDING
  PUBLISHED
  ARCHIVED
  EXPIRED
}

enum AudienceType {
  ALL
  EMPLOYEES
  COMPANIES
  SPECIFIC
  COMMUNITY
}

enum NotificationChannel {
  PLATFORM
  EMAIL
  SMS
  PUSH
  ALL_CHANNELS
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

enum UserType {
  EMPLOYEE
  COMPANY_OWNER
  COMPANY_MEMBER
  ACCOUNT_MANAGER
  ADMIN
}

enum CompanyRole {
  OWNER
  MEMBER
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  CASH
  CHECK
  SEPA_DIRECT_DEBIT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum ExtraCategory {
  WEB_MAINTENANCE
  BRANDING
  MARKETING
  SEO
  CONTENT
  CONSULTING
  TRAINING
  DEVELOPMENT
  SUPPORT
  OTHER
}

enum PriceType {
  FIXED
  MONTHLY
  ANNUAL
  HOURLY
  CUSTOM
}

enum BudgetStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
  INVOICED
}

enum BudgetItemType {
  PLAN
  EXTRA
  CUSTOM
  DISCOUNT
}

enum BillingCycle {
  MONTHLY
  ANNUAL
  ONE_TIME
}

enum InvoiceItemType {
  PLAN
  EXTRA
  UPGRADE
  PRORATED
  DISCOUNT
  CUSTOM
}

enum InvoiceType {
  REGULAR
  PROFORMA
  RECURRING
  UPGRADE
  ADJUSTMENT
  REFUND
}

enum CompanyStatus {
  PENDING
  PUBLISHED
  REJECTED
  SUSPENDED
  INACTIVE
}

enum NotificationType {
  COMPANY_PENDING
  COMPANY_APPROVED
  COMPANY_REJECTED
  PROFILE_CHANGE
  GENERAL
  SYSTEM
}

enum ProfileChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProfileChangeType {
  COMPANY_DATA
  CONTACT_INFO
  LOGO
  DESCRIPTION
  OTHER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum PlanTier {
  PIONERES
  STANDARD
  STRATEGIC
  ENTERPRISE
  CUSTOM
}

enum OfferStatus {
  DRAFT
  PUBLISHED
  PAUSED
  EXPIRED
  ARCHIVED
}

enum ContactMethod {
  EMAIL
  PHONE
  FORM
  EXTERNAL
  WHATSAPP
}
