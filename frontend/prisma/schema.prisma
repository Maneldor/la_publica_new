generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String           @id @default(cuid())
  email              String           @unique
  name               String?
  image              String?
  role               UserRole         @default(USER)
  communityId        String?
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  userType           UserType         @default(EMPLOYEE)
  ownedCompanyId     String?          @unique
  memberCompanyId    String?
  companyRole        CompanyRole?
  cargo              String?
  password           String?
  anunciosCreados    Anuncio[]        @relation("AnunciosCreados")
  comentariosCreados AnuncioComment[] @relation("ComentariosCreados")
  community          Comunidad?       @relation(fields: [communityId], references: [id])
  memberCompany      Company?         @relation("CompanyMembers", fields: [memberCompanyId], references: [id])
  ownedCompany       Company?         @relation("CompanyOwner", fields: [ownedCompanyId], references: [id])
  managedCompanies   Company[]        @relation("AccountManager")
  companiesApproved  Company[]        @relation("CompanyApprovedBy")
  companiesReviewed  Company[]        @relation("CompanyLastReviewedBy")
  companiesRejected  Company[]        @relation("CompanyRejectedBy")
  invoicesCreated    Invoice[]        @relation("InvoicesCreated")
  sentNotifications  Notification[]   @relation("NotificationSender")
  notifications      Notification[]   @relation("UserNotifications")
  paymentsProcessed  Payment[]        @relation("PaymentsProcessed")
  offersApproved     Offer[]          @relation("OfferApprovals")
  offersRejected     Offer[]          @relation("OfferRejections")
  favorites          UserFavorite[]   @relation("UserFavorites")
  coupons            Coupon[]         @relation("UserCoupons")
  redemptions        Redemption[]     @relation("UserRedemptions")
  offerEvents        OfferEvent[]     @relation("UserOfferEvents")
  notificationPreference NotificationPreference? @relation("UserNotificationPreferences")
  emailLogs          EmailLog[]       @relation("UserEmailLogs")
  auditLogs          AuditLog[]       @relation("UserAuditLogs")

  @@index([email])
  @@index([role])
  @@index([communityId])
  @@index([userType])
  @@index([ownedCompanyId])
  @@index([memberCompanyId])
}

model Comunidad {
  id          String    @id @default(cuid())
  nombre      String
  descripcion String?
  activa      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  anuncios    Anuncio[]
  usuarios    User[]

  @@index([activa])
}

model Anuncio {
  id                   String                @id @default(cuid())
  title                String
  content              String
  summary              String?
  type                 AnuncioType
  priority             Int                   @default(5)
  status               AnuncioStatus         @default(DRAFT)
  audience             AudienceType
  targetCommunities    String[]
  targetRoles          String[]
  publishAt            DateTime?
  expiresAt            DateTime?
  sendNotification     Boolean               @default(false)
  notificationChannels NotificationChannel[]
  imageUrl             String?
  attachmentUrl        String?
  externalUrl          String?
  tags                 String[]
  isSticky             Boolean               @default(false)
  allowComments        Boolean               @default(true)
  slug                 String?
  views                Int                   @default(0)
  reactions            Int                   @default(0)
  commentsCount        Int                   @default(0)
  sharesCount          Int                   @default(0)
  communityId          String?
  authorId             String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  author               User                  @relation("AnunciosCreados", fields: [authorId], references: [id])
  community            Comunidad?            @relation(fields: [communityId], references: [id], onDelete: Cascade)
  comments             AnuncioComment[]
  metrics              AnuncioMetrics?

  @@index([communityId, status, publishAt])
  @@index([type, audience])
  @@index([authorId])
  @@index([deletedAt])
  @@index([slug])
  @@index([publishAt, expiresAt])
}

model AnuncioComment {
  id               String           @id @default(cuid())
  content          String
  isPrivate        Boolean          @default(false)
  attachmentUrl    String?
  parentId         String?
  anuncioId        String
  authorId         String
  status           CommentStatus    @default(PENDING)
  moderatedBy      String?
  moderatedAt      DateTime?
  moderationReason String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  anuncio          Anuncio          @relation(fields: [anuncioId], references: [id], onDelete: Cascade)
  author           User             @relation("ComentariosCreados", fields: [authorId], references: [id])
  parent           AnuncioComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies          AnuncioComment[] @relation("CommentReplies")

  @@index([anuncioId, status])
  @@index([authorId])
  @@index([parentId])
}

model AnuncioMetrics {
  id                String    @id @default(cuid())
  anuncioId         String    @unique
  views             Int       @default(0)
  clicks            Int       @default(0)
  reactions         Int       @default(0)
  comments          Int       @default(0)
  shares            Int       @default(0)
  emailOpens        Int       @default(0)
  emailClicks       Int       @default(0)
  pushOpens         Int       @default(0)
  engagementRate    Float     @default(0)
  lastViewedAt      DateTime?
  lastInteractionAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  anuncio           Anuncio   @relation(fields: [anuncioId], references: [id], onDelete: Cascade)

  @@index([engagementRate])
  @@index([lastViewedAt])
}

model Company {
  id               String                 @id @default(cuid())
  name             String
  cif              String                 @unique
  email            String
  phone            String?
  address          String?
  logo             String?
  description      String?
  website          String?
  currentPlanId    String?
  accountManagerId String?
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  approvedAt       DateTime?
  approvedById     String?
  lastReviewedAt   DateTime?
  lastReviewedById String?
  rejectedAt       DateTime?
  rejectedById     String?
  rejectionReason  String?
  status           CompanyStatus          @default(PENDING)
  teamMembers      User[]                 @relation("CompanyMembers")
  owner            User?                  @relation("CompanyOwner")
  budgets          Budget[]
  offers           Offer[]
  accountManager   User?                  @relation("AccountManager", fields: [accountManagerId], references: [id])
  approvedBy       User?                  @relation("CompanyApprovedBy", fields: [approvedById], references: [id])
  currentPlan      PlanConfig?            @relation("CompanyCurrentPlan", fields: [currentPlanId], references: [id])
  lastReviewedBy   User?                  @relation("CompanyLastReviewedBy", fields: [lastReviewedById], references: [id])
  rejectedBy       User?                  @relation("CompanyRejectedBy", fields: [rejectedById], references: [id])
  profileChanges   CompanyProfileChange[]
  invoices         Invoice[]
  subscriptions    Subscription[]
  coupons          Coupon[]               @relation("CompanyCoupons")
  redemptions      Redemption[]           @relation("CompanyRedemptions")
  offerEvents      OfferEvent[]           @relation("CompanyOfferEvents")

  @@index([cif])
  @@index([currentPlanId])
  @@index([accountManagerId])
  @@index([status])
  @@index([createdAt])
  @@map("companies")
}

model PlanConfig {
  id                String         @id @default(cuid())
  planType          String         @unique
  nombre            String
  nombreCorto       String
  descripcion       String
  precioMensual     Float
  precioAnual       Float?
  limitesJSON       String
  caracteristicas   String
  color             String
  icono             String
  orden             Int            @default(0)
  destacado         Boolean        @default(false)
  activo            Boolean        @default(true)
  visible           Boolean        @default(true)
  esSistema         Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  displayNote       String?        @default("IVA incluido")
  priceIncludesVAT  Boolean        @default(true)
  badge             String?
  badgeColor        String?
  basePrice         Float
  description       String?
  durationMonths    Int            @default(12)
  features          Json
  firstYearDiscount Float          @default(0)
  hasFreeTrial      Boolean        @default(false)
  isActive          Boolean        @default(true)
  isDefault         Boolean        @default(false)
  isPioneer         Boolean        @default(false)
  isVisible         Boolean        @default(true)
  maxActiveOffers   Int?
  maxFeaturedOffers Int            @default(0)
  maxStorage        Int?
  maxTeamMembers    Int            @default(1)
  name              String
  nameEn            String?
  nameEs            String?
  priority          Int            @default(0)
  slug              String         @unique
  tier              PlanTier
  trialDurationDays Int?
  funcionalidades   String?
  budgetItems       BudgetItem[]
  companies         Company[]      @relation("CompanyCurrentPlan")
  invoiceItems      InvoiceItem[]
  subscriptions     Subscription[] @relation("SubscriptionPlan")

  @@index([tier])
  @@index([slug])
  @@index([planType])
  @@index([activo, visible])
  @@index([priority])
  @@index([orden])
  @@map("plan_configs")
}

model Subscription {
  id            String             @id @default(cuid())
  companyId     String
  planId        String
  status        SubscriptionStatus @default(ACTIVE)
  precioMensual Float
  precioAnual   Float?
  limites       Json
  startDate     DateTime           @default(now())
  endDate       DateTime?
  cancelledAt   DateTime?
  isAutoRenew   Boolean            @default(true)
  extras        Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  invoices      Invoice[]
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan          PlanConfig         @relation("SubscriptionPlan", fields: [planId], references: [id])

  @@index([companyId])
  @@index([planId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

model Invoice {
  id               String        @id @default(cuid())
  invoiceNumber    String        @unique
  invoiceSeries    String        @default("A")
  companyId        String
  subscriptionId   String?
  status           InvoiceStatus @default(DRAFT)
  issueDate        DateTime      @default(now())
  dueDate          DateTime
  paidDate         DateTime?
  periodStart      DateTime?
  periodEnd        DateTime?
  issuerName       String        @default("La Pública Servicios Digitales S.L.")
  issuerCif        String        @default("B12345678")
  issuerAddress    String        @default("Calle Ejemplo 123, 08001 Barcelona")
  issuerEmail      String        @default("facturacion@lapublica.es")
  issuerPhone      String?       @default("933123456")
  clientName       String
  clientCif        String
  clientEmail      String
  clientAddress    String
  clientPhone      String?
  clientCity       String?
  clientPostalCode String?
  clientCountry    String        @default("España")
  concept          String
  notes            String?
  subtotalAmount   Int
  taxAmount        Int
  totalAmount      Int
  taxRate          Float         @default(21.0)
  taxType          String        @default("IVA")
  discountPercent  Float?
  discountAmount   Int?
  paidAmount       Int           @default(0)
  pendingAmount    Int
  legalText        String        @default("Esta factura se emite conforme a la Ley 37/1992 del IVA y RD 1619/2012 de facturas")
  retentionPercent Float?
  retentionAmount  Int?
  pdfUrl           String?
  xmlUrl           String?
  createdById      String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  invoiceType      InvoiceType   @default(REGULAR)
  pricesIncludeVAT Boolean       @default(true)
  budgets          Budget?
  items            InvoiceItem[]
  company          Company       @relation(fields: [companyId], references: [id])
  createdBy        User?         @relation("InvoicesCreated", fields: [createdById], references: [id])
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])
  payments         Payment[]

  @@index([companyId, status])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@index([issueDate])
  @@index([clientCif])
  @@map("invoices")
}

model InvoiceItem {
  id              String          @id @default(cuid())
  invoiceId       String
  description     String
  concept         String?
  quantity        Float           @default(1.0)
  unitPrice       Int
  discountPercent Float?
  discountAmount  Int?
  subtotalAmount  Int
  taxRate         Float           @default(21.0)
  taxAmount       Int
  totalAmount     Int
  order           Int             @default(0)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  extraId         String?
  isProrated      Boolean         @default(false)
  itemType        InvoiceItemType @default(CUSTOM)
  planId          String?
  proratedDays    Int?
  extra           Extra?          @relation(fields: [extraId], references: [id])
  invoice         Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  plan            PlanConfig?     @relation(fields: [planId], references: [id])

  @@index([invoiceId])
  @@index([order])
  @@map("invoice_items")
}

model Payment {
  id              String        @id @default(cuid())
  invoiceId       String
  paymentNumber   String        @unique
  reference       String?
  externalId      String?
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Int
  feeAmount       Int?
  netAmount       Int
  paymentDate     DateTime      @default(now())
  processedDate   DateTime?
  settledDate     DateTime?
  paymentDetails  Json?
  description     String?
  notes           String?
  processedById   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  stripePaymentId String?       @unique
  stripeSessionId String?       @unique
  invoice         Invoice       @relation(fields: [invoiceId], references: [id])
  processedBy     User?         @relation("PaymentsProcessed", fields: [processedById], references: [id])

  @@index([invoiceId])
  @@index([paymentNumber])
  @@index([method])
  @@index([status])
  @@index([paymentDate])
  @@map("payments")
}

model Extra {
  id               String        @id @default(cuid())
  name             String
  slug             String        @unique
  description      String
  category         ExtraCategory
  basePrice        Decimal       @db.Decimal(10, 2)
  priceType        PriceType
  active           Boolean       @default(true)
  featured         Boolean       @default(false)
  requiresApproval Boolean       @default(false)
  icon             String?
  image            String?
  details          Json?
  order            Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  displayNote      String?       @default("IVA incluido")
  priceIncludesVAT Boolean       @default(true)
  budgetItems      BudgetItem[]
  invoiceItems     InvoiceItem[]

  @@index([category])
  @@index([active])
  @@index([slug])
  @@map("extras")
}

model Budget {
  id             String       @id @default(cuid())
  budgetNumber   String       @unique
  companyId      String
  issueDate      DateTime     @default(now())
  validUntil     DateTime
  approvedAt     DateTime?
  rejectedAt     DateTime?
  status         BudgetStatus @default(DRAFT)
  subtotal       Decimal      @db.Decimal(10, 2)
  taxRate        Decimal      @default(21.00) @db.Decimal(5, 2)
  taxAmount      Decimal      @db.Decimal(10, 2)
  discountAmount Decimal?     @db.Decimal(10, 2)
  total          Decimal      @db.Decimal(10, 2)
  clientName     String
  clientEmail    String
  clientPhone    String?
  clientNIF      String?
  invoiceId      String?      @unique
  notes          String?
  internalNotes  String?
  terms          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  createdBy      String?
  items          BudgetItem[]
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice        Invoice?     @relation(fields: [invoiceId], references: [id])

  @@index([companyId])
  @@index([status])
  @@index([budgetNumber])
  @@map("budgets")
}

model BudgetItem {
  id              String         @id @default(cuid())
  budgetId        String
  order           Int            @default(0)
  itemType        BudgetItemType
  planId          String?
  extraId         String?
  description     String
  quantity        Decimal        @default(1) @db.Decimal(10, 2)
  unitPrice       Decimal        @db.Decimal(10, 2)
  discountPercent Decimal?       @db.Decimal(5, 2)
  subtotal        Decimal        @db.Decimal(10, 2)
  billingCycle    BillingCycle?
  createdAt       DateTime       @default(now())
  budget          Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  extra           Extra?         @relation(fields: [extraId], references: [id])
  plan            PlanConfig?    @relation(fields: [planId], references: [id])

  @@index([budgetId])
  @@map("budget_items")
}

model Notification {
  id        String               @id @default(cuid())
  title     String
  message   String
  type      NotificationType
  priority  NotificationPriority @default(NORMAL)
  isRead    Boolean              @default(false)
  userId    String
  senderId  String?
  companyId String?
  metadata  Json?
  createdAt DateTime             @default(now())
  readAt    DateTime?
  sender    User?                @relation("NotificationSender", fields: [senderId], references: [id])
  user      User                 @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([type, priority])
  @@index([createdAt])
  @@map("notifications")
}

model CompanyProfileChange {
  id              String              @id @default(cuid())
  companyId       String
  type            ProfileChangeType
  status          ProfileChangeStatus @default(PENDING)
  oldValue        Json?
  newValue        Json?
  description     String?
  requestedById   String
  approvedById    String?
  rejectedById    String?
  rejectionReason String?
  createdAt       DateTime            @default(now())
  reviewedAt      DateTime?
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([type, status])
  @@index([createdAt])
  @@map("company_profile_changes")
}

model OfferCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String? // Emoji o nombre de icono Lucide
  color       String? // Color hex para UI
  isActive    Boolean  @default(true)
  offers      Offer[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
}

model Offer {
  id               String      @id @default(cuid())
  title            String
  slug             String      @unique
  shortDescription String?
  description      String
  images           String[]    @default([])
  price            Decimal?    @db.Decimal(10, 2)
  originalPrice    Decimal?    @db.Decimal(10, 2)
  currency         String      @default("EUR")
  priceType        PriceType   @default(FIXED)
  companyId        String
  categoryId       String
  status           OfferStatus @default(DRAFT)
  publishedAt      DateTime?
  expiresAt        DateTime?

  // Campos de aprobación
  approvedAt     DateTime?
  approvedBy     String? // userId del admin que aprobó
  approvedByUser User?         @relation("OfferApprovals", fields: [approvedBy], references: [id])
  rejectedAt     DateTime?
  rejectedBy     String? // userId del admin que rechazó
  rejectedByUser User?         @relation("OfferRejections", fields: [rejectedBy], references: [id])
  rejectedReason String? // Motivo del rechazo
  submittedAt    DateTime? // Fecha envío para aprobación
  priority       Int           @default(0)
  featured       Boolean       @default(false)
  featuredUntil  DateTime?
  contactMethod  ContactMethod @default(EMAIL)
  contactEmail   String?
  contactPhone   String?
  contactForm    String?
  externalUrl    String?
  requirements   String?
  benefits       String?
  duration       String?
  location       String?
  remote         Boolean       @default(false)
  tags           String[]      @default([])
  views          Int           @default(0)
  clicks         Int           @default(0)
  applications   Int           @default(0)
  shares         Int           @default(0)
  lastViewedAt   DateTime?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[]      @default([])
  internalNotes  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  company        Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category       OfferCategory @relation(fields: [categoryId], references: [id])
  favorites      UserFavorite[] @relation("OfferFavorites")
  coupons        Coupon[]      @relation("OfferCoupons")
  redemptions    Redemption[]  @relation("OfferRedemptions")
  events         OfferEvent[]  @relation("OfferEvents")

  @@index([companyId, status])
  @@index([categoryId, status])
  @@index([status, publishedAt])
  @@index([featured, featuredUntil])
  @@index([slug])
  @@index([priority])
  @@index([expiresAt])
  @@index([createdAt])
}

enum UserRole {
  USER
  MODERATOR
  COMMUNITY_MANAGER
  ADMIN
  SUPER_ADMIN
  COMPANY
}

enum AnuncioType {
  GENERAL
  URGENT
  EVENT
  MAINTENANCE
  NEWS
  ALERT
  PROMOTION
  REGULATION
}

enum AnuncioStatus {
  DRAFT
  PENDING
  PUBLISHED
  ARCHIVED
  EXPIRED
}

enum AudienceType {
  ALL
  EMPLOYEES
  COMPANIES
  SPECIFIC
  COMMUNITY
}

enum NotificationChannel {
  PLATFORM
  EMAIL
  SMS
  PUSH
  ALL_CHANNELS
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

enum UserType {
  EMPLOYEE
  COMPANY_OWNER
  COMPANY_MEMBER
  ACCOUNT_MANAGER
  ADMIN
}

enum CompanyRole {
  OWNER
  MEMBER
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  CASH
  CHECK
  SEPA_DIRECT_DEBIT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum ExtraCategory {
  WEB_MAINTENANCE
  BRANDING
  MARKETING
  SEO
  CONTENT
  CONSULTING
  TRAINING
  DEVELOPMENT
  SUPPORT
  OTHER
}

enum PriceType {
  FIXED
  MONTHLY
  ANNUAL
  HOURLY
  CUSTOM
}

enum BudgetStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
  INVOICED
}

enum BudgetItemType {
  PLAN
  EXTRA
  CUSTOM
  DISCOUNT
}

enum BillingCycle {
  MONTHLY
  ANNUAL
  ONE_TIME
}

enum InvoiceItemType {
  PLAN
  EXTRA
  UPGRADE
  PRORATED
  DISCOUNT
  CUSTOM
}

enum InvoiceType {
  REGULAR
  PROFORMA
  RECURRING
  UPGRADE
  ADJUSTMENT
  REFUND
}

enum CompanyStatus {
  PENDING
  PUBLISHED
  REJECTED
  SUSPENDED
  INACTIVE
}

enum NotificationType {
  COMPANY_PENDING
  COMPANY_APPROVED
  COMPANY_REJECTED
  PROFILE_CHANGE
  GENERAL
  SYSTEM
  // AÑADIR nuevos tipos para sistema de cupones
  COUPON_GENERATED      // Cupón generado
  COUPON_USED          // Cupón usado
  OFFER_EXPIRING       // Oferta a punto de caducar
  NEW_FAVORITE         // Alguien guardó tu oferta
  WEEKLY_SUMMARY       // Resumen semanal
}

enum ProfileChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProfileChangeType {
  COMPANY_DATA
  CONTACT_INFO
  LOGO
  DESCRIPTION
  OTHER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum PlanTier {
  PIONERES
  STANDARD
  STRATEGIC
  ENTERPRISE
  CUSTOM
}

enum OfferStatus {
  DRAFT // Borrador - empresa está creando
  PENDING // Pendiente revisión - esperando aprobación admin
  PUBLISHED // Publicada - visible para empleados
  REJECTED // Rechazada - admin rechazó
  PAUSED // Pausada - empresa pausó temporalmente
  EXPIRED // Caducada - pasó fecha validUntil
  ARCHIVED // Archivada - empresa la archivó
}

enum ContactMethod {
  EMAIL
  PHONE
  FORM
  EXTERNAL
  WHATSAPP
}

// ============================================
// SISTEMA DE FAVORITOS
// ============================================

model UserFavorite {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  offerId   String
  offer     Offer    @relation("OfferFavorites", fields: [offerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, offerId], name: "unique_user_offer_favorite")
  @@index([userId], name: "idx_favorite_user")
  @@index([offerId], name: "idx_favorite_offer")
  @@index([createdAt], name: "idx_favorite_created")
  @@map("user_favorites")
}

// ============================================
// SISTEMA DE CUPONES
// ============================================

model Coupon {
  id              String        @id @default(cuid())
  code            String        @unique // LAPUB-TECHINNOVA-A3F9X2

  // Relaciones
  offerId         String
  offer           Offer         @relation("OfferCoupons", fields: [offerId], references: [id], onDelete: Cascade)
  userId          String
  user            User          @relation("UserCoupons", fields: [userId], references: [id], onDelete: Cascade)
  companyId       String
  company         Company       @relation("CompanyCoupons", fields: [companyId], references: [id], onDelete: Cascade)

  // QR Code
  qrCodeUrl       String?       // URL del QR generado (Cloudinary/S3)
  qrCodeData      String?       // Data del QR en base64 como backup

  // Estado y validez
  status          CouponStatus  @default(ACTIVE)
  generatedAt     DateTime      @default(now())
  expiresAt       DateTime      // Fecha de caducidad
  usedAt          DateTime?     // Cuando se usó
  cancelledAt     DateTime?     // Si se canceló

  // Tracking y metadata
  redemption      Redemption?   @relation("CouponRedemption")
  userAgent       String?       // Navegador usado
  ipAddress       String?       // IP de generación
  deviceType      String?       // mobile, desktop, tablet
  generatedFrom   String?       // web, app, email

  // Notas
  notes           String?       // Notas internas

  @@index([offerId], name: "idx_coupon_offer")
  @@index([userId], name: "idx_coupon_user")
  @@index([companyId], name: "idx_coupon_company")
  @@index([code], name: "idx_coupon_code")
  @@index([status], name: "idx_coupon_status")
  @@index([expiresAt], name: "idx_coupon_expires")
  @@index([generatedAt], name: "idx_coupon_generated")
  @@map("coupons")
}

enum CouponStatus {
  ACTIVE      // Activo, listo para usar
  USED        // Ya utilizado
  EXPIRED     // Caducado por fecha
  CANCELLED   // Cancelado por empresa o admin
  SUSPENDED   // Suspendido temporalmente
}

model Redemption {
  id              String    @id @default(cuid())

  // Relaciones
  couponId        String    @unique
  coupon          Coupon    @relation("CouponRedemption", fields: [couponId], references: [id], onDelete: Cascade)
  offerId         String
  offer           Offer     @relation("OfferRedemptions", fields: [offerId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation("UserRedemptions", fields: [userId], references: [id], onDelete: Cascade)
  companyId       String
  company         Company   @relation("CompanyRedemptions", fields: [companyId], references: [id], onDelete: Cascade)

  // Detalles de redención
  redeemedAt      DateTime  @default(now())
  redemptionType  String    @default("in_store") // in_store, online, phone, email
  channel         String?   // web, app, pos
  location        String?   // "Barcelona - Passeig de Gràcia 23"
  storeId         String?   // ID tienda física si aplica

  // Información económica
  originalPrice   Decimal?  @db.Decimal(10, 2)
  discountAmount  Decimal?  @db.Decimal(10, 2)
  finalPrice      Decimal?  @db.Decimal(10, 2)
  currency        String    @default("EUR")

  // Validación
  validatedBy     String?   // ID del usuario empresa que validó
  validatedAt     DateTime  @default(now())
  verificationMethod String? // qr_scan, code_entry, automatic

  // Tracking
  userAgent       String?
  ipAddress       String?
  deviceType      String?

  // Notas y detalles
  notes           String?   // Notas de la empresa
  customerNotes   String?   // Notas del cliente
  receiptNumber   String?   // Número de ticket/factura

  // Satisfacción (opcional)
  rating          Int?      // 1-5 estrellas
  feedback        String?   // Comentario del usuario

  @@index([offerId], name: "idx_redemption_offer")
  @@index([userId], name: "idx_redemption_user")
  @@index([companyId], name: "idx_redemption_company")
  @@index([redeemedAt], name: "idx_redemption_date")
  @@index([redemptionType], name: "idx_redemption_type")
  @@map("redemptions")
}

// ============================================
// TRACKING DE EVENTOS
// ============================================

model OfferEvent {
  id          String      @id @default(cuid())

  // Relaciones
  offerId     String
  offer       Offer       @relation("OfferEvents", fields: [offerId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?       @relation("UserOfferEvents", fields: [userId], references: [id], onDelete: SetNull)
  companyId   String
  company     Company     @relation("CompanyOfferEvents", fields: [companyId], references: [id], onDelete: Cascade)

  // Tipo de evento
  eventType   EventType

  // Metadata del evento
  sessionId   String?     // ID de sesión para agrupar eventos
  userAgent   String?
  ipAddress   String?
  deviceType  String?     // mobile, desktop, tablet
  browser     String?     // chrome, firefox, safari
  os          String?     // windows, macos, ios, android
  referrer    String?     // De dónde viene
  utmSource   String?     // Parámetros UTM
  utmMedium   String?
  utmCampaign String?

  // Geolocalización (si disponible)
  country     String?
  city        String?
  region      String?
  latitude    Float?
  longitude   Float?

  // Timing
  duration    Int?        // Segundos en la página
  scrollDepth Int?        // % de scroll

  createdAt   DateTime    @default(now())

  @@index([offerId, eventType], name: "idx_event_offer_type")
  @@index([userId], name: "idx_event_user")
  @@index([companyId], name: "idx_event_company")
  @@index([eventType], name: "idx_event_type")
  @@index([createdAt], name: "idx_event_created")
  @@index([sessionId], name: "idx_event_session")
  @@map("offer_events")
}

enum EventType {
  VIEW              // Usuario vio la oferta
  DETAIL_VIEW       // Entró al detalle completo
  CLICK             // Click en botón o enlace
  SHARE             // Compartió la oferta
  FAVORITE_ADD      // Añadió a favoritos
  FAVORITE_REMOVE   // Quitó de favoritos
  COUPON_VIEW       // Vio el botón de cupón
  COUPON_GENERATED  // Generó un cupón
  COUPON_DOWNLOADED // Descargó el QR
  COUPON_SHARED     // Compartió el cupón
  COUPON_USED       // Usó el cupón
  EXTERNAL_CLICK    // Click en enlace externo
  CONTACT_CLICK     // Click en contactar empresa
  PHONE_CLICK       // Click en teléfono
  EMAIL_CLICK       // Click en email
  MAP_VIEW          // Vio ubicación en mapa
  GALLERY_VIEW      // Vio galería de imágenes
}

// ============================================
// SISTEMA DE NOTIFICACIONES EXPANDIDO
// ============================================

model NotificationPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique

  // Configuración email
  emailEnabled          Boolean  @default(true)
  emailCouponGenerated  Boolean  @default(true)
  emailCouponUsed       Boolean  @default(true)
  emailOfferExpiring    Boolean  @default(true)
  emailNewFavorite      Boolean  @default(true)
  emailWeeklySummary    Boolean  @default(true)

  // Configuración notificaciones in-app
  inAppEnabled          Boolean  @default(true)
  inAppCouponGenerated  Boolean  @default(true)
  inAppCouponUsed       Boolean  @default(true)
  inAppOfferExpiring    Boolean  @default(true)
  inAppNewFavorite      Boolean  @default(true)
  inAppWeeklySummary    Boolean  @default(false)

  // Configuración horarios
  weeklySummaryDay      Int      @default(1) // 0=domingo, 1=lunes, etc.
  weeklySummaryHour     Int      @default(9) // Hora 0-23
  timezone              String   @default("Europe/Madrid")

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation("UserNotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

model EmailLog {
  id            String        @id @default(cuid())
  userId        String
  templateType  EmailTemplate
  subject       String
  toEmail       String
  fromEmail     String        @default("noreply@lapublica.es")
  status        EmailStatus   @default(PENDING)
  sentAt        DateTime?
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  bouncedAt     DateTime?
  errorMessage  String?
  externalId    String?       // ID de Resend
  metadata      Json?         // Datos adicionales (offerId, couponId, etc.)
  createdAt     DateTime      @default(now())

  user          User          @relation("UserEmailLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([templateType])
  @@index([status])
  @@index([sentAt])
  @@index([toEmail])
  @@index([externalId])
  @@map("email_logs")
}

enum EmailTemplate {
  COUPON_GENERATED
  COUPON_USED
  OFFER_EXPIRING
  NEW_FAVORITE
  WEEKLY_SUMMARY
  WELCOME
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

// ============================================
// SISTEMA DE AUDIT LOGS
// ============================================

model AuditLog {
  id          String      @id @default(cuid())

  // Quién realizó la acción
  userId      String
  user        User        @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: Cascade)
  userName    String      // Snapshot del nombre (por si se borra el usuario)
  userEmail   String      // Snapshot del email
  userRole    String      // Snapshot del rol

  // Qué acción se realizó
  action      AuditAction // Tipo de acción
  entity      String      // Entidad afectada (Company, Offer, User, etc.)
  entityId    String?     // ID de la entidad afectada
  entityName  String?     // Nombre/título de la entidad (snapshot)

  // Detalles de la acción
  description String      // Descripción legible
  changes     Json?       // Cambios realizados (before/after)
  metadata    Json?       // Metadata adicional

  // Información de contexto
  ipAddress   String?     // IP desde donde se realizó
  userAgent   String?     // Browser/device info

  // Estado
  severity    LogSeverity @default(INFO)
  success     Boolean     @default(true)
  errorMessage String?    // Si la acción falló

  // Timestamp
  createdAt   DateTime    @default(now())

  // Índices para búsquedas rápidas
  @@index([userId], name: "idx_auditlog_user")
  @@index([action], name: "idx_auditlog_action")
  @@index([entity], name: "idx_auditlog_entity")
  @@index([entityId], name: "idx_auditlog_entity_id")
  @@index([createdAt], name: "idx_auditlog_created")
  @@index([severity], name: "idx_auditlog_severity")

  @@map("audit_logs")
}

enum AuditAction {
  // Empresas
  COMPANY_APPROVED
  COMPANY_REJECTED
  COMPANY_SUSPENDED
  COMPANY_REACTIVATED
  COMPANY_DELETED
  COMPANY_UPDATED

  // Ofertas
  OFFER_APPROVED
  OFFER_REJECTED
  OFFER_DELETED
  OFFER_FEATURED
  OFFER_UNFEATURED
  OFFER_UPDATED

  // Usuarios
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_SUSPENDED
  USER_REACTIVATED
  USER_ROLE_CHANGED

  // Cupones
  COUPON_CANCELLED
  COUPON_BULK_EXPORT

  // Sistema
  SETTINGS_UPDATED
  PLAN_CONFIG_UPDATED
  BULK_ACTION

  // Seguridad
  LOGIN_ADMIN
  LOGOUT_ADMIN
  PERMISSION_CHANGED

  // Otros
  OTHER
}

enum LogSeverity {
  INFO      // Acciones normales
  WARNING   // Acciones que requieren atención
  ERROR     // Acciones que fallaron
  CRITICAL  // Acciones críticas de seguridad
}
