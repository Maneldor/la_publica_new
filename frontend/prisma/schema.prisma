generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  name                   String?
  image                  String?
  role                   UserRole                @default(USER)
  communityId            String?
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  userType               UserType                @default(EMPLOYEE)
  ownedCompanyId         String?                 @unique
  memberCompanyId        String?
  companyRole            CompanyRole?
  cargo                  String?
  password               String?
  anunciosCreados        Anuncio[]               @relation("AnunciosCreados")
  comentariosCreados     AnuncioComment[]        @relation("ComentariosCreados")
  offersApproved         Offer[]                 @relation("OfferApprovals")
  offersRejected         Offer[]                 @relation("OfferRejections")
  community              Comunidad?              @relation(fields: [communityId], references: [id])
  memberCompany          Company?                @relation("CompanyMembers", fields: [memberCompanyId], references: [id])
  ownedCompany           Company?                @relation("CompanyOwner", fields: [ownedCompanyId], references: [id])
  auditLogs              AuditLog[]              @relation("UserAuditLogs")
  managedCompanies       Company[]               @relation("AccountManager")
  companiesApproved      Company[]               @relation("CompanyApprovedBy")
  companiesReviewed      Company[]               @relation("CompanyLastReviewedBy")
  companiesRejected      Company[]               @relation("CompanyRejectedBy")
  coupons                Coupon[]                @relation("UserCoupons")
  emailLogs              EmailLog[]              @relation("UserEmailLogs")
  groupOfferRequests     GroupOfferRequest[]     @relation("GroupOfferRequests")
  groupParticipations    GroupParticipant[]      @relation("UserGroupParticipants")
  invoicesCreated        Invoice[]               @relation("InvoicesCreated")
  leads                  Lead[]
  notificationPreference NotificationPreference? @relation("UserNotificationPreferences")
  sentNotifications      Notification[]          @relation("NotificationSender")
  notifications          Notification[]          @relation("UserNotifications")
  offerEvents            OfferEvent[]            @relation("UserOfferEvents")
  paymentsProcessed      Payment[]               @relation("PaymentsProcessed")
  redemptions            Redemption[]            @relation("UserRedemptions")
  favorites              UserFavorite[]          @relation("UserFavorites")
  wallet                 UserWallet?
  assignedLeads          CompanyLead[]           @relation("LeadAssignee")
  leadInteractions       LeadInteraction[]
  leadActivities         LeadActivity[]
  leadTasks              LeadTask[]
  leadDocuments          LeadDocument[]
  tasksAssigned          Task[]                  @relation("TasksAssigned")
  tasksCreated           Task[]                  @relation("TasksCreated")
  taskComments           TaskComment[]           @relation("TaskComments")
  taskAttachments        TaskAttachment[]        @relation("TaskAttachments")
  taskActivities         TaskActivity[]          @relation("TaskActivities")

  @@index([email])
  @@index([role])
  @@index([communityId])
  @@index([userType])
  @@index([ownedCompanyId])
  @@index([memberCompanyId])
  @@index([isActive])
  @@index([createdAt])
  @@index([isActive, createdAt])
}

model Comunidad {
  id          String    @id @default(cuid())
  nombre      String
  descripcion String?
  activa      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  anuncios    Anuncio[]
  usuarios    User[]

  @@index([activa])
}

model Anuncio {
  id                   String                @id @default(cuid())
  title                String
  content              String
  summary              String?
  type                 AnuncioType
  priority             Int                   @default(5)
  status               AnuncioStatus         @default(DRAFT)
  audience             AudienceType
  targetCommunities    String[]
  targetRoles          String[]
  publishAt            DateTime?
  expiresAt            DateTime?
  sendNotification     Boolean               @default(false)
  notificationChannels NotificationChannel[]
  imageUrl             String?
  attachmentUrl        String?
  externalUrl          String?
  tags                 String[]
  isSticky             Boolean               @default(false)
  allowComments        Boolean               @default(true)
  slug                 String?
  views                Int                   @default(0)
  reactions            Int                   @default(0)
  commentsCount        Int                   @default(0)
  sharesCount          Int                   @default(0)
  communityId          String?
  authorId             String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  author               User                  @relation("AnunciosCreados", fields: [authorId], references: [id])
  community            Comunidad?            @relation(fields: [communityId], references: [id], onDelete: Cascade)
  comments             AnuncioComment[]
  metrics              AnuncioMetrics?

  @@index([communityId, status, publishAt])
  @@index([type, audience])
  @@index([authorId])
  @@index([deletedAt])
  @@index([slug])
  @@index([publishAt, expiresAt])
}

model AnuncioComment {
  id               String           @id @default(cuid())
  content          String
  isPrivate        Boolean          @default(false)
  attachmentUrl    String?
  parentId         String?
  anuncioId        String
  authorId         String
  status           CommentStatus    @default(PENDING)
  moderatedBy      String?
  moderatedAt      DateTime?
  moderationReason String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  anuncio          Anuncio          @relation(fields: [anuncioId], references: [id], onDelete: Cascade)
  author           User             @relation("ComentariosCreados", fields: [authorId], references: [id])
  parent           AnuncioComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies          AnuncioComment[] @relation("CommentReplies")

  @@index([anuncioId, status])
  @@index([authorId])
  @@index([parentId])
}

model AnuncioMetrics {
  id                String    @id @default(cuid())
  anuncioId         String    @unique
  views             Int       @default(0)
  clicks            Int       @default(0)
  reactions         Int       @default(0)
  comments          Int       @default(0)
  shares            Int       @default(0)
  emailOpens        Int       @default(0)
  emailClicks       Int       @default(0)
  pushOpens         Int       @default(0)
  engagementRate    Float     @default(0)
  lastViewedAt      DateTime?
  lastInteractionAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  anuncio           Anuncio   @relation(fields: [anuncioId], references: [id], onDelete: Cascade)

  @@index([engagementRate])
  @@index([lastViewedAt])
}

model Company {
  id               String                 @id @default(cuid())
  name             String
  cif              String                 @unique
  email            String
  phone            String?
  address          String?
  logo             String?
  description      String?
  website          String?
  currentPlanId    String?
  accountManagerId String?
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  approvedAt       DateTime?
  approvedById     String?
  lastReviewedAt   DateTime?
  lastReviewedById String?
  rejectedAt       DateTime?
  rejectedById     String?
  rejectionReason  String?
  status           CompanyStatus          @default(PENDING)
  offers           Offer[]
  teamMembers      User[]                 @relation("CompanyMembers")
  owner            User?                  @relation("CompanyOwner")
  budgets          Budget[]
  accountManager   User?                  @relation("AccountManager", fields: [accountManagerId], references: [id])
  approvedBy       User?                  @relation("CompanyApprovedBy", fields: [approvedById], references: [id])
  currentPlan      PlanConfig?            @relation("CompanyCurrentPlan", fields: [currentPlanId], references: [id])
  lastReviewedBy   User?                  @relation("CompanyLastReviewedBy", fields: [lastReviewedById], references: [id])
  rejectedBy       User?                  @relation("CompanyRejectedBy", fields: [rejectedById], references: [id])
  profileChanges   CompanyProfileChange[]
  coupons          Coupon[]               @relation("CompanyCoupons")
  groupOffers      GroupOfferConfig[]     @relation("CompanyGroupOffers")
  invoices         Invoice[]
  leads            Lead[]
  offerEvents      OfferEvent[]           @relation("CompanyOfferEvents")
  redemptions      Redemption[]           @relation("CompanyRedemptions")
  subscriptions    Subscription[]
  originalLead     CompanyLead?           @relation("ConvertedLead")
  tasks            Task[]

  @@index([cif])
  @@index([currentPlanId])
  @@index([accountManagerId])
  @@index([status])
  @@index([createdAt])
  @@index([isActive])
  @@index([status, isActive])
  @@map("companies")
}

model PlanConfig {
  id                String         @id @default(cuid())
  planType          String         @unique
  nombre            String
  nombreCorto       String
  descripcion       String
  precioMensual     Float
  precioAnual       Float?
  limitesJSON       String
  caracteristicas   String
  color             String
  icono             String
  orden             Int            @default(0)
  destacado         Boolean        @default(false)
  activo            Boolean        @default(true)
  visible           Boolean        @default(true)
  esSistema         Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  displayNote       String?        @default("IVA incluido")
  priceIncludesVAT  Boolean        @default(true)
  badge             String?
  badgeColor        String?
  basePrice         Float
  description       String?
  durationMonths    Int            @default(12)
  features          Json
  firstYearDiscount Float          @default(0)
  hasFreeTrial      Boolean        @default(false)
  isActive          Boolean        @default(true)
  isDefault         Boolean        @default(false)
  isPioneer         Boolean        @default(false)
  isVisible         Boolean        @default(true)
  maxActiveOffers   Int?
  maxFeaturedOffers Int            @default(0)
  maxStorage        Int?
  maxTeamMembers    Int            @default(1)
  name              String
  nameEn            String?
  nameEs            String?
  priority          Int            @default(0)
  slug              String         @unique
  tier              PlanTier
  trialDurationDays Int?
  funcionalidades   String?
  budgetItems       BudgetItem[]
  companies         Company[]      @relation("CompanyCurrentPlan")
  invoiceItems      InvoiceItem[]
  subscriptions     Subscription[] @relation("SubscriptionPlan")

  @@index([tier])
  @@index([slug])
  @@index([planType])
  @@index([activo, visible])
  @@index([priority])
  @@index([orden])
  @@map("plan_configs")
}

model Subscription {
  id            String             @id @default(cuid())
  companyId     String
  planId        String
  status        SubscriptionStatus @default(ACTIVE)
  precioMensual Float
  precioAnual   Float?
  limites       Json
  startDate     DateTime           @default(now())
  endDate       DateTime?
  cancelledAt   DateTime?
  isAutoRenew   Boolean            @default(true)
  extras        Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  invoices      Invoice[]
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan          PlanConfig         @relation("SubscriptionPlan", fields: [planId], references: [id])

  @@index([companyId])
  @@index([planId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

model Invoice {
  id               String        @id @default(cuid())
  invoiceNumber    String        @unique
  invoiceSeries    String        @default("A")
  companyId        String
  subscriptionId   String?
  status           InvoiceStatus @default(DRAFT)
  issueDate        DateTime      @default(now())
  dueDate          DateTime
  paidDate         DateTime?
  periodStart      DateTime?
  periodEnd        DateTime?
  issuerName       String        @default("La P煤blica Servicios Digitales S.L.")
  issuerCif        String        @default("B12345678")
  issuerAddress    String        @default("Calle Ejemplo 123, 08001 Barcelona")
  issuerEmail      String        @default("facturacion@lapublica.es")
  issuerPhone      String?       @default("933123456")
  clientName       String
  clientCif        String
  clientEmail      String
  clientAddress    String
  clientPhone      String?
  clientCity       String?
  clientPostalCode String?
  clientCountry    String        @default("Espa帽a")
  concept          String
  notes            String?
  subtotalAmount   Int
  taxAmount        Int
  totalAmount      Int
  taxRate          Float         @default(21.0)
  taxType          String        @default("IVA")
  discountPercent  Float?
  discountAmount   Int?
  paidAmount       Int           @default(0)
  pendingAmount    Int
  legalText        String        @default("Esta factura se emite conforme a la Ley 37/1992 del IVA y RD 1619/2012 de facturas")
  retentionPercent Float?
  retentionAmount  Int?
  pdfUrl           String?
  xmlUrl           String?
  createdById      String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  invoiceType      InvoiceType   @default(REGULAR)
  pricesIncludeVAT Boolean       @default(true)
  budgets          Budget?
  items            InvoiceItem[]
  company          Company       @relation(fields: [companyId], references: [id])
  createdBy        User?         @relation("InvoicesCreated", fields: [createdById], references: [id])
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])
  payments         Payment[]

  @@index([companyId, status])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@index([issueDate])
  @@index([clientCif])
  @@map("invoices")
}

model InvoiceItem {
  id              String          @id @default(cuid())
  invoiceId       String
  description     String
  concept         String?
  quantity        Float           @default(1.0)
  unitPrice       Int
  discountPercent Float?
  discountAmount  Int?
  subtotalAmount  Int
  taxRate         Float           @default(21.0)
  taxAmount       Int
  totalAmount     Int
  order           Int             @default(0)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  extraId         String?
  isProrated      Boolean         @default(false)
  itemType        InvoiceItemType @default(CUSTOM)
  planId          String?
  proratedDays    Int?
  extra           Extra?          @relation(fields: [extraId], references: [id])
  invoice         Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  plan            PlanConfig?     @relation(fields: [planId], references: [id])

  @@index([invoiceId])
  @@index([order])
  @@map("invoice_items")
}

model Payment {
  id              String        @id @default(cuid())
  invoiceId       String
  paymentNumber   String        @unique
  reference       String?
  externalId      String?
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Int
  feeAmount       Int?
  netAmount       Int
  paymentDate     DateTime      @default(now())
  processedDate   DateTime?
  settledDate     DateTime?
  paymentDetails  Json?
  description     String?
  notes           String?
  processedById   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  stripePaymentId String?       @unique
  stripeSessionId String?       @unique
  invoice         Invoice       @relation(fields: [invoiceId], references: [id])
  processedBy     User?         @relation("PaymentsProcessed", fields: [processedById], references: [id])

  @@index([invoiceId])
  @@index([paymentNumber])
  @@index([method])
  @@index([status])
  @@index([paymentDate])
  @@map("payments")
}

model Extra {
  id               String        @id @default(cuid())
  name             String
  slug             String        @unique
  description      String
  category         ExtraCategory
  basePrice        Decimal       @db.Decimal(10, 2)
  priceType        PriceType
  active           Boolean       @default(true)
  featured         Boolean       @default(false)
  requiresApproval Boolean       @default(false)
  icon             String?
  image            String?
  details          Json?
  order            Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  displayNote      String?       @default("IVA incluido")
  priceIncludesVAT Boolean       @default(true)
  budgetItems      BudgetItem[]
  invoiceItems     InvoiceItem[]

  @@index([category])
  @@index([active])
  @@index([slug])
  @@map("extras")
}

model Budget {
  id             String       @id @default(cuid())
  budgetNumber   String       @unique
  companyId      String
  issueDate      DateTime     @default(now())
  validUntil     DateTime
  approvedAt     DateTime?
  rejectedAt     DateTime?
  status         BudgetStatus @default(DRAFT)
  subtotal       Decimal      @db.Decimal(10, 2)
  taxRate        Decimal      @default(21.00) @db.Decimal(5, 2)
  taxAmount      Decimal      @db.Decimal(10, 2)
  discountAmount Decimal?     @db.Decimal(10, 2)
  total          Decimal      @db.Decimal(10, 2)
  clientName     String
  clientEmail    String
  clientPhone    String?
  clientNIF      String?
  invoiceId      String?      @unique
  notes          String?
  internalNotes  String?
  terms          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  createdBy      String?
  items          BudgetItem[]
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice        Invoice?     @relation(fields: [invoiceId], references: [id])

  @@index([companyId])
  @@index([status])
  @@index([budgetNumber])
  @@map("budgets")
}

model BudgetItem {
  id              String         @id @default(cuid())
  budgetId        String
  order           Int            @default(0)
  itemType        BudgetItemType
  planId          String?
  extraId         String?
  description     String
  quantity        Decimal        @default(1) @db.Decimal(10, 2)
  unitPrice       Decimal        @db.Decimal(10, 2)
  discountPercent Decimal?       @db.Decimal(5, 2)
  subtotal        Decimal        @db.Decimal(10, 2)
  billingCycle    BillingCycle?
  createdAt       DateTime       @default(now())
  budget          Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  extra           Extra?         @relation(fields: [extraId], references: [id])
  plan            PlanConfig?    @relation(fields: [planId], references: [id])

  @@index([budgetId])
  @@map("budget_items")
}

model Notification {
  id        String               @id @default(cuid())
  title     String
  message   String
  type      NotificationType
  priority  NotificationPriority @default(NORMAL)
  isRead    Boolean              @default(false)
  userId    String
  senderId  String?
  companyId String?
  metadata  Json?
  createdAt DateTime             @default(now())
  readAt    DateTime?
  sender    User?                @relation("NotificationSender", fields: [senderId], references: [id])
  user      User                 @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([type, priority])
  @@index([createdAt])
  @@map("notifications")
}

model CompanyProfileChange {
  id              String              @id @default(cuid())
  companyId       String
  type            ProfileChangeType
  status          ProfileChangeStatus @default(PENDING)
  oldValue        Json?
  newValue        Json?
  description     String?
  requestedById   String
  approvedById    String?
  rejectedById    String?
  rejectionReason String?
  createdAt       DateTime            @default(now())
  reviewedAt      DateTime?
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([type, status])
  @@index([createdAt])
  @@map("company_profile_changes")
}

model OfferCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  offers      Offer[]

  @@index([slug])
  @@index([isActive])
}

model Offer {
  id                 String              @id @default(cuid())
  title              String
  slug               String              @unique
  shortDescription   String?
  description        String
  images             String[]            @default([])
  price              Decimal?            @db.Decimal(10, 2)
  originalPrice      Decimal?            @db.Decimal(10, 2)
  currency           String              @default("EUR")
  priceType          PriceType           @default(FIXED)
  companyId          String
  categoryId         String
  status             OfferStatus         @default(DRAFT)
  publishedAt        DateTime?
  expiresAt          DateTime?
  approvedAt         DateTime?
  approvedBy         String?
  rejectedAt         DateTime?
  rejectedBy         String?
  rejectedReason     String?
  submittedAt        DateTime?
  priority           Int                 @default(0)
  featured           Boolean             @default(false)
  featuredUntil      DateTime?
  contactMethod      ContactMethod       @default(EMAIL)
  contactEmail       String?
  contactPhone       String?
  contactForm        String?
  externalUrl        String?
  requirements       String?
  benefits           String?
  duration           String?
  location           String?
  remote             Boolean             @default(false)
  tags               String[]            @default([])
  views              Int                 @default(0)
  clicks             Int                 @default(0)
  applications       Int                 @default(0)
  shares             Int                 @default(0)
  lastViewedAt       DateTime?
  seoTitle           String?
  seoDescription     String?
  seoKeywords        String[]            @default([])
  internalNotes      String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  redemptionType     RedemptionType      @default(COUPON)
  approvedByUser     User?               @relation("OfferApprovals", fields: [approvedBy], references: [id])
  category           OfferCategory       @relation(fields: [categoryId], references: [id])
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rejectedByUser     User?               @relation("OfferRejections", fields: [rejectedBy], references: [id])
  coupons            Coupon[]            @relation("OfferCoupons")
  leads              Lead[]
  events             OfferEvent[]        @relation("OfferEvents")
  redemptions        Redemption[]        @relation("OfferRedemptions")
  favorites          UserFavorite[]      @relation("OfferFavorites")
  walletTransactions WalletTransaction[]

  @@index([companyId, status])
  @@index([categoryId, status])
  @@index([status, publishedAt])
  @@index([status])
  @@index([featured, featuredUntil])
  @@index([slug])
  @@index([priority])
  @@index([expiresAt])
  @@index([createdAt])
}

model UserFavorite {
  id        String   @id @default(cuid())
  userId    String
  offerId   String
  createdAt DateTime @default(now())
  offer     Offer    @relation("OfferFavorites", fields: [offerId], references: [id], onDelete: Cascade)
  user      User     @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, offerId], name: "unique_user_offer_favorite")
  @@index([userId], map: "idx_favorite_user")
  @@index([offerId], map: "idx_favorite_offer")
  @@index([createdAt], map: "idx_favorite_created")
  @@map("user_favorites")
}

model Coupon {
  id                 String              @id @default(cuid())
  code               String              @unique
  offerId            String
  userId             String
  companyId          String
  qrCodeUrl          String?
  qrCodeData         String?
  status             CouponStatus        @default(ACTIVE)
  generatedAt        DateTime            @default(now())
  expiresAt          DateTime
  usedAt             DateTime?
  cancelledAt        DateTime?
  userAgent          String?
  ipAddress          String?
  deviceType         String?
  generatedFrom      String?
  notes              String?
  company            Company             @relation("CompanyCoupons", fields: [companyId], references: [id], onDelete: Cascade)
  offer              Offer               @relation("OfferCoupons", fields: [offerId], references: [id], onDelete: Cascade)
  user               User                @relation("UserCoupons", fields: [userId], references: [id], onDelete: Cascade)
  redemption         Redemption?         @relation("CouponRedemption")
  walletTransactions WalletTransaction[]

  @@index([offerId], map: "idx_coupon_offer")
  @@index([userId], map: "idx_coupon_user")
  @@index([companyId], map: "idx_coupon_company")
  @@index([code], map: "idx_coupon_code")
  @@index([status], map: "idx_coupon_status")
  @@index([expiresAt], map: "idx_coupon_expires")
  @@index([generatedAt], map: "idx_coupon_generated")
  @@map("coupons")
}

model Redemption {
  id                 String   @id @default(cuid())
  couponId           String   @unique
  offerId            String
  userId             String
  companyId          String
  redeemedAt         DateTime @default(now())
  redemptionType     String   @default("in_store")
  channel            String?
  location           String?
  storeId            String?
  originalPrice      Decimal? @db.Decimal(10, 2)
  discountAmount     Decimal? @db.Decimal(10, 2)
  finalPrice         Decimal? @db.Decimal(10, 2)
  currency           String   @default("EUR")
  validatedBy        String?
  validatedAt        DateTime @default(now())
  verificationMethod String?
  userAgent          String?
  ipAddress          String?
  deviceType         String?
  notes              String?
  customerNotes      String?
  receiptNumber      String?
  rating             Int?
  feedback           String?
  company            Company  @relation("CompanyRedemptions", fields: [companyId], references: [id], onDelete: Cascade)
  coupon             Coupon   @relation("CouponRedemption", fields: [couponId], references: [id], onDelete: Cascade)
  offer              Offer    @relation("OfferRedemptions", fields: [offerId], references: [id], onDelete: Cascade)
  user               User     @relation("UserRedemptions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([offerId], map: "idx_redemption_offer")
  @@index([userId], map: "idx_redemption_user")
  @@index([companyId], map: "idx_redemption_company")
  @@index([redeemedAt], map: "idx_redemption_date")
  @@index([redemptionType], map: "idx_redemption_type")
  @@map("redemptions")
}

model OfferEvent {
  id          String    @id @default(cuid())
  offerId     String
  userId      String?
  companyId   String
  eventType   EventType
  sessionId   String?
  userAgent   String?
  ipAddress   String?
  deviceType  String?
  browser     String?
  os          String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  country     String?
  city        String?
  region      String?
  latitude    Float?
  longitude   Float?
  duration    Int?
  scrollDepth Int?
  createdAt   DateTime  @default(now())
  company     Company   @relation("CompanyOfferEvents", fields: [companyId], references: [id], onDelete: Cascade)
  offer       Offer     @relation("OfferEvents", fields: [offerId], references: [id], onDelete: Cascade)
  user        User?     @relation("UserOfferEvents", fields: [userId], references: [id])

  @@index([offerId, eventType], map: "idx_event_offer_type")
  @@index([userId], map: "idx_event_user")
  @@index([companyId], map: "idx_event_company")
  @@index([eventType], map: "idx_event_type")
  @@index([createdAt], map: "idx_event_created")
  @@index([eventType, createdAt], map: "idx_event_type_created")
  @@index([sessionId], map: "idx_event_session")
  @@map("offer_events")
}

model NotificationPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique
  emailEnabled         Boolean  @default(true)
  emailCouponGenerated Boolean  @default(true)
  emailCouponUsed      Boolean  @default(true)
  emailOfferExpiring   Boolean  @default(true)
  emailNewFavorite     Boolean  @default(true)
  emailWeeklySummary   Boolean  @default(true)
  inAppEnabled         Boolean  @default(true)
  inAppCouponGenerated Boolean  @default(true)
  inAppCouponUsed      Boolean  @default(true)
  inAppOfferExpiring   Boolean  @default(true)
  inAppNewFavorite     Boolean  @default(true)
  inAppWeeklySummary   Boolean  @default(false)
  weeklySummaryDay     Int      @default(1)
  weeklySummaryHour    Int      @default(9)
  timezone             String   @default("Europe/Madrid")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation("UserNotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

model EmailLog {
  id           String        @id @default(cuid())
  userId       String
  templateType EmailTemplate
  subject      String
  toEmail      String
  fromEmail    String        @default("noreply@lapublica.es")
  status       EmailStatus   @default(PENDING)
  sentAt       DateTime?
  deliveredAt  DateTime?
  openedAt     DateTime?
  clickedAt    DateTime?
  bouncedAt    DateTime?
  errorMessage String?
  externalId   String?
  metadata     Json?
  createdAt    DateTime      @default(now())
  user         User          @relation("UserEmailLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([templateType])
  @@index([status])
  @@index([sentAt])
  @@index([toEmail])
  @@index([externalId])
  @@map("email_logs")
}

model AuditLog {
  id           String      @id @default(cuid())
  userId       String
  userName     String
  userEmail    String
  userRole     String
  action       AuditAction
  entity       String
  entityId     String?
  entityName   String?
  description  String
  changes      Json?
  metadata     Json?
  ipAddress    String?
  userAgent    String?
  severity     LogSeverity @default(INFO)
  success      Boolean     @default(true)
  errorMessage String?
  createdAt    DateTime    @default(now())
  user         User        @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_auditlog_user")
  @@index([action], map: "idx_auditlog_action")
  @@index([entity], map: "idx_auditlog_entity")
  @@index([entityId], map: "idx_auditlog_entity_id")
  @@index([createdAt], map: "idx_auditlog_created")
  @@index([severity], map: "idx_auditlog_severity")
  @@map("audit_logs")
}

model GroupOfferRequest {
  id              String            @id @default(cuid())
  title           String
  description     String
  category        String?
  location        String?
  minParticipants Int
  maxParticipants Int?
  targetPrice     Decimal?          @db.Decimal(10, 2)
  status          RequestStatus     @default(PENDING)
  publishedAt     DateTime?
  expiresAt       DateTime?
  requesterId     String
  contactEmail    String?
  contactPhone    String?
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  groupOfferId    String?           @unique
  tags            String[]          @default([])
  priority        Int               @default(0)
  internalNotes   String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  groupOffer      GroupOfferConfig? @relation("RequestToConfig", fields: [groupOfferId], references: [id])
  requester       User              @relation("GroupOfferRequests", fields: [requesterId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([requesterId])
  @@index([category])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("group_offer_requests")
}

model GroupOfferConfig {
  id                 String             @id @default(cuid())
  title              String
  slug               String             @unique
  description        String
  shortDescription   String?
  images             String[]           @default([])
  category           String?
  tags               String[]           @default([])
  minParticipants    Int
  maxParticipants    Int
  currentCount       Int                @default(0)
  originalPrice      Decimal            @db.Decimal(10, 2)
  groupPrice         Decimal            @db.Decimal(10, 2)
  savingsAmount      Decimal            @db.Decimal(10, 2)
  savingsPercent     Float
  requiresDeposit    Boolean            @default(false)
  depositAmount      Decimal?           @db.Decimal(10, 2)
  depositPercent     Float?
  registrationStart  DateTime           @default(now())
  registrationEnd    DateTime
  serviceStart       DateTime?
  serviceEnd         DateTime?
  status             GroupOfferStatus   @default(DRAFT)
  publishedAt        DateTime?
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  companyId          String
  contactEmail       String?
  contactPhone       String?
  location           String?
  address            String?
  isOnline           Boolean            @default(false)
  meetingUrl         String?
  requirements       String?
  includes           String?
  excludes           String?
  terms              String?
  cancellationPolicy String?
  refundPolicy       String?
  seoTitle           String?
  seoDescription     String?
  seoKeywords        String[]           @default([])
  priority           Int                @default(0)
  featured           Boolean            @default(false)
  internalNotes      String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  company            Company            @relation("CompanyGroupOffers", fields: [companyId], references: [id], onDelete: Cascade)
  originRequest      GroupOfferRequest? @relation("RequestToConfig")
  participants       GroupParticipant[] @relation("ConfigParticipants")

  @@index([companyId])
  @@index([status])
  @@index([slug])
  @@index([category])
  @@index([registrationEnd])
  @@index([serviceStart])
  @@index([featured])
  @@map("group_offer_configs")
}

model GroupParticipant {
  id                 String            @id @default(cuid())
  groupOfferId       String
  userId             String
  status             ParticipantStatus @default(PENDING)
  joinedAt           DateTime          @default(now())
  confirmedAt        DateTime?
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  contactName        String?
  contactEmail       String?
  contactPhone       String?
  specialRequests    String?
  allergies          String?
  emergencyContact   String?
  notes              String?
  totalAmount        Decimal           @db.Decimal(10, 2)
  paidAmount         Decimal           @default(0) @db.Decimal(10, 2)
  pendingAmount      Decimal           @db.Decimal(10, 2)
  registrationPaid   Boolean           @default(false)
  registrationPaidAt DateTime?
  depositPaid        Boolean           @default(false)
  depositPaidAt      DateTime?
  finalPaid          Boolean           @default(false)
  finalPaidAt        DateTime?
  paymentIds         String[]          @default([])
  invoiceNumbers     String[]          @default([])
  rating             Int?
  feedback           String?
  wouldRecommend     Boolean?
  referredBy         String?
  utmSource          String?
  utmCampaign        String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  groupOffer         GroupOfferConfig  @relation("ConfigParticipants", fields: [groupOfferId], references: [id], onDelete: Cascade)
  user               User              @relation("UserGroupParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupOfferId, userId], name: "unique_group_user_participation")
  @@index([groupOfferId])
  @@index([userId])
  @@index([status])
  @@index([joinedAt])
  @@map("group_participants")
}

model UserWallet {
  id           String              @id @default(cuid())
  userId       String              @unique
  balance      Decimal             @default(0) @db.Decimal(10, 2)
  currency     String              @default("EUR")
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([userId])
  @@map("user_wallets")
}

model WalletTransaction {
  id          String     @id @default(cuid())
  walletId    String
  type        String
  amount      Decimal    @db.Decimal(10, 2)
  description String
  offerId     String?
  couponId    String?
  metadata    Json?
  createdAt   DateTime   @default(now())
  coupon      Coupon?    @relation(fields: [couponId], references: [id])
  offer       Offer?     @relation(fields: [offerId], references: [id])
  wallet      UserWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([offerId])
  @@index([type])
  @@index([createdAt])
  @@map("wallet_transactions")
}

model Lead {
  id        String   @id @default(cuid())
  offerId   String
  userId    String
  companyId String
  name      String
  email     String
  phone     String?
  message   String?
  status    String   @default("NEW")
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  offer     Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@index([userId])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("leads")
}

enum UserRole {
  USER
  MODERATOR
  COMMUNITY_MANAGER
  ADMIN
  SUPER_ADMIN
  COMPANY
  COMPANY_MANAGER
}

enum AnuncioType {
  GENERAL
  URGENT
  EVENT
  MAINTENANCE
  NEWS
  ALERT
  PROMOTION
  REGULATION
}

enum AnuncioStatus {
  DRAFT
  PENDING
  PUBLISHED
  ARCHIVED
  EXPIRED
}

enum AudienceType {
  ALL
  EMPLOYEES
  COMPANIES
  SPECIFIC
  COMMUNITY
}

enum NotificationChannel {
  PLATFORM
  EMAIL
  SMS
  PUSH
  ALL_CHANNELS
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

enum UserType {
  EMPLOYEE
  COMPANY_OWNER
  COMPANY_MEMBER
  ACCOUNT_MANAGER
  ADMIN
}

enum CompanyRole {
  OWNER
  MEMBER
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  CASH
  CHECK
  SEPA_DIRECT_DEBIT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum ExtraCategory {
  WEB_MAINTENANCE
  BRANDING
  MARKETING
  SEO
  CONTENT
  CONSULTING
  TRAINING
  DEVELOPMENT
  SUPPORT
  OTHER
}

enum PriceType {
  FIXED
  MONTHLY
  ANNUAL
  HOURLY
  CUSTOM
}

enum BudgetStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
  INVOICED
}

enum BudgetItemType {
  PLAN
  EXTRA
  CUSTOM
  DISCOUNT
}

enum BillingCycle {
  MONTHLY
  ANNUAL
  ONE_TIME
}

enum InvoiceItemType {
  PLAN
  EXTRA
  UPGRADE
  PRORATED
  DISCOUNT
  CUSTOM
}

enum InvoiceType {
  REGULAR
  PROFORMA
  RECURRING
  UPGRADE
  ADJUSTMENT
  REFUND
}

enum CompanyStatus {
  PENDING
  PUBLISHED
  REJECTED
  SUSPENDED
  INACTIVE
}

enum NotificationType {
  COMPANY_PENDING
  COMPANY_APPROVED
  COMPANY_REJECTED
  PROFILE_CHANGE
  GENERAL
  SYSTEM
  COUPON_GENERATED
  COUPON_USED
  OFFER_EXPIRING
  NEW_FAVORITE
  WEEKLY_SUMMARY
}

enum ProfileChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProfileChangeType {
  COMPANY_DATA
  CONTACT_INFO
  LOGO
  DESCRIPTION
  OTHER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum PlanTier {
  PIONERES
  STANDARD
  STRATEGIC
  ENTERPRISE
  CUSTOM
}

enum OfferStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
  PAUSED
  EXPIRED
  ARCHIVED
}

enum RedemptionType {
  COUPON
  ONLINE
  VIP_ACCOUNT
  CONTACT_FORM
}

enum ContactMethod {
  EMAIL
  PHONE
  FORM
  EXTERNAL
  WHATSAPP
}

enum CouponStatus {
  ACTIVE
  USED
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum EventType {
  VIEW
  DETAIL_VIEW
  CLICK
  SHARE
  FAVORITE_ADD
  FAVORITE_REMOVE
  COUPON_VIEW
  COUPON_GENERATED
  COUPON_DOWNLOADED
  COUPON_SHARED
  COUPON_USED
  EXTERNAL_CLICK
  CONTACT_CLICK
  PHONE_CLICK
  EMAIL_CLICK
  MAP_VIEW
  GALLERY_VIEW
}

enum EmailTemplate {
  COUPON_GENERATED
  COUPON_USED
  OFFER_EXPIRING
  NEW_FAVORITE
  WEEKLY_SUMMARY
  WELCOME
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum AuditAction {
  COMPANY_APPROVED
  COMPANY_REJECTED
  COMPANY_SUSPENDED
  COMPANY_REACTIVATED
  COMPANY_DELETED
  COMPANY_UPDATED
  OFFER_APPROVED
  OFFER_REJECTED
  OFFER_DELETED
  OFFER_FEATURED
  OFFER_UNFEATURED
  OFFER_UPDATED
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_SUSPENDED
  USER_REACTIVATED
  USER_ROLE_CHANGED
  COUPON_CANCELLED
  COUPON_BULK_EXPORT
  SETTINGS_UPDATED
  PLAN_CONFIG_UPDATED
  BULK_ACTION
  LOGIN_ADMIN
  LOGOUT_ADMIN
  PERMISSION_CHANGED
  OTHER
}

enum LogSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum GroupOfferStatus {
  DRAFT
  PUBLISHED
  PAUSED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum ParticipantStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
}

enum PaymentStage {
  REGISTRATION
  DEPOSIT
  FINAL
  FULL
}

// =============================================================================
// CRM MODELS FOR COMPANY LEAD MANAGEMENT
// =============================================================================

model CompanyLead {
  id                   String       @id @default(cuid())

  // Informaci贸n b谩sica empresa
  companyName          String
  cif                  String?
  sector               String?
  contactName          String
  contactRole          String?
  email                String
  phone                String?
  website              String?

  // Clasificaci贸n
  companySize          String?      // "10-50", "50-200", "200+"
  estimatedRevenue     Decimal?     @db.Decimal(10, 2)

  //  TRACKING PUBLICIDAD (REQUERIMIENTO NUEVO)
  currentPlatforms     Json?        // Plataformas donde se publicita: VipDistrict, Groupon, etc.
  competitorOffers     Json?        // Ofertas que tiene en otras plataformas
  discountTypes        Json?        // Tipos de descuentos: %, fijo, 2x1, grupal

  // Pipeline CRM
  status               LeadStatus   @default(NEW)
  priority             LeadPriority @default(MEDIUM)
  score                Int?         // Score IA 0-100
  scoreGrade           String?      // A, B, C

  // Seguimiento
  source               LeadSource
  assignedToId         String?
  lastContactDate      DateTime?
  nextFollowUpDate     DateTime?

  // Conversi贸n
  convertedToCompanyId String?      @unique
  convertedAt          DateTime?

  // Metadata
  tags                 String[]
  notes                String?      @db.Text
  internalNotes        String?      @db.Text
  lostReason           String?

  // Timestamps
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  // Relaciones
  assignedTo           User?        @relation("LeadAssignee", fields: [assignedToId], references: [id])
  convertedCompany     Company?     @relation("ConvertedLead", fields: [convertedToCompanyId], references: [id])
  interactions         LeadInteraction[]
  activities           LeadActivity[]
  tasks                LeadTask[]
  documents            LeadDocument[]
  enterpriseTasks      Task[]

  @@index([status])
  @@index([assignedToId])
  @@index([source])
  @@index([createdAt])
  @@index([score])
  @@index([convertedAt])
  @@map("company_leads")
}

model LeadInteraction {
  id          String           @id @default(cuid())
  leadId      String
  userId      String
  type        InteractionType
  title       String?
  description String           @db.Text
  outcome     String?          // Positivo, Neutral, Negativo
  duration    Int?             // En minutos
  metadata    Json?
  createdAt   DateTime         @default(now())

  lead        CompanyLead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([createdAt])
  @@map("lead_interactions")
}

model LeadActivity {
  id          String      @id @default(cuid())
  leadId      String
  userId      String?
  type        String
  description String
  metadata    Json?
  createdAt   DateTime    @default(now())

  lead        CompanyLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([createdAt])
  @@map("lead_activities")
}

model LeadTask {
  id          String        @id @default(cuid())
  leadId      String?
  userId      String
  title       String
  description String?       @db.Text
  dueDate     DateTime?
  priority    LeadPriority  @default(MEDIUM)
  status      TaskStatus    @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  lead        CompanyLead?  @relation(fields: [leadId], references: [id], onDelete: SetNull)
  user        User          @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([dueDate])
  @@index([status])
  @@map("lead_tasks")
}

model LeadDocument {
  id          String      @id @default(cuid())
  leadId      String
  userId      String
  name        String
  fileUrl     String
  fileType    String
  fileSize    Int
  uploadedAt  DateTime    @default(now())

  lead        CompanyLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@map("lead_documents")
}

// =============================================================================
// CRM ENUMS
// =============================================================================

enum LeadStatus {
  NEW              // Nuevo, sin contactar
  PROSPECTING      // En prospecci贸n activa
  CONTACTED        // Primer contacto realizado
  QUALIFIED        // Cualificado, interesado
  PROPOSAL_SENT    // Propuesta enviada
  NEGOTIATION      // En negociaci贸n
  DOCUMENTATION    // Pendiente documentaci贸n
  WON              // Ganado, convertido
  LOST             // Perdido
  ON_HOLD          // En pausa
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LeadSource {
  MANUAL           // Creado manualmente por gestor
  WEB_FORM         // Formulario "Quiero Colaborar"
  AI_PROSPECTING   // Encontrado por IA
  REFERRAL         // Referido por otra empresa
  EMPLOYEE_SUGGESTION // Sugerido por empleado p煤blico
  INBOUND          // Marketing inbound
  COLD_OUTREACH    // Outreach en fr铆o
}

enum InteractionType {
  NOTE           // Nota interna
  CALL           // Llamada telef贸nica
  EMAIL          // Email enviado
  MEETING        // Reuni贸n
  WHATSAPP       // WhatsApp/SMS
  STATUS_CHANGE  // Cambio de estado
  DOCUMENT       // Documento subido
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// =============================================================================
// ENTERPRISE TASK MANAGEMENT SYSTEM
// =============================================================================

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text

  // Clasificaci贸n y contexto
  type        TaskType
  status      TaskStatus @default(PENDING)
  priority    TaskPriority
  category    TaskCategory?

  // Asignaci贸n y ownership
  assignedToId String
  assignedTo   User     @relation("TasksAssigned", fields: [assignedToId], references: [id])
  createdById  String
  createdBy    User     @relation("TasksCreated", fields: [createdById], references: [id])

  // Relaciones con entidades CRM
  leadId      String?
  lead        CompanyLead? @relation(fields: [leadId], references: [id], onDelete: Cascade)
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Temporalidad
  dueDate     DateTime?
  startDate   DateTime?
  completedAt DateTime?
  estimatedMinutes Int?    // Estimaci贸n de tiempo
  actualMinutes    Int?    // Tiempo real gastado

  // Recordatorios
  reminderDate DateTime?
  reminderSent Boolean  @default(false)

  // Recurrencia
  isRecurring      Boolean  @default(false)
  recurrenceRule   String?  // RRULE format
  parentRecurringId String?

  // Scoring y priorizaci贸n inteligente
  urgencyScore    Int      @default(0)  // 0-100
  impactScore     Int      @default(0)  // 0-100
  effortScore     Int      @default(0)  // 0-100
  autoScore       Int      @default(0)  // Calculado autom谩ticamente

  // Dependencias
  blockedBy       Task[]   @relation("TaskDependencies")
  blocking        Task[]   @relation("TaskDependencies")

  // Subtareas
  parentTaskId    String?
  parentTask      Task?    @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subtasks        Task[]   @relation("TaskSubtasks")

  // Metadata
  tags            String[]
  customFields    Json?    // Campos personalizables

  // Auditor铆a
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  comments    TaskComment[]
  attachments TaskAttachment[]
  activities  TaskActivity[]

  @@index([assignedToId])
  @@index([leadId])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
  @@map("tasks")
}

enum TaskType {
  FOLLOW_UP      // Seguimiento
  MEETING        // Reuni贸n
  CALL           // Llamada
  EMAIL          // Email
  DEMO           // Demo producto
  PROPOSAL       // Enviar propuesta
  CONTRACT       // Gesti贸n contrato
  ONBOARDING     // Onboarding cliente
  SUPPORT        // Soporte
  INTERNAL       // Tarea interna
  OTHER          // Otros
}

enum TaskPriority {
  URGENT         // Cr铆tico - inmediato
  HIGH           // Alta
  MEDIUM         // Media
  LOW            // Baja
}

enum TaskCategory {
  SALES          // Ventas
  MARKETING      // Marketing
  SUPPORT        // Soporte
  OPERATIONS     // Operaciones
  ADMIN          // Administraci贸n
  DEVELOPMENT    // Desarrollo
}

// Comentarios en tareas
model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation("TaskComments", fields: [userId], references: [id])

  content   String   @db.Text
  mentions  String[] // IDs de usuarios mencionados

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@map("task_comments")
}

// Attachments
model TaskAttachment {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  fileName  String
  fileUrl   String
  fileSize  Int
  mimeType  String

  uploadedById String
  uploadedBy   User   @relation("TaskAttachments", fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())

  @@index([taskId])
  @@map("task_attachments")
}

// Activity log
model TaskActivity {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId      String?
  user        User?    @relation("TaskActivities", fields: [userId], references: [id])

  action      TaskActivityAction
  description String
  metadata    Json?

  createdAt   DateTime @default(now())

  @@index([taskId])
  @@index([createdAt])
  @@map("task_activities")
}

enum TaskActivityAction {
  CREATED
  UPDATED
  ASSIGNED
  STATUS_CHANGED
  PRIORITY_CHANGED
  COMMENT_ADDED
  COMPLETED
  REOPENED
  DELETED
  ATTACHMENT_ADDED
}
