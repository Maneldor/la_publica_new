generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                     @id @default(cuid())
  email                    String                     @unique
  name                     String?
  image                    String?
  role                     UserRole                   @default(USER)
  customRoleId             String?
  customRole               Role?                      @relation("UserCustomRole", fields: [customRoleId], references: [id], onDelete: SetNull)
  communityId              String?
  isActive                 Boolean                    @default(true)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  userType                 UserType                   @default(EMPLOYEE)
  ownedCompanyId           String?                    @unique
  memberCompanyId          String?
  companyRole              CompanyRole?
  cargo                    String?
  password                 String?
  primaryRole              UserRole?
  isEmailVerified          Boolean                    @default(false)
  lastLogin                DateTime?
  anunciosCreados          Anuncio[]                  @relation("AnunciosCreados")
  comentariosCreados       AnuncioComment[]           @relation("ComentariosCreados")
  offersApproved           Offer[]                    @relation("OfferApprovals")
  offersRejected           Offer[]                    @relation("OfferRejections")
  community                Comunidad?                 @relation(fields: [communityId], references: [id])
  memberCompany            Company?                   @relation("CompanyMembers", fields: [memberCompanyId], references: [id])
  ownedCompany             Company?                   @relation("CompanyOwner", fields: [ownedCompanyId], references: [id])
  ConversationParticipants ConversationParticipants[]
  announcement_reads       announcement_reads[]
  announcements            announcements[]
  auditLogs                AuditLog[]                 @relation("UserAuditLogs")
  managedCompanies         Company[]                  @relation("AccountManager")
  companiesApproved        Company[]                  @relation("CompanyApprovedBy")
  companiesReviewed        Company[]                  @relation("CompanyLastReviewedBy")
  companiesRejected        Company[]                  @relation("CompanyRejectedBy")
  assignedLeads            CompanyLead[]              @relation("LeadAssignee")
  company_ratings          company_ratings[]
  coupons                  Coupon[]                   @relation("UserCoupons")
  emailLogs                EmailLog[]                 @relation("UserEmailLogs")
  groupOfferRequests       GroupOfferRequest[]        @relation("GroupOfferRequests")
  groupParticipations      GroupParticipant[]         @relation("UserGroupParticipants")
  invoicesCreated          Invoice[]                  @relation("InvoicesCreated")
  leadActivities           LeadActivity[]
  leadDocuments            LeadDocument[]
  leadInteractions         LeadInteraction[]
  leadTasks                LeadTask[]
  leads                    Lead[]
  sentMessages             Message[]                  @relation("MessageSender")
  notificationPreference   NotificationPreference?    @relation("UserNotificationPreferences")
  sentNotifications        Notification[]             @relation("NotificationSender")
  notifications            Notification[]             @relation("UserNotifications")
  offerEvents              OfferEvent[]               @relation("UserOfferEvents")
  paymentsProcessed        Payment[]                  @relation("PaymentsProcessed")
  redemptions              Redemption[]               @relation("UserRedemptions")
  taskActivities           TaskActivity[]             @relation("TaskActivities")
  taskAttachments          TaskAttachment[]           @relation("TaskAttachments")
  taskComments             TaskComment[]              @relation("TaskComments")
  tasksAssigned            Task[]                     @relation("TasksAssigned")
  tasksCreated             Task[]                     @relation("TasksCreated")
  favorites                UserFavorite[]             @relation("UserFavorites")
  wallet                   UserWallet?

  // Relacions Eines
  einesCreated             EinesResource[]            @relation("EinesCreatedBy")
  einesUpdated             EinesResource[]            @relation("EinesUpdatedBy")
  completedChecks          LeadPhaseCheck[]

  // Relacions Recursos Comercials
  resourcesCreated         CommercialResource[]       @relation("ResourceCreator")
  resourcesUpdated         CommercialResource[]       @relation("ResourceUpdater")
  resourceUsages           ResourceUsage[]

  // Relacions amb campanyes
  campaignsCreated    Campaign[]          @relation("CampaignCreator")
  campaignRecipients  CampaignRecipient[]
  
  // Relacions amb avisos
  noticesCreated      PlatformNotice[]   @relation("NoticeCreator")
  noticeDismissals    NoticeDismissal[]  @relation("UserNoticeDismissals")

  @@index([email])
  @@index([role])
  @@index([communityId])
  @@index([userType])
  @@index([ownedCompanyId])
  @@index([memberCompanyId])
  @@index([createdAt])
  @@index([isActive, createdAt])

  employee                 Employee?
  publicAdministration     PublicAdministration?
}

model Comunidad {
  id          String    @id @default(cuid())
  nombre      String
  descripcion String?
  activa      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  anuncios    Anuncio[]
  usuarios    User[]

  @@index([activa])
}

model Anuncio {
  id                   String                @id @default(cuid())
  title                String
  content              String
  summary              String?
  type                 AnuncioType
  priority             Int                   @default(5)
  status               AnuncioStatus         @default(DRAFT)
  audience             AudienceType
  targetCommunities    String[]
  targetRoles          String[]
  publishAt            DateTime?
  expiresAt            DateTime?
  sendNotification     Boolean               @default(false)
  notificationChannels NotificationChannel[]
  imageUrl             String?
  attachmentUrl        String?
  externalUrl          String?
  tags                 String[]
  isSticky             Boolean               @default(false)
  allowComments        Boolean               @default(true)
  slug                 String?
  views                Int                   @default(0)
  reactions            Int                   @default(0)
  commentsCount        Int                   @default(0)
  sharesCount          Int                   @default(0)
  communityId          String?
  authorId             String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  author               User                  @relation("AnunciosCreados", fields: [authorId], references: [id])
  community            Comunidad?            @relation(fields: [communityId], references: [id], onDelete: Cascade)
  comments             AnuncioComment[]
  metrics              AnuncioMetrics?

  @@index([communityId, status, publishAt])
  @@index([type, audience])
  @@index([authorId])
  @@index([deletedAt])
  @@index([slug])
  @@index([publishAt, expiresAt])
}

model AnuncioComment {
  id               String           @id @default(cuid())
  content          String
  isPrivate        Boolean          @default(false)
  attachmentUrl    String?
  parentId         String?
  anuncioId        String
  authorId         String
  status           CommentStatus    @default(PENDING)
  moderatedBy      String?
  moderatedAt      DateTime?
  moderationReason String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  anuncio          Anuncio          @relation(fields: [anuncioId], references: [id], onDelete: Cascade)
  author           User             @relation("ComentariosCreados", fields: [authorId], references: [id])
  parent           AnuncioComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies          AnuncioComment[] @relation("CommentReplies")

  @@index([anuncioId, status])
  @@index([authorId])
  @@index([parentId])
}

model AnuncioMetrics {
  id                String    @id @default(cuid())
  anuncioId         String    @unique
  views             Int       @default(0)
  clicks            Int       @default(0)
  reactions         Int       @default(0)
  comments          Int       @default(0)
  shares            Int       @default(0)
  emailOpens        Int       @default(0)
  emailClicks       Int       @default(0)
  pushOpens         Int       @default(0)
  engagementRate    Float     @default(0)
  lastViewedAt      DateTime?
  lastInteractionAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  anuncio           Anuncio   @relation(fields: [anuncioId], references: [id], onDelete: Cascade)

  @@index([engagementRate])
  @@index([lastViewedAt])
}

model Company {
  id               String                 @id @default(cuid())
  name             String
  cif              String?                @unique
  email            String
  phone            String?
  address          String?
  logo             String?
  description      String?
  website          String?
  currentPlanId    String?
  accountManagerId String?
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  approvedAt       DateTime?
  approvedById     String?
  lastReviewedAt   DateTime?
  lastReviewedById String?
  rejectedAt       DateTime?
  rejectedById     String?
  rejectionReason  String?
  status           CompanyStatus          @default(PENDING)
  annualRevenue    Decimal?               @db.Decimal(15, 2)
  certifications   Json?
  configuration    Json?
  employeeCount    Int?
  foundingYear     Int?
  logoUrl          String?
  sector           String?
  size             String?
  socialMedia      Json?
  tags             String[]               @default([])
  userId           String?
  isVerified       Boolean                @default(false)
  offers           Offer[]
  teamMembers      User[]                 @relation("CompanyMembers")
  owner            User?                  @relation("CompanyOwner")
  budgets          Budget[]
  accountManager   User?                  @relation("AccountManager", fields: [accountManagerId], references: [id])
  approvedBy       User?                  @relation("CompanyApprovedBy", fields: [approvedById], references: [id])
  currentPlan      PlanConfig?            @relation("CompanyCurrentPlan", fields: [currentPlanId], references: [id])
  lastReviewedBy   User?                  @relation("CompanyLastReviewedBy", fields: [lastReviewedById], references: [id])
  rejectedBy       User?                  @relation("CompanyRejectedBy", fields: [rejectedById], references: [id])
  company_advisory company_advisory[]
  originalLead     CompanyLead?           @relation("ConvertedLead")
  company_products company_products[]
  profileChanges   CompanyProfileChange[]
  company_ratings  company_ratings[]
  company_services company_services[]
  contacts         contacts[]
  coupons          Coupon[]               @relation("CompanyCoupons")
  groupOffers      GroupOfferConfig[]     @relation("CompanyGroupOffers")
  invoices         Invoice[]
  leads            Lead[]
  notifications    Notification[]
  offerEvents      OfferEvent[]           @relation("CompanyOfferEvents")
  redemptions      Redemption[]           @relation("CompanyRedemptions")
  subscriptions    Subscription[]
  tasks            Task[]

  @@index([cif])
  @@index([currentPlanId])
  @@index([accountManagerId])
  @@index([status])
  @@index([createdAt])
  @@index([isActive])
  @@index([status, isActive])
  @@map("companies")
}

model PlanConfig {
  id                String         @id @default(cuid())
  planType          String         @unique
  nombre            String
  nombreCorto       String
  descripcion       String
  precioMensual     Float
  precioAnual       Float?
  limitesJSON       String
  caracteristicas   String
  color             String
  icono             String
  orden             Int            @default(0)
  destacado         Boolean        @default(false)
  activo            Boolean        @default(true)
  visible           Boolean        @default(true)
  esSistema         Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  displayNote       String?        @default("IVA incluido")
  priceIncludesVAT  Boolean        @default(true)
  badge             String?
  badgeColor        String?
  basePrice         Float
  description       String?
  durationMonths    Int            @default(12)
  features          Json
  firstYearDiscount Float          @default(0)
  hasFreeTrial      Boolean        @default(false)
  isActive          Boolean        @default(true)
  isDefault         Boolean        @default(false)
  isPioneer         Boolean        @default(false)
  isVisible         Boolean        @default(true)
  maxActiveOffers   Int?
  maxFeaturedOffers Int            @default(0)
  maxStorage        Int?
  maxTeamMembers    Int            @default(1)
  name              String
  nameEn            String?
  nameEs            String?
  priority          Int            @default(0)
  slug              String         @unique
  tier              PlanTier
  trialDurationDays Int?
  funcionalidades   String?
  budgetItems       BudgetItem[]
  companies         Company[]      @relation("CompanyCurrentPlan")
  invoiceItems      InvoiceItem[]
  subscriptions     Subscription[] @relation("SubscriptionPlan")

  @@index([tier])
  @@index([slug])
  @@index([planType])
  @@index([activo, visible])
  @@index([priority])
  @@index([orden])
  @@map("plan_configs")
}

model Subscription {
  id            String             @id @default(cuid())
  companyId     String
  planId        String
  status        SubscriptionStatus @default(ACTIVE)
  precioMensual Float
  precioAnual   Float?
  limites       Json
  startDate     DateTime           @default(now())
  endDate       DateTime?
  cancelledAt   DateTime?
  isAutoRenew   Boolean            @default(true)
  extras        Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  invoices      Invoice[]
  company       Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan          PlanConfig         @relation("SubscriptionPlan", fields: [planId], references: [id])

  @@index([companyId])
  @@index([planId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

model Invoice {
  id               String        @id @default(cuid())
  invoiceNumber    String        @unique
  invoiceSeries    String        @default("A")
  companyId        String
  subscriptionId   String?
  status           InvoiceStatus @default(DRAFT)
  issueDate        DateTime      @default(now())
  dueDate          DateTime
  paidDate         DateTime?
  periodStart      DateTime?
  periodEnd        DateTime?
  issuerName       String        @default("La Pública Servicios Digitales S.L.")
  issuerCif        String        @default("B12345678")
  issuerAddress    String        @default("Calle Ejemplo 123, 08001 Barcelona")
  issuerEmail      String        @default("facturacion@lapublica.es")
  issuerPhone      String?       @default("933123456")
  clientName       String
  clientCif        String
  clientEmail      String
  clientAddress    String
  clientPhone      String?
  clientCity       String?
  clientPostalCode String?
  clientCountry    String        @default("España")
  concept          String
  notes            String?
  subtotalAmount   Int
  taxAmount        Int
  totalAmount      Int
  taxRate          Float         @default(21.0)
  taxType          String        @default("IVA")
  discountPercent  Float?
  discountAmount   Int?
  paidAmount       Int           @default(0)
  pendingAmount    Int
  legalText        String        @default("Esta factura se emite conforme a la Ley 37/1992 del IVA y RD 1619/2012 de facturas")
  retentionPercent Float?
  retentionAmount  Int?
  pdfUrl           String?
  xmlUrl           String?
  createdById      String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  invoiceType      InvoiceType   @default(REGULAR)
  pricesIncludeVAT Boolean       @default(true)
  budgets          Budget?
  items            InvoiceItem[]
  company          Company       @relation(fields: [companyId], references: [id])
  createdBy        User?         @relation("InvoicesCreated", fields: [createdById], references: [id])
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])
  payments         Payment[]

  @@index([companyId, status])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@index([issueDate])
  @@index([clientCif])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id              String          @id @default(cuid())
  invoiceId       String
  description     String
  concept         String?
  quantity        Float           @default(1.0)
  unitPrice       Int
  discountPercent Float?
  discountAmount  Int?
  subtotalAmount  Int
  taxRate         Float           @default(21.0)
  taxAmount       Int
  totalAmount     Int
  order           Int             @default(0)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  extraId         String?
  isProrated      Boolean         @default(false)
  itemType        InvoiceItemType @default(CUSTOM)
  planId          String?
  proratedDays    Int?
  extra           Extra?          @relation(fields: [extraId], references: [id])
  invoice         Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  plan            PlanConfig?     @relation(fields: [planId], references: [id])

  @@index([invoiceId])
  @@index([order])
  @@map("invoice_items")
}

model Payment {
  id              String        @id @default(cuid())
  invoiceId       String
  paymentNumber   String        @unique
  reference       String?
  externalId      String?
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  amount          Int
  feeAmount       Int?
  netAmount       Int
  paymentDate     DateTime      @default(now())
  processedDate   DateTime?
  settledDate     DateTime?
  paymentDetails  Json?
  description     String?
  notes           String?
  processedById   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  stripePaymentId String?       @unique
  stripeSessionId String?       @unique
  invoice         Invoice       @relation(fields: [invoiceId], references: [id])
  processedBy     User?         @relation("PaymentsProcessed", fields: [processedById], references: [id])

  @@index([invoiceId])
  @@index([paymentNumber])
  @@index([method])
  @@index([status])
  @@index([paymentDate])
  @@map("payments")
}

model Extra {
  id               String        @id @default(cuid())
  name             String
  slug             String        @unique
  description      String
  category         ExtraCategory
  basePrice        Decimal       @db.Decimal(10, 2)
  priceType        PriceType
  active           Boolean       @default(true)
  featured         Boolean       @default(false)
  requiresApproval Boolean       @default(false)
  icon             String?
  image            String?
  details          Json?
  order            Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  displayNote      String?       @default("IVA incluido")
  priceIncludesVAT Boolean       @default(true)
  budgetItems      BudgetItem[]
  invoiceItems     InvoiceItem[]

  @@index([category])
  @@index([active])
  @@index([slug])
  @@map("extras")
}

model Budget {
  id             String       @id @default(cuid())
  budgetNumber   String       @unique
  companyId      String
  issueDate      DateTime     @default(now())
  validUntil     DateTime
  approvedAt     DateTime?
  rejectedAt     DateTime?
  status         BudgetStatus @default(DRAFT)
  subtotal       Decimal      @db.Decimal(10, 2)
  taxRate        Decimal      @default(21.00) @db.Decimal(5, 2)
  taxAmount      Decimal      @db.Decimal(10, 2)
  discountAmount Decimal?     @db.Decimal(10, 2)
  total          Decimal      @db.Decimal(10, 2)
  clientName     String
  clientEmail    String
  clientPhone    String?
  clientNIF      String?
  invoiceId      String?      @unique
  notes          String?
  internalNotes  String?
  terms          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  createdBy      String?
  items          BudgetItem[]
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice        Invoice?     @relation(fields: [invoiceId], references: [id])

  @@index([companyId])
  @@index([status])
  @@index([budgetNumber])
  @@map("budgets")
}

model BudgetItem {
  id              String         @id @default(cuid())
  budgetId        String
  order           Int            @default(0)
  itemType        BudgetItemType
  planId          String?
  extraId         String?
  description     String
  quantity        Decimal        @default(1) @db.Decimal(10, 2)
  unitPrice       Decimal        @db.Decimal(10, 2)
  discountPercent Decimal?       @db.Decimal(5, 2)
  subtotal        Decimal        @db.Decimal(10, 2)
  billingCycle    BillingCycle?
  createdAt       DateTime       @default(now())
  budget          Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  extra           Extra?         @relation(fields: [extraId], references: [id])
  plan            PlanConfig?    @relation(fields: [planId], references: [id])

  @@index([budgetId])
  @@map("budget_items")
}

model Notification {
  id            String               @id @default(cuid())
  title         String
  message       String
  type          NotificationType
  priority      NotificationPriority @default(NORMAL)
  isRead        Boolean              @default(false)
  userId        String
  senderId      String?
  companyId     String?
  metadata      Json?
  createdAt     DateTime             @default(now())
  readAt        DateTime?
  actionType    String?
  leadId        String?
  actionUrl     String?
  dueDate       DateTime?
  companies     Company?             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  company_leads CompanyLead?         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  sender        User?                @relation("NotificationSender", fields: [senderId], references: [id])
  user          User                 @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([type, priority])
  @@index([createdAt])
  @@index([isRead])
  @@map("notifications")
}

model CompanyProfileChange {
  id              String              @id @default(cuid())
  companyId       String
  type            ProfileChangeType
  status          ProfileChangeStatus @default(PENDING)
  oldValue        Json?
  newValue        Json?
  description     String?
  requestedById   String
  approvedById    String?
  rejectedById    String?
  rejectionReason String?
  createdAt       DateTime            @default(now())
  reviewedAt      DateTime?
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, status])
  @@index([type, status])
  @@index([createdAt])
  @@map("company_profile_changes")
}

model OfferCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  offers      Offer[]

  @@index([slug])
  @@index([isActive])
  @@index([order])
}

model Offer {
  id                 String              @id @default(cuid())
  title              String
  slug               String              @unique
  shortDescription   String?
  description        String
  images             String[]            @default([])
  price              Decimal?            @db.Decimal(10, 2)
  originalPrice      Decimal?            @db.Decimal(10, 2)
  currency           String              @default("EUR")
  priceType          PriceType           @default(FIXED)
  companyId          String
  categoryId         String
  status             OfferStatus         @default(DRAFT)
  publishedAt        DateTime?
  expiresAt          DateTime?
  approvedAt         DateTime?
  approvedBy         String?
  rejectedAt         DateTime?
  rejectedBy         String?
  rejectedReason     String?
  submittedAt        DateTime?
  priority           Int                 @default(0)
  featured           Boolean             @default(false)
  featuredUntil      DateTime?
  contactMethod      ContactMethod       @default(EMAIL)
  contactEmail       String?
  contactPhone       String?
  contactForm        String?
  externalUrl        String?
  requirements       String?
  benefits           String?
  duration           String?
  location           String?
  remote             Boolean             @default(false)
  tags               String[]            @default([])
  views              Int                 @default(0)
  clicks             Int                 @default(0)
  applications       Int                 @default(0)
  shares             Int                 @default(0)
  lastViewedAt       DateTime?
  seoTitle           String?
  seoDescription     String?
  seoKeywords        String[]            @default([])
  internalNotes      String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  redemptionType     RedemptionType      @default(COUPON)
  approvedByUser     User?               @relation("OfferApprovals", fields: [approvedBy], references: [id])
  category           OfferCategory       @relation(fields: [categoryId], references: [id])
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rejectedByUser     User?               @relation("OfferRejections", fields: [rejectedBy], references: [id])
  coupons            Coupon[]            @relation("OfferCoupons")
  leads              Lead[]
  events             OfferEvent[]        @relation("OfferEvents")
  redemptions        Redemption[]        @relation("OfferRedemptions")
  favorites          UserFavorite[]      @relation("OfferFavorites")
  walletTransactions WalletTransaction[]

  @@index([companyId, status])
  @@index([categoryId, status])
  @@index([status, publishedAt])
  @@index([status])
  @@index([featured, featuredUntil])
  @@index([slug])
  @@index([priority])
  @@index([expiresAt])
  @@index([createdAt])
}

model UserFavorite {
  id        String   @id @default(cuid())
  userId    String
  offerId   String
  createdAt DateTime @default(now())
  offer     Offer    @relation("OfferFavorites", fields: [offerId], references: [id], onDelete: Cascade)
  user      User     @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, offerId], name: "unique_user_offer_favorite")
  @@index([userId], map: "idx_favorite_user")
  @@index([offerId], map: "idx_favorite_offer")
  @@index([createdAt], map: "idx_favorite_created")
  @@map("user_favorites")
}

model Coupon {
  id                 String              @id @default(cuid())
  code               String              @unique
  offerId            String
  userId             String
  companyId          String
  qrCodeUrl          String?
  qrCodeData         String?
  status             CouponStatus        @default(ACTIVE)
  generatedAt        DateTime            @default(now())
  expiresAt          DateTime
  usedAt             DateTime?
  cancelledAt        DateTime?
  userAgent          String?
  ipAddress          String?
  deviceType         String?
  generatedFrom      String?
  notes              String?
  company            Company             @relation("CompanyCoupons", fields: [companyId], references: [id], onDelete: Cascade)
  offer              Offer               @relation("OfferCoupons", fields: [offerId], references: [id], onDelete: Cascade)
  user               User                @relation("UserCoupons", fields: [userId], references: [id], onDelete: Cascade)
  redemption         Redemption?         @relation("CouponRedemption")
  walletTransactions WalletTransaction[]

  @@index([offerId], map: "idx_coupon_offer")
  @@index([userId], map: "idx_coupon_user")
  @@index([companyId], map: "idx_coupon_company")
  @@index([code], map: "idx_coupon_code")
  @@index([status], map: "idx_coupon_status")
  @@index([expiresAt], map: "idx_coupon_expires")
  @@index([generatedAt], map: "idx_coupon_generated")
  @@index([status])
  @@map("coupons")
}

model Redemption {
  id                 String   @id @default(cuid())
  couponId           String   @unique
  offerId            String
  userId             String
  companyId          String
  redeemedAt         DateTime @default(now())
  redemptionType     String   @default("in_store")
  channel            String?
  location           String?
  storeId            String?
  originalPrice      Decimal? @db.Decimal(10, 2)
  discountAmount     Decimal? @db.Decimal(10, 2)
  finalPrice         Decimal? @db.Decimal(10, 2)
  currency           String   @default("EUR")
  validatedBy        String?
  validatedAt        DateTime @default(now())
  verificationMethod String?
  userAgent          String?
  ipAddress          String?
  deviceType         String?
  notes              String?
  customerNotes      String?
  receiptNumber      String?
  rating             Int?
  feedback           String?
  company            Company  @relation("CompanyRedemptions", fields: [companyId], references: [id], onDelete: Cascade)
  coupon             Coupon   @relation("CouponRedemption", fields: [couponId], references: [id], onDelete: Cascade)
  offer              Offer    @relation("OfferRedemptions", fields: [offerId], references: [id], onDelete: Cascade)
  user               User     @relation("UserRedemptions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([offerId], map: "idx_redemption_offer")
  @@index([userId], map: "idx_redemption_user")
  @@index([companyId], map: "idx_redemption_company")
  @@index([redeemedAt], map: "idx_redemption_date")
  @@index([redemptionType], map: "idx_redemption_type")
  @@map("redemptions")
}

model OfferEvent {
  id          String    @id @default(cuid())
  offerId     String
  userId      String?
  companyId   String
  eventType   EventType
  sessionId   String?
  userAgent   String?
  ipAddress   String?
  deviceType  String?
  browser     String?
  os          String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  country     String?
  city        String?
  region      String?
  latitude    Float?
  longitude   Float?
  duration    Int?
  scrollDepth Int?
  createdAt   DateTime  @default(now())
  company     Company   @relation("CompanyOfferEvents", fields: [companyId], references: [id], onDelete: Cascade)
  offer       Offer     @relation("OfferEvents", fields: [offerId], references: [id], onDelete: Cascade)
  user        User?     @relation("UserOfferEvents", fields: [userId], references: [id])

  @@index([offerId, eventType], map: "idx_event_offer_type")
  @@index([userId], map: "idx_event_user")
  @@index([companyId], map: "idx_event_company")
  @@index([eventType], map: "idx_event_type")
  @@index([createdAt], map: "idx_event_created")
  @@index([sessionId], map: "idx_event_session")
  @@index([eventType, createdAt])
  @@map("offer_events")
}

model NotificationPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique
  emailEnabled         Boolean  @default(true)
  emailCouponGenerated Boolean  @default(true)
  emailCouponUsed      Boolean  @default(true)
  emailOfferExpiring   Boolean  @default(true)
  emailNewFavorite     Boolean  @default(true)
  emailWeeklySummary   Boolean  @default(true)
  inAppEnabled         Boolean  @default(true)
  inAppCouponGenerated Boolean  @default(true)
  inAppCouponUsed      Boolean  @default(true)
  inAppOfferExpiring   Boolean  @default(true)
  inAppNewFavorite     Boolean  @default(true)
  inAppWeeklySummary   Boolean  @default(false)
  weeklySummaryDay     Int      @default(1)
  weeklySummaryHour    Int      @default(9)
  timezone             String   @default("Europe/Madrid")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation("UserNotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

model EmailLog {
  id           String        @id @default(cuid())
  userId       String
  templateType EmailTemplate
  subject      String
  toEmail      String
  fromEmail    String        @default("noreply@lapublica.es")
  status       EmailStatus   @default(PENDING)
  sentAt       DateTime?
  deliveredAt  DateTime?
  openedAt     DateTime?
  clickedAt    DateTime?
  bouncedAt    DateTime?
  errorMessage String?
  externalId   String?
  metadata     Json?
  createdAt    DateTime      @default(now())
  user         User          @relation("UserEmailLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([templateType])
  @@index([status])
  @@index([sentAt])
  @@index([toEmail])
  @@index([externalId])
  @@map("email_logs")
}

model GroupOfferRequest {
  id              String            @id @default(cuid())
  title           String
  description     String
  category        String?
  location        String?
  minParticipants Int
  maxParticipants Int?
  targetPrice     Decimal?          @db.Decimal(10, 2)
  status          RequestStatus     @default(PENDING)
  publishedAt     DateTime?
  expiresAt       DateTime?
  requesterId     String
  contactEmail    String?
  contactPhone    String?
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  groupOfferId    String?           @unique
  tags            String[]          @default([])
  priority        Int               @default(0)
  internalNotes   String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  groupOffer      GroupOfferConfig? @relation("RequestToConfig", fields: [groupOfferId], references: [id])
  requester       User              @relation("GroupOfferRequests", fields: [requesterId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([requesterId])
  @@index([category])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("group_offer_requests")
}

model GroupOfferConfig {
  id                 String             @id @default(cuid())
  title              String
  slug               String             @unique
  description        String
  shortDescription   String?
  images             String[]           @default([])
  category           String?
  tags               String[]           @default([])
  minParticipants    Int
  maxParticipants    Int
  currentCount       Int                @default(0)
  originalPrice      Decimal            @db.Decimal(10, 2)
  groupPrice         Decimal            @db.Decimal(10, 2)
  savingsAmount      Decimal            @db.Decimal(10, 2)
  savingsPercent     Float
  requiresDeposit    Boolean            @default(false)
  depositAmount      Decimal?           @db.Decimal(10, 2)
  depositPercent     Float?
  registrationStart  DateTime           @default(now())
  registrationEnd    DateTime
  serviceStart       DateTime?
  serviceEnd         DateTime?
  status             GroupOfferStatus   @default(DRAFT)
  publishedAt        DateTime?
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  companyId          String
  contactEmail       String?
  contactPhone       String?
  location           String?
  address            String?
  isOnline           Boolean            @default(false)
  meetingUrl         String?
  requirements       String?
  includes           String?
  excludes           String?
  terms              String?
  cancellationPolicy String?
  refundPolicy       String?
  seoTitle           String?
  seoDescription     String?
  seoKeywords        String[]           @default([])
  priority           Int                @default(0)
  featured           Boolean            @default(false)
  internalNotes      String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  company            Company            @relation("CompanyGroupOffers", fields: [companyId], references: [id], onDelete: Cascade)
  originRequest      GroupOfferRequest? @relation("RequestToConfig")
  participants       GroupParticipant[] @relation("ConfigParticipants")

  @@index([companyId])
  @@index([status])
  @@index([slug])
  @@index([category])
  @@index([registrationEnd])
  @@index([serviceStart])
  @@index([featured])
  @@map("group_offer_configs")
}

model GroupParticipant {
  id                 String            @id @default(cuid())
  groupOfferId       String
  userId             String
  status             ParticipantStatus @default(PENDING)
  joinedAt           DateTime          @default(now())
  confirmedAt        DateTime?
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  contactName        String?
  contactEmail       String?
  contactPhone       String?
  specialRequests    String?
  allergies          String?
  emergencyContact   String?
  notes              String?
  totalAmount        Decimal           @db.Decimal(10, 2)
  paidAmount         Decimal           @default(0) @db.Decimal(10, 2)
  pendingAmount      Decimal           @db.Decimal(10, 2)
  registrationPaid   Boolean           @default(false)
  registrationPaidAt DateTime?
  depositPaid        Boolean           @default(false)
  depositPaidAt      DateTime?
  finalPaid          Boolean           @default(false)
  finalPaidAt        DateTime?
  paymentIds         String[]          @default([])
  invoiceNumbers     String[]          @default([])
  rating             Int?
  feedback           String?
  wouldRecommend     Boolean?
  referredBy         String?
  utmSource          String?
  utmCampaign        String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  groupOffer         GroupOfferConfig  @relation("ConfigParticipants", fields: [groupOfferId], references: [id], onDelete: Cascade)
  user               User              @relation("UserGroupParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupOfferId, userId], name: "unique_group_user_participation")
  @@index([groupOfferId])
  @@index([userId])
  @@index([status])
  @@index([joinedAt])
  @@map("group_participants")
}

model UserWallet {
  id           String              @id @default(cuid())
  userId       String              @unique
  balance      Decimal             @default(0) @db.Decimal(10, 2)
  currency     String              @default("EUR")
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([userId])
  @@map("user_wallets")
}

model WalletTransaction {
  id          String     @id @default(cuid())
  walletId    String
  type        String
  amount      Decimal    @db.Decimal(10, 2)
  description String
  offerId     String?
  couponId    String?
  metadata    Json?
  createdAt   DateTime   @default(now())
  coupon      Coupon?    @relation(fields: [couponId], references: [id])
  offer       Offer?     @relation(fields: [offerId], references: [id])
  wallet      UserWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([offerId])
  @@index([type])
  @@index([createdAt])
  @@map("wallet_transactions")
}

model Lead {
  id        String   @id @default(cuid())
  offerId   String
  userId    String
  companyId String
  name      String
  email     String
  phone     String?
  message   String?
  status    String   @default("NEW")
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  offer     Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@index([userId])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("leads")
}

model CompanyLead {
  id                    String            @id @default(cuid())
  companyName           String
  cif                   String?
  sector                String?
  contactName           String?
  contactRole           String?
  email                 String?
  phone                 String?
  website               String?
  companySize           String?
  estimatedRevenue      Decimal?          @db.Decimal(10, 2)
  currentPlatforms      Json?
  competitorOffers      Json?
  discountTypes         Json?
  status                LeadStatus        @default(NEW)
  priority              LeadPriority      @default(MEDIUM)
  score                 Int?
  scoreGrade            String?
  source                LeadSource
  assignedToId          String?
  lastContactDate       DateTime?
  nextFollowUpDate      DateTime?
  convertedToCompanyId  String?           @unique
  convertedAt           DateTime?
  tags                  String[]
  notes                 String?
  internalNotes         String?
  lostReason            String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  aiInsights            Json?
  aiProcessingStatus    String?
  aiScore               Int?
  aiScoreReasoning      String?
  conversionProbability Float?
  dataQualityScore      Int?
  lastAiProcessed       DateTime?
  qualityScore          Int?
  suggestedPitch        String?
  targetAudience        String?
  aiSummary             String?
  pitchGeneratedAt      DateTime?
  validationStatus      String?
  address               String?
  city                  String?
  country               String?
  state                 String?
  zipCode               String?
  classifiedAt          DateTime?
  confidence            Float?
  description           String?
  employeeCount         Int?
  estimatedSize         String?
  facebookProfile       String?
  generationMethod      String?
  industry              String?
  linkedinProfile       String?
  rawData               Json?
  reviewStatus          String?
  scrapedAt             DateTime?
  segment               String?
  sourceId              String?
  stage                 String?
  twitterProfile        String?
  userId                String?
  validatedAt           DateTime?
  aiProviderId          String?
  employees             Int?
  estimatedValue        Decimal?          @db.Decimal(10, 2)
  assignedTo            User?             @relation("LeadAssignee", fields: [assignedToId], references: [id])
  convertedCompany      Company?          @relation("ConvertedLead", fields: [convertedToCompanyId], references: [id])
  contacts              contacts[]
  activities            LeadActivity[]
  documents             LeadDocument[]
  interactions          LeadInteraction[]
  tasks                 LeadTask[]
  notifications         Notification[]
  enterpriseTasks       Task[]

  // Relació amb checklist
  phaseChecks           LeadPhaseCheck[]

  // Relació amb recursos comercials
  resourceUsages        ResourceUsage[]

  @@index([status])
  @@index([assignedToId])
  @@index([source])
  @@index([createdAt])
  @@index([score])
  @@index([convertedAt])
  @@index([aiProcessingStatus])
  @@index([aiScore])
  @@index([dataQualityScore])
  @@index([lastAiProcessed])
  @@index([status, createdAt])
  @@map("company_leads")
}

model LeadInteraction {
  id                  String          @id @default(cuid())
  leadId              String
  userId              String
  type                InteractionType
  title               String?
  description         String
  outcome             String?
  duration            Int?
  metadata            Json?
  createdAt           DateTime        @default(now())
  contactId           String?
  nextAction          String?
  nextActionCompleted Boolean?        @default(false)
  nextActionDate      DateTime?
  contacts            contacts?       @relation(fields: [contactId], references: [id])
  lead                CompanyLead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user                User            @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([createdAt])
  @@map("lead_interactions")
}

model LeadActivity {
  id          String      @id @default(cuid())
  leadId      String
  userId      String?
  type        String
  description String
  metadata    Json?
  createdAt   DateTime    @default(now())
  lead        CompanyLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([createdAt])
  @@map("lead_activities")
}

model LeadTask {
  id          String       @id @default(cuid())
  leadId      String?
  userId      String
  title       String
  description String?
  dueDate     DateTime?
  priority    LeadPriority @default(MEDIUM)
  status      TaskStatus   @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  lead        CompanyLead? @relation(fields: [leadId], references: [id])
  user        User         @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([dueDate])
  @@index([status])
  @@map("lead_tasks")
}

model LeadDocument {
  id         String      @id @default(cuid())
  leadId     String
  userId     String
  name       String
  fileUrl    String
  fileType   String
  fileSize   Int
  uploadedAt DateTime    @default(now())
  lead       CompanyLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@map("lead_documents")
}

model Task {
  id                       String           @id @default(cuid())
  title                    String
  description              String?
  type                     TaskType
  status                   TaskStatus       @default(PENDING)
  priority                 TaskPriority
  category                 TaskCategory?
  assignedToId             String
  createdById              String
  leadId                   String?
  companyId                String?
  dueDate                  DateTime?
  startDate                DateTime?
  completedAt              DateTime?
  estimatedMinutes         Int?
  actualMinutes            Int?
  reminderDate             DateTime?
  reminderSent             Boolean          @default(false)
  isRecurring              Boolean          @default(false)
  recurrenceRule           String?
  parentRecurringId        String?
  urgencyScore             Int              @default(0)
  impactScore              Int              @default(0)
  effortScore              Int              @default(0)
  autoScore                Int              @default(0)
  parentTaskId             String?
  tags                     String[]
  customFields             Json?
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  activities               TaskActivity[]
  attachments              TaskAttachment[]
  comments                 TaskComment[]
  assignedTo               User             @relation("TasksAssigned", fields: [assignedToId], references: [id])
  company                  Company?         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy                User             @relation("TasksCreated", fields: [createdById], references: [id])
  lead                     CompanyLead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  parentTask               Task?            @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subtasks                 Task[]           @relation("TaskSubtasks")
  tasks_TaskDependencies_A Task[]           @relation("TaskDependencies")
  tasks_TaskDependencies_B Task[]           @relation("TaskDependencies")

  @@index([assignedToId])
  @@index([leadId])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  mentions  String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation("TaskComments", fields: [userId], references: [id])

  @@index([taskId])
  @@map("task_comments")
}

model TaskAttachment {
  id           String   @id @default(cuid())
  taskId       String
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  uploadedById String
  createdAt    DateTime @default(now())
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation("TaskAttachments", fields: [uploadedById], references: [id])

  @@index([taskId])
  @@map("task_attachments")
}

model TaskActivity {
  id          String             @id @default(cuid())
  taskId      String
  userId      String?
  action      TaskActivityAction
  description String
  metadata    Json?
  createdAt   DateTime           @default(now())
  task        Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User?              @relation("TaskActivities", fields: [userId], references: [id])

  @@index([taskId])
  @@index([createdAt])
  @@map("task_activities")
}

model Conversation {
  id                       String                     @id @default(dbgenerated("(gen_random_uuid())::text"))
  title                    String
  createdAt                DateTime                   @default(now()) @db.Timestamptz(6)
  updatedAt                DateTime                   @default(now()) @updatedAt @db.Timestamptz(6)
  ConversationParticipants ConversationParticipants[]
  messages                 Message[]

  @@index([updatedAt], map: "idx_conversations_updated_at")
  @@map("conversations")
}

model Message {
  id             String              @id @default(dbgenerated("(gen_random_uuid())::text"))
  content        String
  conversationId String
  senderId       String
  isRead         Boolean             @default(false)
  createdAt      DateTime            @default(now()) @db.Timestamptz(6)
  attachments    MessageAttachment[]
  conversation   Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "messages_conversation_id_fkey")
  sender         User                @relation("MessageSender", fields: [senderId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "messages_sender_id_fkey")

  @@index([conversationId, createdAt], map: "idx_messages_conversation_created")
  @@index([conversationId], map: "idx_messages_conversation_id")
  @@index([createdAt], map: "idx_messages_created_at")
  @@index([senderId], map: "idx_messages_sender_id")
  @@map("messages")
}

model MessageAttachment {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  messageId String
  filename  String
  url       String
  mimeType  String
  size      Int?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "message_attachments_message_id_fkey")

  @@index([messageId], map: "idx_message_attachments_message_id")
  @@map("message_attachments")
}

model ConversationParticipants {
  A             String
  B             String
  conversations Conversation @relation(fields: [A], references: [id], onDelete: Cascade)
  User          User         @relation(fields: [B], references: [id], onDelete: Cascade)

  @@unique([A, B], map: "_ConversationParticipants_AB_unique")
  @@index([B], map: "_ConversationParticipants_B_index")
  @@map("_ConversationParticipants")
}

/// Proveïdor d'IA configurat
model AIProvider {
  id                  String            @id @default(cuid())
  type                AIProviderType    @unique
  name                String
  isActive            Boolean           @default(true)
  apiKeyEncrypted     String?
  useEnvKey           Boolean           @default(true)
  maxTokensPerRequest Int               @default(4000)
  maxTokensPerDay     Int?
  maxTokensPerMonth   Int?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  createdBy           String?
  configurations      AIConfiguration[]
  models              AIModel[]
  usageLogs           AIUsageLog[]

  @@map("ai_providers_config")
}

/// Models disponibles per cada proveïdor
model AIModel {
  id               String            @id @default(cuid())
  providerId       String
  modelId          String
  displayName      String
  description      String?
  isActive         Boolean           @default(true)
  maxContextTokens Int               @default(128000)
  maxOutputTokens  Int               @default(4096)
  supportsVision   Boolean           @default(false)
  supportsTools    Boolean           @default(true)
  inputCostPer1M   Float?
  outputCostPer1M  Float?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  configurations   AIConfiguration[]
  provider         AIProvider        @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, modelId])
  @@map("ai_models_config")
}

/// Configuració d'IA per cada cas d'ús
model AIConfiguration {
  id                String     @id @default(cuid())
  useCase           AIUseCase  @unique
  name              String
  description       String?
  isActive          Boolean    @default(true)
  providerId        String
  modelId           String
  temperature       Float      @default(0.7)
  maxTokens         Int        @default(2000)
  maxRequestsPerDay Int?
  maxTokensPerDay   Int?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  updatedBy         String?
  model             AIModel    @relation(fields: [modelId], references: [id])
  provider          AIProvider @relation(fields: [providerId], references: [id])

  @@map("ai_configurations_v2")
}

/// Registre d'ús de la IA
model AIUsageLog {
  id            String     @id @default(cuid())
  providerId    String
  useCase       AIUseCase
  modelId       String
  inputTokens   Int
  outputTokens  Int
  totalTokens   Int
  estimatedCost Float?
  userId        String?
  userEmail     String?
  success       Boolean    @default(true)
  errorMessage  String?
  durationMs    Int?
  createdAt     DateTime   @default(now())
  provider      AIProvider @relation(fields: [providerId], references: [id])

  @@index([providerId, createdAt])
  @@index([useCase, createdAt])
  @@index([userId, createdAt])
  @@map("ai_usage_logs_v2")
}

model ai_logs {
  id           String       @id
  providerId   String
  operation    String
  success      Boolean
  latency      Int?
  cost         Decimal?     @db.Decimal(10, 4)
  createdAt    DateTime     @default(now())
  ai_providers ai_providers @relation(fields: [providerId], references: [id])
}

model ai_providers {
  id                 String         @id
  name               String         @unique
  displayName        String
  type               String
  config             Json
  capabilities       Json?
  isActive           Boolean        @default(true)
  isDefault          Boolean        @default(false)
  totalRequests      Int            @default(0)
  successfulRequests Int            @default(0)
  failedRequests     Int            @default(0)
  totalCost          Decimal?       @db.Decimal(10, 4)
  averageLatency     Float?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime
  ai_logs            ai_logs[]
  lead_sources       lead_sources[]
}

model announcement_reads {
  id             String        @id
  announcementId String
  userId         String
  readAt         DateTime      @default(now())
  announcements  announcements @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  User           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
}

model announcements {
  id                 String               @id
  title              String
  content            String
  type               String               @default("INFO")
  priority           Int                  @default(0)
  startDate          DateTime?
  endDate            DateTime?
  isActive           Boolean              @default(true)
  targetAudience     String?
  createdBy          String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  configuration      Json?
  isPinned           Boolean              @default(false)
  scope              String?
  targets            Json?
  expiresAt          DateTime?
  userId             String?
  status             String               @default("approved")
  isRead             Boolean              @default(false)
  announcement_reads announcement_reads[]
  User               User?                @relation(fields: [userId], references: [id])
}

model company_advisory {
  id              String    @id
  companyId       String
  title           String
  description     String?
  category        String?
  duration        String?
  price           Decimal?  @db.Decimal(10, 2)
  contact         Json?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  requestDate     DateTime?
  serviceId       String?
  status          String    @default("pending")
  urgency         String?
  clientId        String?
  response        String?
  finalBudget     Decimal?  @db.Decimal(10, 2)
  subject         String?
  estimatedBudget Decimal?  @db.Decimal(10, 2)
  responseDate    DateTime?
  deadline        DateTime?
  companies       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model company_products {
  id          String   @id
  companyId   String
  name        String
  description String?
  category    String?
  price       Decimal? @db.Decimal(10, 2)
  images      String[] @default([])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  features    Json?
  isAvailable Boolean  @default(true)
  order       Int      @default(0)
  stock       Int?
  subcategory String?
  companies   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model company_ratings {
  id         String   @id
  companyId  String
  userId     String
  rating     Int
  comment    String?
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  isActive   Boolean  @default(true)
  serviceId  String?
  advisoryId String?
  companies  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
}

model company_services {
  id           String   @id
  companyId    String
  name         String
  description  String?
  category     String?
  subcategory  String?
  price        Decimal? @db.Decimal(10, 2)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  availability Json?
  features     Json?
  pricing      Json?
  duration     String?
  modality     String?
  order        Int      @default(0)
  companies    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model contacts {
  id                String            @id
  companyLeadId     String?
  companyId         String?
  firstName         String
  lastName          String?
  email             String?
  phone             String?
  position          String?
  department        String?
  notes             String?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  isPrimary         Boolean           @default(false)
  name              String?
  linkedin          String?
  companies         Company?          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  company_leads     CompanyLead?      @relation(fields: [companyLeadId], references: [id], onDelete: Cascade)
  lead_interactions LeadInteraction[]
}

model contenido_maestro {
  id                      String                    @id
  title                   String
  content                 String
  type                    String
  category                String?
  isActive                Boolean                   @default(true)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  tipo                    String?
  tituloOriginal          String?
  contenidoOriginal       String?
  extracto                String?
  idiomaOrigen            String?
  autorId                 String?
  autorNombre             String?
  estado                  String?
  metadatos               Json?
  publicaciones_comunidad publicaciones_comunidad[]
  traducciones            traducciones[]
}

model contents {
  id          String    @id
  title       String
  slug        String    @unique
  type        String    @default("ARTICLE")
  body        String
  excerpt     String?
  author      String
  status      String    @default("DRAFT")
  publishedAt DateTime?
  tags        String[]  @default([])
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
}

model courses {
  id            String   @id
  title         String
  description   String?
  instructor    String
  duration      String?
  price         Decimal? @db.Decimal(10, 2)
  level         String   @default("BEGINNER")
  category      String?
  isActive      Boolean  @default(true)
  tags          String[] @default([])
  configuration Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
}

model custom_fields {
  id         String   @id
  entityType String
  entityId   String
  fieldName  String
  fieldValue Json
  fieldType  String
  isRequired Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  isActive   Boolean  @default(true)

  @@index([entityType, entityId])
}

model Employee {
  id                  String            @id @default(cuid())
  userId              String            @unique
  companyId           String?
  nick                String?
  firstName           String?
  lastName            String?
  dni                 String?
  jobTitle            String?
  department          String?
  organization        String?
  community           String?
  administrationType  AdministrationType?
  province            String?
  city                String?
  avatar              String?
  generalInfo         String?
  skills              String?
  workExperience      String?
  socialNetworks      Json?
  bio                 String?
  privacySettings     Json?
  canBeGroupAdmin     Boolean           @default(false)
  canBeGroupModerator Boolean           @default(false)
  canBeContentManager Boolean           @default(false)
  customFields        String?
  customFieldsPrivacy String?
  startDate           DateTime?
  endDate             DateTime?
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("employees")
}

model events {
  id            String   @id
  title         String
  description   String?
  startDate     DateTime
  endDate       DateTime
  location      String?
  type          String   @default("GENERAL")
  isActive      Boolean  @default(true)
  organizer     String
  capacity      Int?
  configuration Json?
  tags          String[] @default([])
  createdAt     DateTime @default(now())
  updatedAt     DateTime
}

model forum_moderators {
  id          String   @id
  forumId     String
  userId      String
  permissions String[] @default([])
  assignedAt  DateTime @default(now())
  assignedBy  String
  isActive    Boolean  @default(true)
  role        String?

  @@unique([forumId, userId])
}

model forum_replies {
  id           String       @id
  topicId      String
  content      String
  authorId     String
  isAccepted   Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  isActive     Boolean      @default(true)
  userId       String?
  replyToId    String?
  forum_topics forum_topics @relation(fields: [topicId], references: [id])
}

model forum_topics {
  id            String          @id
  forumId       String
  title         String
  content       String
  authorId      String
  views         Int             @default(0)
  isPinned      Boolean         @default(false)
  isLocked      Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  tags          String[]        @default([])
  lastActivity  DateTime?
  userId        String?
  isActive      Boolean         @default(true)
  type          String?
  forum_replies forum_replies[]
  forums        forums          @relation(fields: [forumId], references: [id])
}

model forums {
  id            String         @id
  name          String
  description   String?
  slug          String         @unique
  isActive      Boolean        @default(true)
  order         Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  title         String?
  configuration Json?
  type          String?
  creatorId     String?
  isLocked      Boolean        @default(false)
  category      String?
  comunidadSlug String?
  isPinned      Boolean        @default(false)
  forum_topics  forum_topics[]
}

model group_members {
  id            String   @id
  groupId       String
  userId        String
  role          String   @default("MEMBER")
  joinedAt      DateTime @default(now())
  updatedAt     DateTime
  configuration Json?
  tags          String[] @default([])
  status        String   @default("ACTIVE")

  @@unique([groupId, userId])
}

model group_posts {
  id          String    @id
  groupId     String
  authorId    String
  content     String
  attachments Json?
  likes       Int       @default(0)
  comments    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  multimedia  Json?
  publishedAt DateTime?
  tags        String[]  @default([])
  title       String?
  userId      String?
  isActive    Boolean   @default(true)
}

model groups {
  id            String   @id
  name          String
  description   String?
  slug          String   @unique
  type          String   @default("PUBLIC")
  isActive      Boolean  @default(true)
  createdBy     String
  configuration Json?
  tags          String[] @default([])
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  creatorId     String?
}

model interactions {
  id                  String    @id
  entityType          String
  entityId            String
  userId              String
  type                String
  content             Json?
  metadata            Json?
  createdAt           DateTime  @default(now())
  companyId           String?
  companyLeadId       String?
  nextActionCompleted Boolean   @default(false)
  subject             String?
  outcome             String?
  createdById         String?
  nextAction          String?
  nextActionDate      DateTime?
  contactId           String?

  @@index([entityType, entityId])
  @@index([userId])
}

model lead_sources {
  id                 String        @id
  name               String
  type               String
  searchQuery        String?
  config             Json?
  isActive           Boolean       @default(true)
  frequency          String?
  userId             String
  providerId         String?
  leadsGenerated     Int           @default(0)
  lastRun            DateTime?
  lastRunLeadsCount  Int?
  totalRuns          Int           @default(0)
  averageLeadsPerRun Float?
  nextRun            DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime
  ai_providers       ai_providers? @relation(fields: [providerId], references: [id])
}

model multimedia {
  id         String   @id
  type       String
  url        String
  filename   String?
  mimeType   String?
  size       Int?
  entityType String?
  entityId   String?
  uploadedBy String
  isPublic   Boolean  @default(true)
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@index([entityType, entityId])
  @@index([uploadedBy])
}

model post_comments {
  id        String   @id
  postId    String
  content   String
  authorId  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model post_reports {
  id          String    @id
  postId      String
  userId      String
  reason      String
  description String?
  status      String    @default("PENDING")
  moderatedBy String?
  moderatedAt DateTime?
  action      String?
  createdAt   DateTime  @default(now())

  @@unique([postId, userId])
}

model posts {
  id        String   @id
  title     String
  content   String
  authorId  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model publicaciones_comunidad {
  id                String             @id
  title             String
  content           String
  authorId          String
  comunidadId       String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  contenidoId       String?
  traduccionId      String?
  comunidadSlug     String?
  idioma            String?
  publicado         Boolean            @default(false)
  fechaPublicacion  DateTime?
  slug              String?
  urlPublica        String?
  contenido_maestro contenido_maestro? @relation(fields: [contenidoId], references: [id], onDelete: Cascade)
  traducciones      traducciones?      @relation(fields: [traduccionId], references: [id])
}

model reports {
  id          String    @id
  entityType  String
  entityId    String
  reporterId  String
  reason      String
  description String?
  status      String    @default("PENDING")
  reviewedBy  String?
  reviewedAt  DateTime?
  resolution  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime

  @@index([entityType, entityId])
  @@index([reporterId])
  @@index([status])
}

model traducciones {
  id                      String                    @id
  language                String
  key                     String
  value                   String
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  contenidoId             String?
  idiomaDestino           String?
  tituloTraducido         String?
  contenidoTraducido      String?
  extractoTraducido       String?
  estadoTraduccion        String?
  traducidoPor            String?
  confianzaTraduccion     Float?
  publicaciones_comunidad publicaciones_comunidad[]
  contenido_maestro       contenido_maestro?        @relation(fields: [contenidoId], references: [id], onDelete: Cascade)

  @@unique([language, key])
}

model user_notifications {
  id        String   @id
  userId    String
  title     String
  content   String
  type      String   @default("INFO")
  isRead    Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([userId, isRead])
}

/// Proveïdors d'IA disponibles
enum AIProviderType {
  OPENAI
  ANTHROPIC
  GEMINI
}

/// Casos d'ús de la IA
enum AIUseCase {
  LEADS
  CONTENT
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  ADMIN_GESTIO
  ADMIN_ADMINISTRACIONS
  CRM_COMERCIAL
  CRM_CONTINGUT
  CRM_ADMINISTRACIONS
  GESTOR_ESTANDARD
  GESTOR_ESTRATEGIC
  GESTOR_ENTERPRISE
  MODERATOR
  COMPANY
  USER
  COMPANY_MANAGER
  GESTOR_EMPRESAS
  ADMINISTRADOR_GRUPO
  EMPLEADO_PUBLICO
  ADMINISTRACION_PUBLICA
  COMMUNITY_MANAGER
  ADMINISTRATION
}

enum AnuncioType {
  GENERAL
  URGENT
  EVENT
  MAINTENANCE
  NEWS
  ALERT
  PROMOTION
  REGULATION
}

enum AnuncioStatus {
  DRAFT
  PENDING
  PUBLISHED
  ARCHIVED
  EXPIRED
}

enum AudienceType {
  ALL
  EMPLOYEES
  COMPANIES
  SPECIFIC
  COMMUNITY
}

enum NotificationChannel {
  PLATFORM
  EMAIL
  SMS
  PUSH
  ALL_CHANNELS
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

enum UserType {
  EMPLOYEE
  COMPANY_OWNER
  COMPANY_MEMBER
  ACCOUNT_MANAGER
  ADMIN
}

enum CompanyRole {
  OWNER
  MEMBER
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  CASH
  CHECK
  SEPA_DIRECT_DEBIT
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum ExtraCategory {
  WEB_MAINTENANCE
  BRANDING
  MARKETING
  SEO
  CONTENT
  CONSULTING
  TRAINING
  DEVELOPMENT
  SUPPORT
  OTHER
}

enum PriceType {
  FIXED
  MONTHLY
  ANNUAL
  HOURLY
  CUSTOM
}

enum BudgetStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
  INVOICED
}

enum BudgetItemType {
  PLAN
  EXTRA
  CUSTOM
  DISCOUNT
}

enum BillingCycle {
  MONTHLY
  ANNUAL
  ONE_TIME
}

enum InvoiceItemType {
  PLAN
  EXTRA
  UPGRADE
  PRORATED
  DISCOUNT
  CUSTOM
}

enum InvoiceType {
  REGULAR
  PROFORMA
  RECURRING
  UPGRADE
  ADJUSTMENT
  REFUND
}

enum CompanyStatus {
  PENDING
  PUBLISHED
  REJECTED
  SUSPENDED
  INACTIVE
  APPROVED
}

enum NotificationType {
  COMPANY_PENDING
  COMPANY_APPROVED
  COMPANY_REJECTED
  PROFILE_CHANGE
  GENERAL
  SYSTEM
  COUPON_GENERATED
  COUPON_USED
  OFFER_EXPIRING
  NEW_FAVORITE
  WEEKLY_SUMMARY
  LEAD_VERIFIED
  COMPANY_ASSIGNED
  COMPANY_COMPLETED
  COMPANY_PUBLISHED
  NEW_MESSAGE
  TASK_ASSIGNED
  PAYMENT_RECEIVED
  PLAN_EXPIRING
  INFO
  WARNING
  SUCCESS
}

enum ProfileChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProfileChangeType {
  COMPANY_DATA
  CONTACT_INFO
  LOGO
  DESCRIPTION
  OTHER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum PlanTier {
  PIONERES
  STANDARD
  STRATEGIC
  ENTERPRISE
  CUSTOM
}

enum OfferStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
  PAUSED
  EXPIRED
  ARCHIVED
}

enum RedemptionType {
  COUPON
  ONLINE
  VIP_ACCOUNT
  CONTACT_FORM
}

enum ContactMethod {
  EMAIL
  PHONE
  FORM
  EXTERNAL
  WHATSAPP
}

enum CouponStatus {
  ACTIVE
  USED
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum EventType {
  VIEW
  DETAIL_VIEW
  CLICK
  SHARE
  FAVORITE_ADD
  FAVORITE_REMOVE
  COUPON_VIEW
  COUPON_GENERATED
  COUPON_DOWNLOADED
  COUPON_SHARED
  COUPON_USED
  EXTERNAL_CLICK
  CONTACT_CLICK
  PHONE_CLICK
  EMAIL_CLICK
  MAP_VIEW
  GALLERY_VIEW
}

enum EmailTemplate {
  COUPON_GENERATED
  COUPON_USED
  OFFER_EXPIRING
  NEW_FAVORITE
  WEEKLY_SUMMARY
  WELCOME
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum AuditAction {
  COMPANY_APPROVED
  COMPANY_REJECTED
  COMPANY_SUSPENDED
  COMPANY_REACTIVATED
  COMPANY_DELETED
  COMPANY_UPDATED
  OFFER_APPROVED
  OFFER_REJECTED
  OFFER_DELETED
  OFFER_FEATURED
  OFFER_UNFEATURED
  OFFER_UPDATED
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_SUSPENDED
  USER_REACTIVATED
  USER_ROLE_CHANGED
  COUPON_CANCELLED
  COUPON_BULK_EXPORT
  SETTINGS_UPDATED
  PLAN_CONFIG_UPDATED
  BULK_ACTION
  LOGIN_ADMIN
  LOGOUT_ADMIN
  PERMISSION_CHANGED
  OTHER
}

enum LogSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum GroupOfferStatus {
  DRAFT
  PUBLISHED
  PAUSED
  COMPLETED
  CANCELLED
  EXPIRED
}

enum ParticipantStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
}

enum PaymentStage {
  REGISTRATION
  DEPOSIT
  FINAL
  FULL
}

enum LeadStatus {
  NEW
  PROSPECTING
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  PENDING_CRM        // Pendent verificació CRM (Gestor ha completat, espera CRM)
  CRM_APPROVED       // Aprovat per CRM, pendent Admin
  PENDING_ADMIN      // Pendent contractació Admin (CRM ha verificat, espera Admin)
  NEGOTIATION
  DOCUMENTATION
  WON
  LOST
  ON_HOLD
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LeadSource {
  MANUAL
  WEB_FORM
  AI_PROSPECTING
  REFERRAL
  EMPLOYEE_SUGGESTION
  INBOUND
  COLD_OUTREACH
}

enum InteractionType {
  NOTE
  CALL
  EMAIL
  MEETING
  WHATSAPP
  STATUS_CHANGE
  DOCUMENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskType {
  FOLLOW_UP
  MEETING
  CALL
  EMAIL
  DEMO
  PROPOSAL
  CONTRACT
  ONBOARDING
  SUPPORT
  INTERNAL
  OTHER
}

enum TaskPriority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

enum TaskCategory {
  SALES
  MARKETING
  SUPPORT
  OPERATIONS
  ADMIN
  DEVELOPMENT
}

enum TaskActivityAction {
  CREATED
  UPDATED
  ASSIGNED
  STATUS_CHANGED
  PRIORITY_CHANGED
  COMMENT_ADDED
  COMPLETED
  REOPENED
  DELETED
  ATTACHMENT_ADDED
}


// ============================================
// CHECKLIST SISTEMA
// ============================================

// Definició dels checks per fase (configuració)
model PhaseCheckDefinition {
  id          String   @id @default(cuid())
  phase       String   // NEW, CONTACTED, QUALIFIED, etc.
  order       Int      // Ordre dins la fase
  title       String   // Títol del check
  description String   @db.Text // Descripció/instruccions
  isRequired  Boolean  @default(true) // Obligatori per avançar?

  // Enllaç a recurs
  resourceType  String?  // 'eines' | 'external' | null
  resourceId    String?  // ID del recurs Eines (si aplica)
  externalUrl   String?  // URL externa (si aplica)
  externalLabel String?  // Text del link extern

  // Rols que han de completar aquest check
  allowedRoles  String[] // ['GESTOR_ESTANDARD', 'CRM_COMERCIAL', etc.]

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relació amb els checks completats
  completedChecks LeadPhaseCheck[]

  @@index([phase])
  @@map("phase_check_definitions")
}

// Registre de checks completats per lead
model LeadPhaseCheck {
  id              String   @id @default(cuid())
  leadId          String
  checkDefinitionId String

  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  completedById   String?
  notes           String?  @db.Text // Notes opcionals del gestor

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacions
  lead            CompanyLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  checkDefinition PhaseCheckDefinition @relation(fields: [checkDefinitionId], references: [id])
  completedBy     User? @relation(fields: [completedById], references: [id])

  @@unique([leadId, checkDefinitionId])
  @@index([leadId])
  @@map("lead_phase_checks")
}

// ============================================
// CATÀLEG EINES (Recursos)
// ============================================

// Categories de recursos
model EinesCategory {
  id          String   @id @default(cuid())
  name        String   // "Speeches", "Plantilles Correu", etc.
  slug        String   @unique // "speeches", "correus", etc.
  description String?
  icon        String?  // Icona Material Design
  order       Int      @default(0)

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  resources   EinesResource[]

  @@map("eines_categories")
}

// Recursos individuals
model EinesResource {
  id          String   @id @default(cuid())
  categoryId  String

  title       String   // "Trucada inicial de presentació"
  slug        String   @unique // "trucada-inicial"
  summary     String   @db.Text // Resum curt
  content     String   @db.Text // Contingut complet amb variables {{empresa}}, {{contacte}}

  // Metadades
  tags        String[] // Per cercar
  isTemplate  Boolean  @default(true) // Té variables per substituir?

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  updatedById String?

  category    EinesCategory @relation(fields: [categoryId], references: [id])
  createdBy   User? @relation("EinesCreatedBy", fields: [createdById], references: [id])
  updatedBy   User? @relation("EinesUpdatedBy", fields: [updatedById], references: [id])

  @@index([categoryId])
  @@map("eines_resources")
}

enum PermissionType {
  MANAGE_USERS
  MANAGE_ROLES
  MANAGE_PERMISSIONS
  VIEW_ADMIN_DASHBOARD
  MANAGE_SYSTEM_CONFIG
  CREATE_CONTENT
  EDIT_CONTENT
  DELETE_CONTENT
  PUBLISH_CONTENT
  MODERATE_CONTENT
  PIN_CONTENT
  CREATE_POST
  EDIT_POST
  DELETE_POST
  MODERATE_POST
  PIN_POST
  CREATE_COMMENT
  EDIT_COMMENT
  DELETE_COMMENT
  MODERATE_COMMENT
  CREATE_GROUP
  EDIT_GROUP
  DELETE_GROUP
  MANAGE_GROUP_MEMBERS
  MODERATE_GROUP_CONTENT
  PIN_GROUP_CONTENT
  CREATE_FORUM
  EDIT_FORUM
  DELETE_FORUM
  CREATE_FORUM_TOPIC
  EDIT_FORUM_TOPIC
  DELETE_FORUM_TOPIC
  MODERATE_FORUM
  PIN_FORUM_TOPIC
  LOCK_FORUM_TOPIC
  CREATE_ANNOUNCEMENT
  EDIT_ANNOUNCEMENT
  DELETE_ANNOUNCEMENT
  PUBLISH_ANNOUNCEMENT
  PIN_ANNOUNCEMENT
  MANAGE_COMPANIES
  CREATE_COMPANY_PROFILE
  EDIT_COMPANY_PROFILE
  MANAGE_COMPANY_SERVICES
  MANAGE_PUBLIC_ADMINISTRATIONS
  CREATE_ADMIN_PROFILE
  EDIT_ADMIN_PROFILE
  VIEW_REPORTS
  HANDLE_REPORTS
  VIEW_MODERATION_STATS
  BULK_MODERATE
  IMPERSONATE_USER
  VIEW_AUDIT_LOGS
  MANAGE_TRANSLATIONS
  MANAGE_COMMUNITIES
}

// ═══════════════════════════════════════════════════════════════
// SISTEMA DE RECURSOS COMERCIALS (NUEVOS MODELS)
// ═══════════════════════════════════════════════════════════════

enum ResourceType {
  SPEECH           // Script de trucada
  EMAIL_TEMPLATE   // Plantilla de correu
  DOCUMENT         // Precontracte, proposta
  GUIDE            // Guia o manual
  VIDEO            // Vídeo formatiu
  CHECKLIST        // Llista de verificació
}

enum PipelinePhase {
  PROSPECCIO
  NEGOCIACIO
  TANCAMENT
  POST_VENDA
  ALL
}

enum ResourceCategory {
  TRUCADA_INICIAL
  SEGUIMENT
  PRESENTACIO_PLANS
  NEGOCIACIO_PREUS
  TANCAMENT_VENDA
  DOCUMENTACIO
  OBJECIONS
  ONBOARDING
}

model CommercialResource {
  id          String           @id @default(cuid())
  slug        String           @unique
  title       String
  description String           @db.Text
  type        ResourceType
  phase       PipelinePhase
  category    ResourceCategory
  content     Json             // Contingut estructurat segons tipus
  tags        String[]         // Array de tags
  order       Int              @default(0)
  isActive    Boolean          @default(true)

  // Metadades
  createdById String
  updatedById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relacions
  createdBy   User             @relation("ResourceCreator", fields: [createdById], references: [id])
  updatedBy   User?            @relation("ResourceUpdater", fields: [updatedById], references: [id])

  // Historial d'ús pels gestors
  usageHistory ResourceUsage[]

  @@index([type])
  @@index([phase])
  @@index([category])
  @@index([isActive])
  @@map("commercial_resources")
}

// Registre d'ús de recursos pels gestors
model ResourceUsage {
  id          String             @id @default(cuid())
  resourceId  String
  userId      String             // Gestor que l'ha usat
  leadId      String?            // Lead per al qual s'ha usat (opcional)
  action      String             // 'view', 'copy', 'extract', 'send_email'
  extractedContent Json?         // Contingut personalitzat generat
  createdAt   DateTime           @default(now())

  resource    CommercialResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead        CompanyLead?       @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([resourceId])
  @@index([userId])
  @@index([leadId])
  @@index([createdAt])
  @@map("resource_usage")
}



model PublicAdministration {
  id                  String            @id @default(cuid())
  userId              String            @unique
  name                String
  administrationType  AdministrationType
  community           String?
  province            String?
  city                String?
  address             String?
  phone               String?
  email               String?
  website             String?
  description         String?
  citizenServices     String?
  departments         String?
  publicHours         String?
  contactInfo         String?
  customFields        String?
  customFieldsPrivacy String?
  isVerified          Boolean           @default(false)
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("public_administrations")
}


enum AdministrationType {
  LOCAL
  AUTONOMICA
  CENTRAL
}

// =============================================
// SISTEMA DINÀMIC DE ROLS I PERMISOS
// =============================================

// Rol del sistema (predefinit o personalitzat)
model Role {
  id          String   @id @default(cuid())
  name        String   @unique  // "GESTOR_GESTIO" (clau única)
  label       String            // "Gestor Gestió" (nom visible)
  description String?
  
  // Estil UI
  color       String   @default("slate")  // blue, red, green, etc.
  icon        String   @default("Users")  // Nom icona Lucide
  
  // Configuració
  dashboard   String?           // "/gestio/", "/admin/", "/empresa/", etc.
  isSystem    Boolean  @default(false)  // true = no es pot eliminar ni modificar nom
  isActive    Boolean  @default(true)
  
  // Si és copiat d'un altre rol
  copiedFromId String?
  copiedFrom   Role?   @relation("RoleCopies", fields: [copiedFromId], references: [id], onDelete: SetNull)
  copies       Role[]  @relation("RoleCopies")
  
  // Metadades
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  
  // Relacions
  permissions RolePermission[]
  users       User[]           @relation("UserCustomRole")
  
  @@index([isActive])
  @@index([isSystem])
  @@map("roles")
}

// Categoria de permisos
model PermissionCategory {
  id          String       @id @default(cuid())
  name        String       @unique  // "users", "companies", etc.
  label       String                // "Usuaris", "Empreses", etc.
  icon        String       @default("Settings")  // Nom icona Lucide
  order       Int          @default(0)
  
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  
  permissions Permission[]
  
  @@map("permission_categories")
}

// Permís del sistema
model Permission {
  id          String   @id @default(cuid())
  key         String   @unique  // "MANAGE_USERS"
  label       String            // "Gestionar usuaris"
  description String?
  
  categoryId  String
  category    PermissionCategory @relation(fields: [categoryId], references: [id])
  
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  roles       RolePermission[]
  
  @@index([categoryId])
  @@map("permissions")
}

// Relació Rol <-> Permís (many-to-many)
model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  grantedAt    DateTime   @default(now())
  grantedById  String?
  
  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// =============================================
// SISTEMA DINÀMIC DE CATEGORIES
// =============================================

// Components del sistema que suporten categorització
// Es registren automàticament quan es creen nous mòduls
model SystemComponent {
  id                    String   @id @default(cuid())
  code                  String   @unique  // "OFFERS", "COMPANIES", "FORUMS", etc.
  name                  String            // "Ofertes", "Empreses", "Fòrums"
  namePlural            String            // "Ofertes", "Empreses", "Fòrums"
  description           String?
  icon                  String   @default("Box")  // Nom icona Lucide
  color                 String   @default("slate")
  
  // Configuració
  supportsCategorization Boolean @default(true)
  isCore                Boolean  @default(false)  // true = sistema, no es pot eliminar
  isActive              Boolean  @default(true)
  
  // Metadades
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relacions
  categoryScopes        CategoryScopeComponent[]
  
  @@index([code])
  @@index([isActive, supportsCategorization])
  @@map("system_components")
}

// Tipus/Scopes de categories (agrupació)
// Exemple: "Empreses i Ofertes", "Fòrums", "Anuncis"
model CategoryScope {
  id          String   @id @default(cuid())
  name        String   @unique  // "empreses-ofertes", "forums", "anuncis"
  label       String            // "Empreses i Ofertes", "Fòrums", "Anuncis"
  description String?
  icon        String   @default("Folder")
  color       String   @default("slate")
  
  // Configuració
  order       Int      @default(0)
  isSystem    Boolean  @default(false)  // true = creat pel sistema, no eliminar
  isActive    Boolean  @default(true)
  
  // Metadades
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  
  // Relacions
  components  CategoryScopeComponent[]
  categories  Category[]
  
  @@index([isActive])
  @@index([order])
  @@map("category_scopes")
}

// Relació N:M entre CategoryScope i SystemComponent
// Un scope pot tenir múltiples components (ex: "Empreses i Ofertes" té OFFERS i COMPANIES)
model CategoryScopeComponent {
  id            String          @id @default(cuid())
  scopeId       String
  componentId   String
  
  scope         CategoryScope   @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  component     SystemComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime        @default(now())
  
  @@unique([scopeId, componentId])
  @@index([scopeId])
  @@index([componentId])
  @@map("category_scope_components")
}

// Categories individuals
model Category {
  id          String        @id @default(cuid())
  scopeId     String
  scope       CategoryScope @relation(fields: [scopeId], references: [id], onDelete: Cascade)
  
  name        String
  slug        String
  description String?
  icon        String?
  color       String        @default("slate")
  image       String?       // URL imatge opcional
  
  // Configuració
  order       Int           @default(0)
  isActive    Boolean       @default(true)
  isFeatured  Boolean       @default(false)
  
  // Jerarquia (subcategories) - Opcional per futur
  parentId    String?
  parent      Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[]    @relation("CategoryHierarchy")
  
  // Metadades
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdById String?
  
  // Relacions amb altres entitats (afegir segons necessitat)
  // offers      Offer[]      // Descomentar quan es faci la migració
  // companies   Company[]
  // forumTopics ForumTopic[]
  // etc.
  
  @@unique([scopeId, slug])
  @@index([scopeId, isActive])
  @@index([scopeId, order])
  @@index([parentId])
  @@map("categories")
}

// =============================================
// SISTEMA DE CAMPANYES
// =============================================

// Tipus de campanya
enum CampaignType {
  EMAIL           // Email màrqueting
  PUSH            // Notificacions push
  SMS             // Missatges SMS
  BANNER          // Banners dins la plataforma
  FEATURED        // Anuncis/ofertes destacades
  ANNOUNCEMENT    // Comunicats oficials
}

// Estat de la campanya
enum CampaignStatus {
  DRAFT           // Esborrany
  SCHEDULED       // Programada
  ACTIVE          // Activa/Enviant
  PAUSED          // Pausada
  COMPLETED       // Completada
  CANCELLED       // Cancel·lada
}

// Tipus de segmentació
enum SegmentationType {
  ALL             // Tots els usuaris
  ADMINISTRATION  // Per administració
  SECTOR          // Per sector/categoria
  SUBSCRIPTION    // Per tipus de subscripció
  CUSTOM          // Personalitzada (llista d'IDs)
  BEHAVIOR        // Per comportament (actius, inactius, etc.)
}

// Campanya principal
model Campaign {
  id              String            @id @default(cuid())
  
  // Informació bàsica
  name            String
  slug            String            @unique
  description     String?
  type            CampaignType
  status          CampaignStatus    @default(DRAFT)
  
  // Contingut
  subject         String?           // Assumpte (email/push)
  content         String?           // Contingut principal (HTML o text)
  contentPlain    String?           // Versió text pla (emails)
  ctaText         String?           // Text del botó CTA
  ctaUrl          String?           // URL del CTA
  imageUrl        String?           // Imatge principal
  
  // Segmentació
  segmentationType SegmentationType @default(ALL)
  segmentationData Json?            // Dades de segmentació (IDs, filtres, etc.)
  
  // Programació
  scheduledAt     DateTime?         // Data programada d'enviament
  startDate       DateTime?         // Data inici (banners)
  endDate         DateTime?         // Data fi (banners)
  isRecurring     Boolean           @default(false)
  recurringRule   String?           // Regla de recurrència (cron o similar)
  
  // Configuració
  priority        Int               @default(0)  // Prioritat per ordenar
  isActive        Boolean           @default(true)
  
  // Opcions específiques per tipus
  settings        Json?             // Configuració addicional (posició banner, etc.)
  
  // Mètriques
  totalRecipients Int               @default(0)
  sent            Int               @default(0)
  delivered       Int               @default(0)
  opened          Int               @default(0)
  clicked         Int               @default(0)
  converted       Int               @default(0)
  bounced         Int               @default(0)
  unsubscribed    Int               @default(0)
  
  // Metadades
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdById     String?
  createdBy       User?             @relation("CampaignCreator", fields: [createdById], references: [id])
  
  // Relacions
  recipients      CampaignRecipient[]
  events          CampaignEvent[]
  
  @@index([type, status])
  @@index([status, scheduledAt])
  @@index([createdById])
  @@map("campaigns")
}

// Destinataris de la campanya
model CampaignRecipient {
  id            String          @id @default(cuid())
  campaignId    String
  campaign      Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  // Destinatari
  userId        String?
  user          User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  email         String?         // Per enviaments sense usuari registrat
  phone         String?         // Per SMS
  
  // Estat individual
  status        String          @default("pending")  // pending, sent, delivered, failed
  sentAt        DateTime?
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  
  // Metadades
  errorMessage  String?
  metadata      Json?
  
  createdAt     DateTime        @default(now())
  
  @@unique([campaignId, userId])
  @@unique([campaignId, email])
  @@index([campaignId, status])
  @@index([userId])
  @@map("campaign_recipients")
}

// Events/tracking de campanyes
model CampaignEvent {
  id          String      @id @default(cuid())
  campaignId  String
  campaign    Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  // Event
  eventType   String      // sent, delivered, opened, clicked, converted, bounced, unsubscribed
  userId      String?
  email       String?
  
  // Dades de l'event
  metadata    Json?       // URL clicada, dispositiu, etc.
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime    @default(now())
  
  @@index([campaignId, eventType])
  @@index([campaignId, createdAt])
  @@map("campaign_events")
}

// Plantilles de campanyes
model CampaignTemplate {
  id          String        @id @default(cuid())
  name        String
  description String?
  type        CampaignType
  
  // Contingut de la plantilla
  subject     String?
  content     String        // HTML o text
  contentPlain String?
  
  // Configuració
  isActive    Boolean       @default(true)
  isDefault   Boolean       @default(false)
  
  // Metadades
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdById String?
  
  @@index([type, isActive])
  @@map("campaign_templates")
}

// =============================================
// SISTEMA DE LOGS D'AUDITORIA
// =============================================

// Nivell de log
enum AuditLevel {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

// Log d'auditoria
model AuditLog {
  id          String     @id @default(cuid())
  timestamp   DateTime   @default(now())
  
  // Qui
  userId      String?
  user        User?      @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  userEmail   String?    // Guardem email per si s'elimina l'usuari
  userRole    String?    // Rol en el moment de l'acció
  
  // Què
  action      String     // LOGIN, LOGOUT, CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.
  category    String     // AUTH, USER, COMPANY, OFFER, CAMPAIGN, SYSTEM, etc.
  
  // On
  entity      String?    // Nom del model: User, Company, Offer, etc.
  entityId    String?    // ID de l'entitat afectada
  entityName  String?    // Nom/títol de l'entitat (per referència)
  
  // Detalls
  description String?    // Descripció llegible
  changes     Json?      // { before: {...}, after: {...} } per UPDATE
  metadata    Json?      // Dades addicionals
  
  // Context
  ipAddress   String?
  userAgent   String?
  requestPath String?    // /api/admin/users/xxx
  requestMethod String?  // GET, POST, PUT, DELETE
  
  // Resultat
  level       AuditLevel @default(INFO)
  success     Boolean    @default(true)
  errorMessage String?
  
  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([entity, entityId])
  @@index([timestamp])
  @@index([level])
  @@map("audit_logs")
}

// =============================================
// SISTEMA D'AVISOS DE PLATAFORMA
// =============================================

// Tipus d'avís
enum NoticeType {
  INFO          // Informació general (blau)
  SUCCESS       // Èxit/novetats (verd)
  WARNING       // Advertència (groc)
  ERROR         // Error/problema (vermell)
  MAINTENANCE   // Manteniment programat (taronja)
  ANNOUNCEMENT  // Comunicat oficial (morat)
}

// Posició de l'avís
enum NoticePosition {
  TOP_BANNER    // Banner fixe a dalt
  BOTTOM_BANNER // Banner fixe a baix
  MODAL         // Modal centrat
  TOAST         // Notificació temporal
}

// Audiència de l'avís
enum NoticeAudience {
  ALL           // Tots els usuaris
  USERS         // Només usuaris (empleats públics)
  COMPANIES     // Només empreses
  ADMINS        // Només administradors
  GESTORS       // Només gestors CRM
}

// Avís de plataforma
model PlatformNotice {
  id            String          @id @default(cuid())
  
  // Contingut
  type          NoticeType      @default(INFO)
  title         String
  message       String          @db.Text
  
  // CTA opcional
  ctaText       String?         // Text del botó
  ctaUrl        String?         // URL del botó
  
  // Aparença
  position      NoticePosition  @default(TOP_BANNER)
  icon          String?         // Icona Lucide opcional
  
  // Visibilitat
  audience      NoticeAudience  @default(ALL)
  startDate     DateTime        @default(now())
  endDate       DateTime?       // Null = indefinit
  
  // Comportament
  dismissible   Boolean         @default(true)  // Es pot tancar?
  persistent    Boolean         @default(false) // Reapareix després de tancar?
  priority      Int             @default(0)     // Ordre si hi ha múltiples
  
  // Estat
  isActive      Boolean         @default(true)
  
  // Metadades
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  createdById   String?
  createdBy     User?           @relation("NoticeCreator", fields: [createdById], references: [id], onDelete: SetNull)
  
  // Tracking de tancaments
  dismissals    NoticeDismissal[]
  
  @@index([isActive, startDate, endDate])
  @@index([audience])
  @@index([type])
  @@index([createdById])
  @@map("platform_notices")
}

// Registre de tancaments d'avisos per usuari
model NoticeDismissal {
  id          String         @id @default(cuid())
  noticeId    String
  notice      PlatformNotice @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  userId      String
  user        User           @relation("UserNoticeDismissals", fields: [userId], references: [id], onDelete: Cascade)
  dismissedAt DateTime       @default(now())
  
  @@unique([noticeId, userId])
  @@index([userId])
  @@map("notice_dismissals")
}

