// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MODELOS PRINCIPALES ====================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String?  // Nullable para permitir OAuth
  name          String?
  image         String?
  role          UserRole @default(USER)
  communityId   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Tipo de usuario
  userType        UserType @default(EMPLOYEE)

  // Si es COMPANY_OWNER
  ownedCompanyId  String?  @unique
  ownedCompany    Company? @relation("CompanyOwner", fields: [ownedCompanyId], references: [id])

  // Si es COMPANY_MEMBER
  memberCompanyId String?
  memberCompany   Company? @relation("CompanyMembers", fields: [memberCompanyId], references: [id])
  companyRole     CompanyRole?
  cargo           String?

  // Si es ACCOUNT_MANAGER
  managedCompanies Company[] @relation("AccountManager")

  // Relaciones
  community     Comunidad? @relation(fields: [communityId], references: [id])
  anunciosCreados Anuncio[] @relation("AnunciosCreados")
  comentariosCreados AnuncioComment[] @relation("ComentariosCreados")

  @@index([email])
  @@index([role])
  @@index([communityId])
  @@index([userType])
  @@index([ownedCompanyId])
  @@index([memberCompanyId])
}

model Comunidad {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String?
  activa      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  usuarios    User[]
  anuncios    Anuncio[]

  @@index([activa])
}

model Anuncio {
  id            String   @id @default(cuid())
  title         String   // Título del anuncio
  content       String   @db.Text // Contenido principal
  summary       String?  // Resumen opcional
  type          AnuncioType
  priority      Int      @default(5) // 1-10, donde 10 es más alta
  status        AnuncioStatus @default(DRAFT)

  // Audiencia y targeting
  audience      AudienceType
  targetCommunities String[] // Array de IDs de comunidades
  targetRoles   String[] // Array de roles objetivo

  // Programación
  publishAt     DateTime? // Cuando publicar
  expiresAt     DateTime? // Cuando expira

  // Notificaciones
  sendNotification Boolean @default(false)
  notificationChannels NotificationChannel[]

  // Contenido adicional
  imageUrl      String? // URL de imagen
  attachmentUrl String? // URL de archivo adjunto
  externalUrl   String? // URL externa

  // Metadatos
  tags          String[] // Tags para categorización
  isSticky      Boolean @default(false) // Anuncio fijado
  allowComments Boolean @default(true)
  slug          String? // URL slug generado automáticamente

  // Métricas
  views         Int @default(0)
  reactions     Int @default(0)
  commentsCount Int @default(0)
  sharesCount   Int @default(0)

  // Multi-tenant
  communityId   String?
  community     Comunidad? @relation(fields: [communityId], references: [id], onDelete: Cascade)

  // Auditoría
  authorId      String
  author        User     @relation("AnunciosCreados", fields: [authorId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete

  // Relaciones
  comments      AnuncioComment[]
  metrics       AnuncioMetrics[]

  @@index([communityId, status, publishAt])
  @@index([type, audience])
  @@index([authorId])
  @@index([deletedAt])
  @@index([slug])
  @@index([publishAt, expiresAt])
}

// ==================== ENUMS ====================

enum UserRole {
  USER
  MODERATOR
  COMMUNITY_MANAGER
  ADMIN
  SUPER_ADMIN
  COMPANY
}

enum AnuncioType {
  GENERAL       // general
  URGENT        // urgent
  EVENT         // event
  MAINTENANCE   // maintenance
  NEWS          // news
  ALERT         // alert
  PROMOTION     // promotion
  REGULATION    // regulation
}

enum AnuncioStatus {
  DRAFT         // draft
  PENDING       // pending
  PUBLISHED     // published
  ARCHIVED      // archived
  EXPIRED       // expired
}

enum AudienceType {
  ALL           // all
  EMPLOYEES     // employees
  COMPANIES     // companies
  SPECIFIC      // specific
  COMMUNITY     // community
}

enum NotificationChannel {
  PLATFORM      // platform
  EMAIL         // email
  SMS           // sms
  PUSH          // push
  ALL_CHANNELS  // all_channels
}

// ==================== MODELOS RELACIONADOS ====================

model AnuncioComment {
  id            String   @id @default(cuid())
  content       String   @db.Text
  isPrivate     Boolean  @default(false)
  attachmentUrl String?

  // Jerarquía de comentarios
  parentId      String?
  parent        AnuncioComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies       AnuncioComment[] @relation("CommentReplies")

  // Relaciones
  anuncioId     String
  anuncio       Anuncio  @relation(fields: [anuncioId], references: [id], onDelete: Cascade)

  authorId      String
  author        User     @relation("ComentariosCreados", fields: [authorId], references: [id])

  // Moderación
  status        CommentStatus @default(PENDING)
  moderatedBy   String?
  moderatedAt   DateTime?
  moderationReason String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  @@index([anuncioId, status])
  @@index([authorId])
  @@index([parentId])
}

model AnuncioMetrics {
  id                String   @id @default(cuid())
  anuncioId         String   @unique
  anuncio           Anuncio  @relation(fields: [anuncioId], references: [id], onDelete: Cascade)

  // Métricas básicas
  views             Int      @default(0)
  clicks            Int      @default(0)
  reactions         Int      @default(0)
  comments          Int      @default(0)
  shares            Int      @default(0)

  // Métricas por canal
  emailOpens        Int      @default(0)
  emailClicks       Int      @default(0)
  pushOpens         Int      @default(0)

  // Engagement
  engagementRate    Float    @default(0)

  // Timestamps
  lastViewedAt      DateTime?
  lastInteractionAt DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([engagementRate])
  @@index([lastViewedAt])
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

// ==================== COMPANY & SUBSCRIPTION MODELS ====================

model Company {
  id              String   @id @default(cuid())

  // Información básica
  name            String
  cif             String   @unique
  email           String
  phone           String?
  address         String?
  logo            String?
  description     String?
  website         String?

  // Plan actual
  currentPlanId   String?
  currentPlan     PlanConfig? @relation("CompanyCurrentPlan", fields: [currentPlanId], references: [id])

  // Gestor La Pública asignado
  accountManagerId String?
  accountManager   User?    @relation("AccountManager", fields: [accountManagerId], references: [id])

  // Estado
  isActive        Boolean  @default(true)

  // Relaciones
  owner           User?    @relation("CompanyOwner")
  teamMembers     User[]   @relation("CompanyMembers")
  subscriptions   Subscription[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([cif])
  @@index([currentPlanId])
  @@index([accountManagerId])
  @@map("companies")
}

model PlanConfig {
  id String @id @default(cuid())

  // Identificador único del plan
  planType String @unique

  // Información del plan
  nombre      String
  nombreCorto String
  descripcion String

  // Precios
  precioMensual Float
  precioAnual   Float?

  // Configuración en JSON
  limitesJSON     String
  caracteristicas String

  // Apariencia
  color String
  icono String

  // Configuración
  orden     Int     @default(0)
  destacado Boolean @default(false)
  activo    Boolean @default(true)
  visible   Boolean @default(true)
  esSistema Boolean @default(false)

  // Relaciones con empresas y suscripciones
  companies       Company[] @relation("CompanyCurrentPlan")
  subscriptions   Subscription[] @relation("SubscriptionPlan")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planType])
  @@index([activo, visible])
  @@index([orden])
  @@map("plan_configs")
}

model Subscription {
  id              String   @id @default(cuid())

  // Relaciones
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  planId          String
  plan            PlanConfig @relation("SubscriptionPlan", fields: [planId], references: [id])

  // Estado
  status          SubscriptionStatus @default(ACTIVE)

  // Snapshot de precios (guardados por si el plan cambia)
  precioMensual   Float
  precioAnual     Float?

  // Snapshot de límites
  limites         Json

  // Fechas
  startDate       DateTime @default(now())
  endDate         DateTime?
  cancelledAt     DateTime?

  // Configuración
  isAutoRenew     Boolean  @default(true)
  extras          Json?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@index([planId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

// ==================== COMPANY & SUBSCRIPTION ENUMS ====================

enum UserType {
  EMPLOYEE          // Empleado público
  COMPANY_OWNER     // Gestor Principal empresa
  COMPANY_MEMBER    // Miembro equipo empresa
  ACCOUNT_MANAGER   // Gestor La Pública
  ADMIN             // Admin plataforma
}

enum CompanyRole {
  OWNER             // Propietario
  MEMBER            // Miembro
}

enum SubscriptionStatus {
  ACTIVE            // Activa
  CANCELLED         // Cancelada pero válida hasta endDate
  EXPIRED           // Expirada
  PENDING           // Pendiente de activación
}
