### ================================================================
### PRUEBAS PARA APIs DE REDENCIÓN - LA PÚBLICA
### ================================================================
### Puerto: localhost:3002 (Next.js 14)
### Autenticación: Bearer Token (JWT)
### Fecha: 19 Noviembre 2025

### INSTRUCCIONES DE USO:
### 1. Ejecutar npm run dev en el proyecto
### 2. Obtener token de autenticación de usuario
### 3. Reemplazar USER_TOKEN con el token real
### 4. Reemplazar COMPANY_TOKEN con token de empresa
### 5. Reemplazar OFFER_ID_PLACEHOLDER con ID real de oferta
### 6. Ejecutar tests en orden secuencial

### ================================================================
### 1. REDENCIÓN ONLINE (EXTERNAL URL)
### ================================================================

### Test 1.1: Redimir oferta online válida
POST http://localhost:3002/api/ofertas/OFFER_ID_PLACEHOLDER/redeem/online
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
  "referrer": "https://lapublica.com/ofertas"
}

### Test 1.2: Redimir oferta con tipo incorrecto (debe fallar 400)
POST http://localhost:3002/api/ofertas/COUPON_OFFER_ID/redeem/online
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Test User Agent"
}

### Test 1.3: ID de oferta inexistente (debe fallar 404)
POST http://localhost:3002/api/ofertas/clxxx_invalid_id_12345/redeem/online
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Test User Agent"
}

### Test 1.4: Sin autenticación (debe fallar 401)
POST http://localhost:3002/api/ofertas/OFFER_ID_PLACEHOLDER/redeem/online
Content-Type: application/json

{
  "userAgent": "Test User Agent"
}

### Test 1.5: Oferta expirada (debe fallar 400)
POST http://localhost:3002/api/ofertas/EXPIRED_OFFER_ID/redeem/online
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Test User Agent"
}

### Test 1.6: Métodos HTTP no permitidos - GET (debe fallar 405)
GET http://localhost:3002/api/ofertas/OFFER_ID_PLACEHOLDER/redeem/online
Authorization: Bearer USER_TOKEN

### ================================================================
### 2. REDENCIÓN WALLET (MONEDERO DIGITAL)
### ================================================================

### Test 2.1: Agregar crédito al wallet válido
POST http://localhost:3002/api/ofertas/WALLET_OFFER_ID/redeem/wallet
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
  "referrer": "https://lapublica.com/ofertas"
}

### Test 2.2: Redimir la misma oferta dos veces (debe fallar 409)
POST http://localhost:3002/api/ofertas/WALLET_OFFER_ID/redeem/wallet
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Test User Agent"
}

### Test 2.3: Oferta sin descuento configurado (debe fallar 400)
POST http://localhost:3002/api/ofertas/NO_DISCOUNT_OFFER_ID/redeem/wallet
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Test User Agent"
}

### Test 2.4: Tipo de redención incorrecto (debe fallar 400)
POST http://localhost:3002/api/ofertas/ONLINE_OFFER_ID/redeem/wallet
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Test User Agent"
}

### Test 2.5: Sin autenticación (debe fallar 401)
POST http://localhost:3002/api/ofertas/WALLET_OFFER_ID/redeem/wallet
Content-Type: application/json

{
  "userAgent": "Test User Agent"
}

### Test 2.6: Datos inválidos - body vacío (debe fallar 400)
POST http://localhost:3002/api/ofertas/WALLET_OFFER_ID/redeem/wallet
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{}

### ================================================================
### 3. REDENCIÓN CONTACTO (LEAD GENERATION)
### ================================================================

### Test 3.1: Enviar formulario de contacto válido
POST http://localhost:3002/api/ofertas/CONTACT_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "Joan Martínez",
  "email": "joan.martinez@example.com",
  "phone": "+34 612 345 678",
  "message": "Estic molt interessat en aquesta oferta. M'agradaria saber més detalls sobre les condicions i disponibilitat. Podríeu contactar-me aviat?",
  "acceptsMarketing": true,
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
  "referrer": "https://lapublica.com/ofertas"
}

### Test 3.2: Enviar duplicat amb mateix email (debe fallar 409)
POST http://localhost:3002/api/ofertas/CONTACT_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "Joan Martínez",
  "email": "joan.martinez@example.com",
  "phone": "+34 612 345 678",
  "message": "Intent de duplicar el formulari de contacte"
}

### Test 3.3: Formulario con datos inválidos (debe fallar 400)
POST http://localhost:3002/api/ofertas/CONTACT_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "A",
  "email": "email-invalid",
  "phone": "123",
  "message": "Massa curt"
}

### Test 3.4: Mensaje demasiado largo (debe fallar 400)
POST http://localhost:3002/api/ofertas/CONTACT_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "Test User",
  "email": "test@example.com",
  "phone": "+34 612 345 678",
  "message": "Aquest missatge és extremadament llarg i supera el límit de 1000 caràcters establert pel sistema de validació. El propòsit d'aquesta prova és verificar que la validació funciona correctament quan un usuari intenta introduir un missatge que excedeix la longitud màxima permesa. Aquest tipus de validacions són crucials per mantenir la integritat de les dades i assegurar que els camps no contenen més informació de la que el sistema pot processar adequadament. Els missatges de contacte són importants per a la comunicació entre usuaris i empreses, però han de mantenir-se dins de límits razonables per garantir l'eficiència del sistema i la legibilitat de la informació. En aquest cas específic, estem provant el límit de 1000 caràcters per als missatges de contacte, que hauria de ser suficient per proporcionar informació detallada sobre l'interès de l'usuari en l'oferta. Si aquesta validació funciona correctament, el sistema hauria de retornar un error indicant que el missatge supera el límit permès i no hauria de processar la sol·licitud fins que l'usuari redueixi la longitud del text."
}

### Test 3.5: Intento de XSS en formulario (debe ser sanitizado)
POST http://localhost:3002/api/ofertas/CONTACT_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "Test <script>alert('XSS')</script> User",
  "email": "test.xss@example.com",
  "phone": "+34 612 345 678",
  "message": "Missatge normal amb contingut <script>alert('XSS')</script> maliciós que hauria de ser sanititzat correctament.",
  "acceptsMarketing": false
}

### Test 3.6: Tipo de redención incorrecto (debe fallar 400)
POST http://localhost:3002/api/ofertas/ONLINE_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "Test User",
  "email": "test@example.com",
  "phone": "+34 612 345 678",
  "message": "Aquest formulari no hauria de funcionar per aquesta oferta"
}

### ================================================================
### 4. CONSULTA WALLET USUARIO
### ================================================================

### Test 4.1: Obtener wallet completo del usuario
GET http://localhost:3002/api/user/wallet
Authorization: Bearer USER_TOKEN
Content-Type: application/json

### Test 4.2: Obtener wallet con paginación
GET http://localhost:3002/api/user/wallet?page=1&limit=10&includeStats=true
Authorization: Bearer USER_TOKEN
Content-Type: application/json

### Test 4.3: Filtrar transacciones por tipo CREDIT
GET http://localhost:3002/api/user/wallet?type=CREDIT&page=1&limit=5
Authorization: Bearer USER_TOKEN
Content-Type: application/json

### Test 4.4: Filtrar por rango de fechas
GET http://localhost:3002/api/user/wallet?dateFrom=2025-11-01T00:00:00Z&dateTo=2025-11-30T23:59:59Z
Authorization: Bearer USER_TOKEN
Content-Type: application/json

### Test 4.5: Parámetros inválidos (debe fallar 400)
GET http://localhost:3002/api/user/wallet?page=-1&limit=200&type=INVALID
Authorization: Bearer USER_TOKEN
Content-Type: application/json

### Test 4.6: Sin autenticación (debe fallar 401)
GET http://localhost:3002/api/user/wallet

### Test 4.7: Obtener estadísticas detalladas
GET http://localhost:3002/api/user/wallet?includeStats=true&page=1&limit=5
Authorization: Bearer USER_TOKEN
Content-Type: application/json

### Test 4.8: Métodos HTTP no permitidos - POST (debe fallar 405)
POST http://localhost:3002/api/user/wallet
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "invalid": "request"
}

### ================================================================
### 5. GESTIÓN LEADS EMPRESA
### ================================================================

### Test 5.1: Obtener todos los leads de la empresa
GET http://localhost:3002/api/empresa/leads
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 5.2: Filtrar leads por estado NEW
GET http://localhost:3002/api/empresa/leads?status=NEW&sortBy=createdAt&sortOrder=desc
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 5.3: Filtrar por fuente OFFER_REDEMPTION
GET http://localhost:3002/api/empresa/leads?source=OFFER_REDEMPTION&includeStats=true
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 5.4: Búsqueda por texto con paginación
GET http://localhost:3002/api/empresa/leads?search=joan&page=1&limit=10
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 5.5: Filtrar por oferta específica
GET http://localhost:3002/api/empresa/leads?offerId=CONTACT_OFFER_ID&sortBy=status
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 5.6: Obtener estadísticas completas
GET http://localhost:3002/api/empresa/leads?includeStats=true&page=1&limit=20
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 5.7: Filtrar por rango de fechas
GET http://localhost:3002/api/empresa/leads?dateFrom=2025-11-01T00:00:00Z&dateTo=2025-11-30T23:59:59Z&sortBy=createdAt&sortOrder=asc
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 5.8: Usuario sin empresa asociada (debe fallar 403)
GET http://localhost:3002/api/empresa/leads
Authorization: Bearer USER_TOKEN
Content-Type: application/json

### Test 5.9: Sin autenticación (debe fallar 401)
GET http://localhost:3002/api/empresa/leads

### Test 5.10: Parámetros inválidos (debe fallar 400)
GET http://localhost:3002/api/empresa/leads?page=-1&limit=100&status=INVALID&sortBy=invalid
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 5.11: Métodos HTTP no permitidos - PUT (debe fallar 405)
PUT http://localhost:3002/api/empresa/leads
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

{
  "invalid": "request"
}

### ================================================================
### 6. CASOS DE USO REALES Y FLUJOS COMPLETOS
### ================================================================

### Test 6.1: Flujo completo - Usuario redime oferta online
### Paso 1: Redimir oferta online
POST http://localhost:3002/api/ofertas/ONLINE_OFFER_ID/redeem/online
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
  "referrer": "https://lapublica.com/dashboard"
}

### Test 6.2: Flujo completo - Usuario agrega crédito al wallet
### Paso 1: Consultar wallet antes
GET http://localhost:3002/api/user/wallet
Authorization: Bearer USER_TOKEN

### Paso 2: Redimir oferta wallet
POST http://localhost:3002/api/ofertas/WALLET_OFFER_ID/redeem/wallet
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
  "referrer": "https://lapublica.com/ofertas/wallet"
}

### Paso 3: Consultar wallet después
GET http://localhost:3002/api/user/wallet?includeStats=true&limit=5
Authorization: Bearer USER_TOKEN

### Test 6.3: Flujo completo - Lead generation
### Paso 1: Enviar formulario contacto
POST http://localhost:3002/api/ofertas/CONTACT_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "Maria García",
  "email": "maria.garcia@example.com",
  "phone": "+34 654 321 987",
  "message": "Hola! Estic interessada en aquesta oferta. Podríeu explicar-me més detalls sobre les condicions i la disponibilitat? Gràcies!",
  "acceptsMarketing": true,
  "userAgent": "Mozilla/5.0 (iPhone; CPU iPhone OS 14_7_1 like Mac OS X) AppleWebKit/605.1.15",
  "referrer": "https://lapublica.com/ofertas/contact"
}

### Paso 2: Empresa consulta leads nuevos
GET http://localhost:3002/api/empresa/leads?status=NEW&sortBy=createdAt&sortOrder=desc&limit=10
Authorization: Bearer COMPANY_TOKEN

### Paso 3: Empresa consulta estadísticas
GET http://localhost:3002/api/empresa/leads?includeStats=true&page=1&limit=1
Authorization: Bearer COMPANY_TOKEN

### ================================================================
### 7. PRUEBAS DE SEGURIDAD Y EDGE CASES
### ================================================================

### Test 7.1: Token JWT malformado (debe fallar 401)
GET http://localhost:3002/api/user/wallet
Authorization: Bearer invalid.jwt.token.here
Content-Type: application/json

### Test 7.2: Header Authorization sin Bearer (debe fallar 401)
GET http://localhost:3002/api/user/wallet
Authorization: USER_TOKEN
Content-Type: application/json

### Test 7.3: SQL Injection attempt en search de leads (debe ser sanitizado)
GET http://localhost:3002/api/empresa/leads?search='; DROP TABLE users; --
Authorization: Bearer COMPANY_TOKEN
Content-Type: application/json

### Test 7.4: XSS attempt en formulario contacto (debe ser sanitizado)
POST http://localhost:3002/api/ofertas/CONTACT_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "Test <script>window.location='http://evil.com'</script>",
  "email": "hacker@test.com",
  "phone": "javascript:alert('XSS')",
  "message": "onclick='alert(document.cookie)' style='color:red' Este es un intento de XSS <img src='x' onerror='alert(1)'>"
}

### Test 7.5: Límite de caracteres en diferentes campos
POST http://localhost:3002/api/ofertas/CONTACT_OFFER_ID/redeem/contact
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "name": "Este nombre es demasiado largo y supera el límite de 100 caracteres permitido por el sistema de validación ABC",
  "email": "test@example.com",
  "phone": "+34 612 345 678 extension que es demasiado larga",
  "message": "Mensaje válido de longitud normal"
}

### Test 7.6: Inyección de código en userAgent y referrer
POST http://localhost:3002/api/ofertas/ONLINE_OFFER_ID/redeem/online
Authorization: Bearer USER_TOKEN
Content-Type: application/json

{
  "userAgent": "<script>alert('XSS in userAgent')</script>",
  "referrer": "javascript:alert('XSS in referrer')"
}

### ================================================================
### INSTRUCCIONES PARA OBTENER IDs Y TOKENS
### ================================================================

### Para obtener USER_TOKEN:
### 1. Ir a la aplicación web
### 2. Iniciar sesión como usuario normal
### 3. Abrir DevTools → Network → Headers
### 4. Copiar el token JWT del header Authorization

### Para obtener COMPANY_TOKEN:
### 1. Ir a la aplicación web
### 2. Iniciar sesión como usuario con empresa
### 3. Abrir DevTools → Network → Headers
### 4. Copiar el token JWT del header Authorization

### Para obtener OFFER_ID_PLACEHOLDER:
### 1. Ejecutar en Prisma Studio:
###    SELECT id, title, "redemptionType" FROM "Offer" WHERE status = 'PUBLISHED' LIMIT 5;
### 2. Usar IDs según el tipo de redención necesario

### Para crear ofertas de prueba:
### 1. ONLINE_OFFER_ID: oferta con redemptionType = 'ONLINE' y externalUrl
### 2. WALLET_OFFER_ID: oferta con redemptionType = 'VIP_ACCOUNT' y discount > 0
### 3. CONTACT_OFFER_ID: oferta con redemptionType = 'CONTACT_FORM'
### 4. COUPON_OFFER_ID: oferta con redemptionType = 'COUPON' (existente)

### ================================================================
### RESPUESTAS ESPERADAS
### ================================================================

### Redención Online Exitosa (200):
### {
###   "success": true,
###   "data": {
###     "redirectUrl": "https://empresa.com/oferta?ref=lapublica&offer_id=...",
###     "offerTitle": "Título de la oferta",
###     "companyName": "Nombre empresa",
###     "expiresAt": "2025-12-31T23:59:59Z"
###   }
### }

### Redención Wallet Exitosa (200):
### {
###   "success": true,
###   "data": {
###     "transaction": {
###       "id": "clxxx...",
###       "amount": "25.00",
###       "type": "CREDIT",
###       "description": "Redempció oferta: ...",
###       "createdAt": "2025-11-19T..."
###     },
###     "wallet": {
###       "balance": "75.00",
###       "totalEarned": "100.00",
###       "lastTransactionAt": "2025-11-19T..."
###     }
###   }
### }

### Formulario Contacto Exitoso (200):
### {
###   "success": true,
###   "data": {
###     "lead": {
###       "id": "clxxx...",
###       "status": "NEW",
###       "name": "Joan Martínez",
###       "email": "joan.martinez@example.com",
###       "createdAt": "2025-11-19T..."
###     },
###     "nextSteps": ["L'empresa revisarà...", "Et contactaran..."]
###   }
### }

### Error Cliente (400): { "success": false, "error": "...", "details": [...] }
### No Autorizado (401): { "success": false, "error": "No autenticat" }
### Prohibido (403): { "success": false, "error": "Accés denegat..." }
### No Encontrado (404): { "success": false, "error": "Oferta no trobada" }
### Conflicto (409): { "success": false, "error": "Ja has utilitzat...", "transactionId": "..." }
### Método No Permitido (405): { "error": "Mètode no permès" }
### Error Servidor (500): { "success": false, "error": "Error intern del servidor" }

### ================================================================
### VALIDACIÓN DE ENDPOINTS IMPLEMENTADOS
### ================================================================
### ✅ POST /api/ofertas/[id]/redeem/online     - Redención externa
### ✅ POST /api/ofertas/[id]/redeem/wallet     - Crédito monedero
### ✅ POST /api/ofertas/[id]/redeem/contact    - Formulario contacto
### ✅ GET  /api/user/wallet                    - Consulta wallet usuario
### ✅ GET  /api/empresa/leads                  - Gestión leads empresa