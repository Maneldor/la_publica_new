generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                               String                    @id @default(cuid())
  email                            String                    @unique
  password                         String
  primaryRole                      UserRole                  @default(EMPLEADO_PUBLICO)
  isActive                         Boolean                   @default(true)
  isEmailVerified                  Boolean                   @default(false)
  emailVerificationToken           String?
  passwordResetToken               String?
  passwordResetExpires             DateTime?
  refreshToken                     String?
  lastLogin                        DateTime?
  createdAt                        DateTime                  @default(now())
  updatedAt                        DateTime                  @updatedAt

  // RELACIONES 1:1 (Perfiles) - CON NOMBRES EXPLCITOS
  employee                         Employee?                 @relation("UserEmployeeProfile")
  company                          Company?                  @relation("UserCompanyProfile")
  publicAdministration             PublicAdministration?     @relation("UserAdminProfile")

  // Relaciones 1:N y M:N (Listas)
  announcements                    Announcement[]
  announcementReports              AnnouncementReport[]      @relation("AnnouncementReports")
  certificates                     Certificate[]             @relation("UserCertificates")
  contents                         Content[]
  createdCourses                   Course[]                  @relation("CreatedCourses")
  courseProgress                   CourseProgress[]          @relation("UserCourseProgress")
  courseRatings                    CourseRating[]            @relation("UserCourseRatings")
  courseReviews                    CourseReview[]            @relation("UserCourseReviews")
  courseWishlists                  CourseWishlist[]          @relation("UserWishlists")
  enrollments                      Enrollment[]              @relation("UserEnrollments")
  forumReplyReports                ForumReplyReport[]        @relation("ForumReplyReports")
  forumTopicReports                ForumTopicReport[]        @relation("ForumTopicReports")
  groupMemberships                 GroupMember[]
  groupPostReports                 GroupPostReport[]         @relation("GroupPostReports")
  interestLinks                    InterestLink[]
  lessonProgress                   LessonProgress[]          @relation("UserLessonProgress")
  posts                            Post[]
  commentReports                   PostCommentReport[]       @relation("CommentReports")
  postReports                      PostReport[]              @relation("PostReports")
  reports                          Report[]
  additionalRoles                  UserAdditionalRole[]
  permissions                      UserPermission[]

  // Relaciones CRM
  assignedLeads                    CompanyLead[]             @relation("LeadAssignments")
  managedCompanies                 Company[]                 @relation("CompanyAccountManager")
  interactions                     Interaction[]             @relation("InteractionCreator")
  notifications                    Notification[]            @relation("UserNotifications")
  
  // Relaciones Missatgeria
  createdConversations             Conversation[]            @relation("ConversationCreator")
  conversationParticipants         ConversationParticipant[] @relation("UserConversations")
  sentMessages                     Message[]                 @relation("SentMessages")
  readMessages                     MessageRead[]             @relation("ReadMessages")

  // Relaciones Agenda/Calendari
  organizedEvents                  Event[]                   @relation("OrganizedEvents")
  eventAttendances                 EventAttendee[]           @relation("EventAttendances")

  // Relaciones Ofertas Grupales
  adminReviewedRequests            GroupOfferRequest[]       @relation("AdminReviewer")
  assignedRequests                 GroupOfferRequest[]       @relation("GestorAssignments")
  createdGroupOffers               GroupOfferConfig[]        @relation("GestorCreatedOffers")
  groupParticipations              GroupParticipant[]        @relation("UserGroupParticipations")

  @@index([email])
  @@index([primaryRole])
  @@index([isActive])
}

model UserAdditionalRole {
  id        String   @id @default(cuid())
  userId    String
  role      UserRole
  groupId   String?
  createdAt DateTime @default(now())
  createdBy String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role, groupId])
  @@index([userId])
  @@index([role])
}

model UserPermission {
  id          String         @id @default(cuid())
  userId      String
  permission  PermissionType
  resource    String?
  granted     Boolean        @default(true)
  createdAt   DateTime       @default(now())
  createdBy   String
  expiresAt   DateTime?
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission, resource])
  @@index([userId])
  @@index([permission])
}

model Employee {
  id                  String             @id @default(cuid())
  userId              String             @unique
  firstName           String
  lastName            String
  nick                String?
  dni                 String?            @unique
  jobTitle            String?
  department          String?
  organization        String?
  community           String
  administrationType  AdministrationType
  province            String?
  city                String?
  avatar              String?
  generalInfo         String?
  skills              String?
  workExperience      String?
  socialNetworks      String?
  bio                 String?
  privacySettings     String?
  canBeGroupAdmin     Boolean            @default(false)
  canBeGroupModerator Boolean            @default(false)
  canBeContentManager Boolean            @default(false)
  customFields        Json?
  customFieldsPrivacy Json?
  isActive            Boolean            @default(true)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  user                User               @relation("UserEmployeeProfile", fields: [userId], references: [id], onDelete: Cascade) // Corregido

  @@index([community])
  @@index([administrationType])
}

model Company {
  id                    String                @id @default(cuid())
  userId                String                @unique
  name                  String
  description           String?
  sector                String
  size                  String                @default("peque帽a")
  cif                   String?               @unique
  address               String?
  phone                 String?
  email                 String
  website               String?
  socialMedia           String?
  logo                  String?
  certifications        String?
  foundedYear           Int?
  employeeCount         Int?
  annualRevenue         Float?
  configuration         String?
  customFields          Json?
  customFieldsPrivacy   Json?
  isVerified            Boolean               @default(false)
  isActive              Boolean               @default(true)
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Plan limits fields
  planType              String                @default("BASIC") // BASIC, STANDARD, PREMIUM, EMPRESARIAL
  maxMembers            Int                   @default(1)
  maxStorage            BigInt                @default(1073741824) // 1GB in bytes
  maxDocuments          Int                   @default(10)
  maxOffers             Int                   @default(3)

  user                  User                  @relation("UserCompanyProfile", fields: [userId], references: [id], onDelete: Cascade) // Corregido
  advisories            CompanyAdvisory[]
  products              CompanyProduct[]
  profile               CompanyProfile?
  ratings               CompanyRating[]
  services              CompanyService[]

  // Nuevas relaciones CRM
  contacts              Contact[]
  interactions          Interaction[]
  convertedFromLead     CompanyLead?          @relation("LeadConversion")

  // Informaci贸n comercial
  accountManagerId      String?
  accountManager        User?                 @relation("CompanyAccountManager", fields: [accountManagerId], references: [id])
  notifications         Notification[]        @relation("CompanyNotifications")
  events                Event[]               @relation("CompanyEvents")

  // Plan limits relations
  subscription          Subscription?
  storage               CompanyStorage?
  documents             Document[]
  customFeatures        CustomFeature[]
  planChangeLogs        PlanChangeLog[]
  
  // Relaciones Ofertas Grupales
  groupOfferRequests    GroupOfferRequest[]   @relation("CompanyGroupRequests")
  offers                Offer[]               // Las ofertas normales de la compa帽铆a

  @@index([sector])
  @@index([size])
  @@index([isVerified])
  @@index([isActive])
  @@index([accountManagerId])
  @@index([planType])
}

model PublicAdministration {
  id                  String             @id @default(cuid())
  userId              String             @unique
  name                String
  administrationType  AdministrationType
  community           String?
  province            String?
  city                String?
  address             String?
  phone               String?
  email               String
  website             String?
  description         String?
  citizenServices     String?
  departments         String?
  publicHours         String?
  contactInfo         String?
  customFields        Json?
  customFieldsPrivacy Json?
  isVerified          Boolean            @default(false)
  isActive            Boolean            @default(true)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  user                User               @relation("UserAdminProfile", fields: [userId], references: [id], onDelete: Cascade) // Corregido

  @@index([administrationType])
  @@index([community])
  @@index([isVerified])
  @@index([isActive])
}

model Category {
  id           String             @id @default(cuid())
  name         String             @unique
  slug         String             @unique
  description  String?
  color        String             @default("#3B82F6")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  contents     ContenidoMaestro[] @relation("CategoryContents")
  contentPosts Content[]
}

model ContenidoMaestro {
  id                  String                 @id @default(cuid())
  tipo                String
  tituloOriginal      String
  contenidoOriginal   String
  extracto            String?
  idiomaOrigen        String                 @default("es")
  autorId             String
  autorNombre         String
  estado              String                 @default("borrador")
  metadatos           String?
  categoryId          String?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  category            Category?              @relation("CategoryContents", fields: [categoryId], references: [id])
  publicaciones       PublicacionComunidad[]
  traducciones        Traduccion[]

  @@index([estado])
  @@index([tipo])
  @@index([autorId])
  @@index([categoryId])
}

model Traduccion {
  id                    String           @id @default(cuid())
  contenidoId           String
  idiomaDestino         String
  tituloTraducido       String
  contenidoTraducido    String
  extractoTraducido     String?
  metadatosTraducidos   String?
  estadoTraduccion      String           @default("automatica")
  traducidoPor          String
  confianzaTraduccion   Float            @default(0.0)
  revisadoPor           String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  contenido             ContenidoMaestro @relation(fields: [contenidoId], references: [id], onDelete: Cascade)

  @@unique([contenidoId, idiomaDestino])
  @@index([contenidoId])
  @@index([estadoTraduccion])
}

model PublicacionComunidad {
  id                 String           @id @default(cuid())
  contenidoId        String
  traduccionId       String?
  comunidadSlug      String
  idioma             String
  publicado          Boolean          @default(false)
  fechaPublicacion   DateTime?
  slug               String
  urlPublica         String?
  vistas             Int              @default(0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  contenido          ContenidoMaestro @relation(fields: [contenidoId], references: [id], onDelete: Cascade)

  @@unique([contenidoId, comunidadSlug, idioma])
  @@index([comunidadSlug, publicado])
  @@index([contenidoId])
  @@index([slug])
}

model ComunidadConfig {
  id              String   @id @default(cuid())
  slug            String   @unique
  nombre          String
  nombreLocal     String?
  idiomas         String
  idiomaDefault   String   @default("es")
  dominioBase     String
  activa          Boolean  @default(true)
  configuracion   String?
  descripcion     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([activa])
}

model Post {
  id            String          @id @default(cuid())
  userId        String
  content       String
  images        String?
  type          String          @default("texto")
  isPinned      Boolean         @default(false)
  isModerated   Boolean         @default(false)
  reported      Boolean         @default(false)
  comunidadSlug String?
  idioma        String          @default("es")
  viewsCount    Int             @default(0)
  sharesCount   Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments      PostComment[]
  likes         PostLike[]
  reports       PostReport[]

  @@index([userId])
  @@index([comunidadSlug])
  @@index([isPinned])
  @@index([reported])
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  emoji     String   @default("")
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
}

model PostComment {
  id          String              @id @default(cuid())
  postId      String
  userId      String
  content     String
  isEdited    Boolean             @default(false)
  parentId    String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  parent      PostComment?        @relation("CommentReplies", fields: [parentId], references: [id])
  replies     PostComment[]       @relation("CommentReplies")
  post        Post                @relation(fields: [postId], references: [id], onDelete: Cascade)
  reports     PostCommentReport[]

  @@index([postId])
}

model PostReport {
  id         String       @id @default(cuid())
  postId     String
  reportedBy String
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  post       Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter   User         @relation("PostReports", fields: [reportedBy], references: [id])

  @@index([postId])
  @@index([reportedBy])
  @@index([status])
}

model Group {
  id            String        @id @default(cuid())
  name          String
  description   String?
  type          String
  category      String?
  configuration String?
  order         Int           @default(0)
  isActive      Boolean       @default(true)
  creatorId     String
  coverImage    String?
  comunidadSlug String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  members       GroupMember[]
  posts         GroupPost[]

  @@index([type])
  @@index([comunidadSlug])
  @@index([category])
  @@index([isActive])
}

model GroupMember {
  id       String    @id @default(cuid())
  groupId  String
  userId   String
  role     String    @default("member")
  status   String    @default("active")
  joinedAt DateTime  @default(now())
  leftAt   DateTime?
  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([status])
  @@index([role])
}

model GroupPost {
  id          String            @id @default(cuid())
  groupId     String
  userId      String
  title       String
  content     String
  type        String            @default("texto")
  tags        String?
  multimedia  String?
  isPublished Boolean           @default(true)
  publishedAt DateTime?
  isPinned    Boolean           @default(false)
  isActive    Boolean           @default(true)
  order       Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  group       Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  reports     GroupPostReport[]

  @@index([groupId])
  @@index([type])
  @@index([isPublished])
  @@index([isActive])
}

model Forum {
  id            String           @id @default(cuid())
  title         String
  description   String?
  category      String
  type          String           @default("publico")
  order         Int              @default(0)
  configuration String?
  isActive      Boolean          @default(true)
  creatorId     String
  isPinned      Boolean          @default(false)
  isLocked      Boolean          @default(false)
  comunidadSlug String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  moderators    ForumModerator[]
  topics        ForumTopic[]

  @@index([comunidadSlug])
  @@index([isPinned])
  @@index([category])
  @@index([type])
  @@index([isActive])
}

model ForumTopic {
  id             String             @id @default(cuid())
  forumId        String
  userId         String
  title          String
  content        String
  type           String             @default("discusion")
  tags           String?
  isPinned       Boolean            @default(false)
  isLocked       Boolean            @default(false)
  isActive       Boolean            @default(true)
  lastActivity   DateTime           @default(now())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  replies        ForumReply[]
  forum          Forum              @relation(fields: [forumId], references: [id], onDelete: Cascade)
  reports        ForumTopicReport[]

  @@index([forumId])
  @@index([type])
  @@index([isPinned])
  @@index([isLocked])
  @@index([isActive])
  @@index([lastActivity])
}

model ForumReply {
  id          String             @id @default(cuid())
  topicId     String
  userId      String
  content     String
  replyToId   String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  replyTo     ForumReply?        @relation("ReplyToReply", fields: [replyToId], references: [id])
  replies     ForumReply[]       @relation("ReplyToReply")
  topic       ForumTopic         @relation(fields: [topicId], references: [id], onDelete: Cascade)
  reports     ForumReplyReport[]

  @@index([topicId])
  @@index([replyToId])
  @@index([isActive])
}

model Announcement {
  id            String               @id @default(cuid())
  userId        String
  title         String
  content       String
  type          String
  scope         String               @default("global")
  targets       String?
  startDate     DateTime             @default(now())
  expiresAt     DateTime?
  configuration String?
  isPinned      Boolean              @default(false)
  isRead        Boolean              @default(false)
  isActive      Boolean              @default(true)
  comunidadSlug String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  priority      Int                  @default(5)
  status        String               @default("approved")
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  reads         AnnouncementRead[]
  reports       AnnouncementReport[]

  @@index([comunidadSlug])
  @@index([isPinned])
  @@index([expiresAt])
  @@index([priority])
  @@index([scope])
  @@index([status])
  @@index([isActive])
}

model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String
  userId         String
  readAt         DateTime     @default(now())
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
}

model ForumModerator {
  id         String   @id @default(cuid())
  forumId    String
  userId     String
  role       String   @default("moderador")
  assignedAt DateTime @default(now())
  forum      Forum    @relation(fields: [forumId], references: [id], onDelete: Cascade)

  @@unique([forumId, userId])
  @@index([forumId])
  @@index([userId])
  @@index([role])
}

model CompanyProfile {
  id                 String            @id @default(cuid())
  companyId          String            @unique
  isVerified         Boolean           @default(false)
  isFeatured         Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  advisories         CompanyAdvisory[]
  products           CompanyProduct[]
  company            Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  services           CompanyService[]
}

model CompanyService {
  id                 String           @id @default(cuid())
  companyId          String
  companyProfileId   String?
  name               String
  description        String
  category           String
  subcategory        String?
  features           String?
  pricing            String?
  duration           String?
  modality           String           @default("presencial")
  availability       String?
  order              Int              @default(0)
  isActive           Boolean          @default(true)
  comunidadSlug      String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  company            Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyProfile     CompanyProfile?  @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([companyProfileId])
  @@index([category])
  @@index([modality])
  @@index([isActive])
  @@index([comunidadSlug])
}

model CompanyProduct {
  id                 String           @id @default(cuid())
  companyId          String
  companyProfileId   String?
  name               String
  description        String
  category           String
  subcategory        String?
  price              Float
  features           String?
  images             String?
  stock              Int?
  isAvailable        Boolean          @default(true)
  order              Int              @default(0)
  isActive           Boolean          @default(true)
  comunidadSlug      String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  company            Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyProfile     CompanyProfile?  @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([companyProfileId])
  @@index([category])
  @@index([price])
  @@index([isAvailable])
  @@index([isActive])
}

model CompanyAdvisory {
  id                 String           @id @default(cuid())
  companyId          String
  companyProfileId   String?
  serviceId          String?
  clientId           String
  subject            String
  description        String
  urgency            String           @default("media")
  estimatedBudget    Float?
  deadline           DateTime?
  contact            String?
  status             String           @default("pendiente")
  response           String?
  finalBudget        Float?
  requestDate        DateTime         @default(now())
  responseDate       DateTime?
  comunidadSlug      String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  company            Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyProfile     CompanyProfile?  @relation(fields: [companyProfileId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([companyProfileId])
  @@index([clientId])
  @@index([status])
  @@index([urgency])
}

model CompanyRating {
  id         String   @id @default(cuid())
  companyId  String
  userId     String
  rating     Int
  comment    String?
  serviceId  String?
  advisoryId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
  @@index([rating])
}

model InterestLink {
  id            String   @id @default(cuid())
  userId        String
  title         String
  url           String
  description   String?
  category      String?
  comunidadSlug String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([comunidadSlug])
  @@index([category])
}

model Content {
  id         String        @id @default(cuid())
  title      String
  slug       String        @unique
  excerpt    String
  content    String
  status     ContentStatus @default(DRAFT)
  pinned     Boolean       @default(false)
  categoryId String?
  authorId   String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  author     User          @relation(fields: [authorId], references: [id])
  category   Category?     @relation(fields: [categoryId], references: [id])
  reports    Report[]
  tags       Tag[]         @relation("ContentToTag")

  @@index([authorId])
  @@index([categoryId])
  @@index([pinned])
}

model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  contents  Content[] @relation("ContentToTag")
}

model Report {
  id         String       @id @default(cuid())
  contentId  String
  reportedBy String
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  content    Content      @relation(fields: [contentId], references: [id], onDelete: Cascade)
  reporter   User         @relation(fields: [reportedBy], references: [id])

  @@index([contentId])
  @@index([reportedBy])
  @@index([status])
}

model InappropriateWord {
  id        String   @id @default(cuid())
  word      String   @unique
  createdAt DateTime @default(now())
}

model PostCommentReport {
  id         String       @id @default(cuid())
  commentId  String
  reportedBy String
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  comment    PostComment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  reporter   User         @relation("CommentReports", fields: [reportedBy], references: [id])

  @@index([commentId])
  @@index([reportedBy])
  @@index([status])
}

model GroupPostReport {
  id         String       @id @default(cuid())
  postId     String
  reportedBy String
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  post       GroupPost    @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter   User         @relation("GroupPostReports", fields: [reportedBy], references: [id])

  @@index([postId])
  @@index([reportedBy])
  @@index([status])
}

model ForumTopicReport {
  id         String       @id @default(cuid())
  topicId    String
  reportedBy String
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  reporter   User         @relation("ForumTopicReports", fields: [reportedBy], references: [id])
  topic      ForumTopic   @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@index([topicId])
  @@index([reportedBy])
  @@index([status])
}

model ForumReplyReport {
  id         String       @id @default(cuid())
  replyId    String
  reportedBy String
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  reply      ForumReply   @relation(fields: [replyId], references: [id], onDelete: Cascade)
  reporter   User         @relation("ForumReplyReports", fields: [reportedBy], references: [id])

  @@index([replyId])
  @@index([reportedBy])
  @@index([status])
}

model AnnouncementReport {
  id             String       @id @default(cuid())
  announcementId String
  reportedBy     String
  reason         String
  status         ReportStatus @default(PENDING)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  reporter       User         @relation("AnnouncementReports", fields: [reportedBy], references: [id])

  @@index([announcementId])
  @@index([reportedBy])
  @@index([status])
}

model CustomField {
  id                  String          @id @default(cuid())
  name                String
  fieldType           CustomFieldType
  userType            UserRole
  required            Boolean         @default(false)
  isPublicByDefault   Boolean         @default(false)
  allowUserPrivacy    Boolean         @default(true)
  options             Json?
  validation          Json?
  placeholder         String?
  description         String?
  order               Int             @default(0)
  isActive            Boolean         @default(true)
  createdBy           String
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@unique([name, userType])
  @@index([userType])
  @@index([isActive])
}

model Course {
  id                   String                 @id @default(cuid())
  title                String
  description          String
  shortDescription     String?
  slug                 String                 @unique
  instructor           String
  institution          String
  instructorEmail      String?
  institutionLogo      String?
  category             CourseCategory
  subcategory          String?
  tags                 String?
  level                CourseLevel
  mode                 CourseMode
  duration             Int
  language             String                 @default("ca")
  price                Float
  originalPrice        Float?
  discount             Int?
  currency             String                 @default("EUR")
  startDate            DateTime?
  endDate              DateTime?
  enrollmentDeadline   DateTime?
  availableSlots       Int?
  totalSlots           Int?
  status               CourseStatus           @default(DRAFT)
  isHighlighted        Boolean                @default(false)
  isFeatured           Boolean                @default(false)
  isNew                Boolean                @default(true)
  coverImage           String?
  promoVideo           String?
  materials            String?
  viewsCount           Int                    @default(0)
  enrollmentCount      Int                    @default(0)
  completionRate       Float?
  averageRating        Float?
  totalRatings         Int                    @default(0)
  creatorId            String
  comunidadSlug        String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  certificates         Certificate[]
  creator              User                   @relation("CreatedCourses", fields: [creatorId], references: [id])
  announcements        CourseAnnouncement[]
  modules              CourseModule[]
  progress             CourseProgress[]
  ratings              CourseRating[]
  reviews              CourseReview[]
  wishlists            CourseWishlist[]       @relation("CourseWishlists")
  enrollments          Enrollment[]

  @@index([category])
  @@index([level])
  @@index([mode])
  @@index([status])
  @@index([isHighlighted])
  @@index([isFeatured])
  @@index([startDate])
  @@index([creatorId])
  @@index([comunidadSlug])
}

model CourseModule {
  id          String         @id @default(cuid())
  courseId    String
  title       String
  description String?
  order       Int            @default(0)
  duration    Int?
  isRequired  Boolean        @default(true)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  course      Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@index([courseId])
  @@index([order])
}

model Lesson {
  id           String           @id @default(cuid())
  moduleId     String
  title        String
  content      String?
  type         String           @default("text")
  order        Int              @default(0)
  duration     Int?
  videoUrl     String?
  materials    String?
  isRequired   Boolean          @default(true)
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  module       CourseModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress     LessonProgress[]

  @@index([moduleId])
  @@index([order])
}

model Enrollment {
  id                String           @id @default(cuid())
  courseId          String
  userId            String
  status            EnrollmentStatus @default(PENDING)
  enrolledAt        DateTime         @default(now())
  completedAt       DateTime?
  droppedAt         DateTime?
  lastAccessedAt    DateTime?
  paymentAmount     Float?
  paymentMethod     String?
  paymentDate       DateTime?
  transactionId     String?
  progressPercent   Float            @default(0)
  currentModuleId   String?
  currentLessonId   String?
  enrollmentData    Json?
  course            Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user              User             @relation("UserEnrollments", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([userId])
  @@index([status])
  @@index([enrolledAt])
}

model CourseProgress {
  id               String    @id @default(cuid())
  courseId         String
  userId           String
  progressPercent  Float     @default(0)
  completedModules Int       @default(0)
  totalModules     Int       @default(0)
  completedLessons Int       @default(0)
  totalLessons     Int       @default(0)
  timeSpent        Int       @default(0)
  lastAccessedAt   DateTime  @default(now())
  completedAt      DateTime?
  course           Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user             User      @relation("UserCourseProgress", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([userId])
  @@index([progressPercent])
}

model LessonProgress {
  id             String    @id @default(cuid())
  lessonId       String
  userId         String
  isCompleted    Boolean   @default(false)
  timeSpent      Int       @default(0)
  completedAt    DateTime?
  lastAccessed   DateTime  @default(now())
  lesson         Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           User      @relation("UserLessonProgress", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([lessonId, userId])
  @@index([userId])
  @@index([isCompleted])
}

model CourseRating {
  id        String   @id @default(cuid())
  courseId  String
  userId    String
  rating    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation("UserCourseRatings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([courseId])
  @@index([rating])
}

model CourseReview {
  id         String   @id @default(cuid())
  courseId   String
  userId     String
  rating     Int
  title      String?
  comment    String
  isPublic   Boolean  @default(true)
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User     @relation("UserCourseReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([courseId])
  @@index([rating])
  @@index([isPublic])
}

model Certificate {
  id                 String    @id @default(cuid())
  courseId           String
  userId             String
  certificateId      String    @unique
  issuedAt           DateTime  @default(now())
  expiresAt          DateTime?
  isValid            Boolean   @default(true)
  recipientName      String
  courseName         String
  institution        String
  instructor         String
  completionDate     DateTime
  grade              String?
  verificationUrl    String?
  digitalSignature   String?
  course             Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user               User      @relation("UserCertificates", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([certificateId])
  @@index([userId])
  @@index([isValid])
}

model CourseAnnouncement {
  id        String   @id @default(cuid())
  courseId  String
  title     String
  content   String
  type      String   @default("info")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([type])
  @@index([isActive])
}

model CourseWishlist {
  id       String   @id @default(cuid())
  courseId String
  userId   String
  addedAt  DateTime @default(now())
  course   Course   @relation("CourseWishlists", fields: [courseId], references: [id], onDelete: Cascade)
  user     User     @relation("UserWishlists", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([userId])
}

// ============================================================================
// MODELOS CRM - GESTOR D'EMPRESES
// ============================================================================

model CompanyLead {
  id                   String    @id @default(cuid())
  companyName          String
  cif                  String?   @unique
  sector               String?
  website              String?
  employees            Int? // Nombre aproximat d'empleats

  // Informaci贸 comercial
  source               String // "web_form", "referral", "cold_call", "event", "other"
  priority             String // "high", "medium", "low"
  status               String // "new", "contacted", "negotiating", "converted", "lost"
  lostReason           String? // Si status = "lost"
  estimatedValue       Float? // Valor estimat anual

  // Assignaci贸
  assignedToId         String?
  assignedTo           User?     @relation("LeadAssignments", fields: [assignedToId], references: [id])

  // Relacions
  contacts             Contact[]
  interactions         Interaction[]
  notifications        Notification[]
  events               Event[]
  notes                String?   @db.Text

  // Conversi贸
  convertedToCompanyId String?   @unique
  convertedToCompany   Company?  @relation("LeadConversion", fields: [convertedToCompanyId], references: [id])
  convertedAt          DateTime?

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([assignedToId])
  @@index([status])
  @@index([priority])
}

model Contact {
  id              String         @id @default(cuid())
  name            String
  position        String? // Crrec: CEO, Director RRHH, etc.
  phone           String?
  email           String?
  linkedin        String?
  isPrimary       Boolean        @default(false)

  // Pot estar vinculat a Lead O Company
  companyLeadId   String?
  companyLead     CompanyLead?   @relation(fields: [companyLeadId], references: [id], onDelete: Cascade)

  companyId       String?
  company         Company?       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  interactions    Interaction[]
  events          Event[]
  notes           String?        @db.Text

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([companyLeadId])
  @@index([companyId])
}

model Interaction {
  id                  String    @id @default(cuid())
  type                String // "call", "email", "meeting", "note", "whatsapp"
  subject             String?
  content             String    @db.Text
  outcome             String? // "positive", "neutral", "negative", "no_answer", "scheduled_followup"

  // Seg眉ent acci贸
  nextAction          String?
  nextActionDate      DateTime?
  nextActionCompleted Boolean   @default(false)

  // Relacions (pot ser Lead O Company)
  companyLeadId       String?
  companyLead         CompanyLead? @relation(fields: [companyLeadId], references: [id], onDelete: Cascade)

  companyId           String?
  company             Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  contactId           String?
  contact             Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Qui ho va fer
  createdById         String
  createdBy           User      @relation("InteractionCreator", fields: [createdById], references: [id])

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([companyLeadId])
  @@index([companyId])
  @@index([createdById])
  @@index([nextActionDate])
}

// ============================================================================
// NOTIFICACIONES CRM
// ============================================================================

model Notification {
  id         String               @id @default(cuid())

  // Usuario que recibe la notificaci贸n
  userId     String
  user       User                 @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  // Tipo y prioridad
  type       NotificationType
  priority   NotificationPriority @default(MEDIUM)

  // Contenido
  title      String
  message    String               @db.Text

  // Acci贸n relacionada (opcional)
  actionType String? // "call", "email", "meeting", "follow_up"
  actionUrl  String? // URL a la que navegar al hacer clic

  // Lead relacionado (opcional)
  leadId     String?
  lead       CompanyLead?         @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Empresa relacionada (opcional)
  companyId  String?
  company    Company?             @relation("CompanyNotifications", fields: [companyId], references: [id], onDelete: Cascade)

  // Fecha de vencimiento (para recordatorios)
  dueDate    DateTime?

  // Estado
  isRead     Boolean              @default(false)
  readAt     DateTime?

  // Metadatos adicionales
  metadata   Json?

  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  @@index([userId])
  @@index([type])
  @@index([priority])
  @@index([isRead])
  @@index([dueDate])
  @@index([leadId])
  @@index([companyId])
}

// ============================================================================
// SISTEMA DE MISSATGERIA
// ============================================================================

model Conversation {
  id                     String                    @id @default(cuid())
  name                   String? // Nom del grup o null per converses individuals
  type                   ConversationType          @default(INDIVIDUAL)
  description            String?
  avatar                 String?
  isGroup                Boolean                   @default(false)

  // Configuraci贸
  isArchived             Boolean                   @default(false)
  isMuted                Boolean                   @default(false)
  isPinned               Boolean                   @default(false)

  // Metadades
  lastMessageAt          DateTime?
  createdById            String
  createdBy              User                      @relation("ConversationCreator", fields: [createdById], references: [id])

  // Relacions
  participants           ConversationParticipant[]
  messages               Message[]

  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @updatedAt

  @@index([type])
  @@index([isArchived])
  @@index([lastMessageAt])
}

model ConversationParticipant {
  id               String            @id @default(cuid())
  conversationId   String
  userId           String
  role             ParticipantRole   @default(MEMBER)

  // Configuraci贸 per participant
  isArchived       Boolean           @default(false)
  isMuted          Boolean           @default(false)
  isPinned         Boolean           @default(false)

  // Metadades de lectura
  lastReadAt       DateTime?
  unreadCount      Int               @default(0)

  joinedAt         DateTime          @default(now())
  leftAt           DateTime?

  conversation     Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user             User              @relation("UserConversations", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id               String              @id @default(cuid())
  conversationId   String
  senderId         String
  content          String              @db.Text
  type             MessageType         @default(TEXT)

  // Resposta a missatge
  replyToId        String?
  replyTo          Message?            @relation("MessageReplies", fields: [replyToId], references: [id])
  replies          Message[]           @relation("MessageReplies")

  // Fitxers adjunts
  attachments      MessageAttachment[]

  // Estat del missatge
  status           MessageStatus       @default(SENT)
  isEdited         Boolean             @default(false)
  editedAt         DateTime?

  // Metadades
  metadata         Json?

  conversation     Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender           User                @relation("SentMessages", fields: [senderId], references: [id])
  reads            MessageRead[]

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([replyToId])
}

model MessageAttachment {
  id        String   @id @default(cuid())
  messageId String
  fileName  String
  fileUrl   String
  fileType  String
  fileSize  Int
  mimeType  String?

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([messageId])
}

model MessageRead {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation("ReadMessages", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

// ============================================================================
// SISTEMA D'AGENDA/CALENDARI
// ============================================================================

model Event {
  id             String            @id @default(cuid())
  title          String
  description    String?           @db.Text
  type           EventType         @default(MEETING)

  // Dates i hora
  startDate      DateTime
  endDate        DateTime
  isAllDay       Boolean           @default(false)
  timezone       String            @default("Europe/Madrid")

  // Ubicaci贸
  location       String?
  onlineLink     String? // Per reunions virtuals

  // Estat
  status         EventStatus       @default(CONFIRMED)
  visibility     EventVisibility   @default(PRIVATE)

  // Recordatoris
  reminders      EventReminder[]

  // Recurr猫ncia
  isRecurring    Boolean           @default(false)
  recurrenceRule String? // RRULE format
  parentEventId  String? // Per events recurrents
  parentEvent    Event?            @relation("RecurringEvents", fields: [parentEventId], references: [id])
  childEvents    Event[]           @relation("RecurringEvents")

  // Relacions CRM
  leadId         String?
  lead           CompanyLead?      @relation(fields: [leadId], references: [id])
  companyId      String?
  company        Company?          @relation("CompanyEvents", fields: [companyId], references: [id])
  contactId      String?
  contact        Contact?          @relation(fields: [contactId], references: [id])

  // Organitzador
  organizerId    String
  organizer      User              @relation("OrganizedEvents", fields: [organizerId], references: [id])

  // Participants
  attendees      EventAttendee[]

  // Metadades
  metadata       Json?

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([organizerId])
  @@index([startDate])
  @@index([endDate])
  @@index([type])
  @@index([status])
  @@index([leadId])
  @@index([companyId])
}

model EventAttendee {
  id            String           @id @default(cuid())
  eventId       String
  userId        String? // Pot ser null per convidats externs
  email         String? // Per convidats externs
  name          String? // Per convidats externs
  response      AttendeeResponse @default(PENDING)
  isRequired    Boolean          @default(true)

  respondedAt   DateTime?

  event         Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user          User?            @relation("EventAttendances", fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@unique([eventId, email])
  @@index([eventId])
  @@index([userId])
  @@index([response])
}

model EventReminder {
  id            String         @id @default(cuid())
  eventId       String
  type          ReminderType   @default(NOTIFICATION)
  triggerTime   Int // minuts abans de l'event
  isTriggered   Boolean        @default(false)
  triggeredAt   DateTime?

  event         Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  createdAt     DateTime       @default(now())

  @@index([eventId])
  @@index([isTriggered])
}

// ============================================================================
// SISTEMA DE LMITES DE PLANES
// ============================================================================

model Subscription {
  id                   String   @id @default(cuid())
  companyId            String   @unique
  planType             String // BASIC, STANDARD, PREMIUM, EMPRESARIAL
  status               String   @default("ACTIVE") // ACTIVE, SUSPENDED, CANCELLED
  startDate            DateTime @default(now())
  endDate              DateTime?
  billingCycle         String   @default("MONTHLY") // MONTHLY, ANNUAL
  price                Float?
  currency             String   @default("EUR")
  autoRenew            Boolean  @default(true)

  // L铆mites espec铆ficos del plan
  maxMembers           Int
  maxStorage           BigInt // en bytes
  maxDocuments         Int
  maxOffers            Int
  hasAdvancedReports   Boolean  @default(false)
  hasPrioritySupport   Boolean  @default(false)
  hasApiAccess         Boolean  @default(false)
  hasCustomBranding    Boolean  @default(false)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  company              Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([planType])
  @@index([status])
  @@index([endDate])
}

model CompanyStorage {
  id               String   @id @default(cuid())
  companyId        String   @unique
  usedBytes        BigInt   @default(0)
  maxBytes         BigInt
  documentsCount   Int      @default(0)
  lastCalculatedAt DateTime @default(now())

  // Desglose por tipo de archivo
  documentsBytes   BigInt   @default(0)
  imagesBytes      BigInt   @default(0)
  videosBytes      BigInt   @default(0)
  otherBytes       BigInt   @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([lastCalculatedAt])
}

model Document {
  id               String            @id @default(cuid())
  companyId        String
  name             String
  originalName     String
  mimeType         String
  size             BigInt
  url              String?
  path             String?
  category         String            @default("GENERAL") // GENERAL, CONTRACTS, REPORTS, IMAGES, etc.
  description      String?
  tags             String? // JSON array of tags

  // Metadatos
  isShared         Boolean           @default(false)
  sharedWith       String? // JSON array of user IDs
  permissions      String? // JSON object with permissions

  // Versionado
  version          Int               @default(1)
  parentId         String? // Para versiones
  isLatestVersion  Boolean           @default(true)

  // Control de acceso
  createdById      String
  lastModifiedById String?

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent           Document?         @relation("DocumentVersions", fields: [parentId], references: [id])
  versions         Document[]        @relation("DocumentVersions")
  documentVersions DocumentVersion[]
  exports          DocumentExport[]

  @@index([companyId])
  @@index([category])
  @@index([createdById])
  @@index([parentId])
  @@index([isLatestVersion])
  @@index([createdAt])
}

model DocumentVersion {
  id           String   @id @default(cuid())
  documentId   String
  version      Int
  changes      String   @db.Text // Descripci贸n de los cambios
  size         BigInt
  url          String?
  path         String?

  createdById  String
  createdAt    DateTime @default(now())

  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
  @@index([documentId])
  @@index([version])
  @@index([createdAt])
}

model DocumentExport {
  id            String    @id @default(cuid())
  documentId    String
  format        String // PDF, DOCX, ZIP, etc.
  status        String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  downloadUrl   String?
  expiresAt     DateTime? // Cu谩ndo expira el enlace de descarga

  requestedById String
  completedAt   DateTime?
  errorMessage  String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  document      Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([status])
  @@index([requestedById])
  @@index([expiresAt])
}

model CustomFeature {
  id              String   @id @default(cuid())
  companyId       String
  featureName     String // Nombre de la caracter铆stica personalizada
  featureType     String // INTEGRATION, CUSTOM_FIELD, WORKFLOW, etc.
  description     String?
  configuration   Json? // Configuraci贸n espec铆fica de la caracter铆stica
  isActive        Boolean  @default(true)

  // L铆mites espec铆ficos
  usageLimit      Int? // L铆mite de uso (si aplica)
  currentUsage    Int      @default(0)

  // Precios
  monthlyPrice    Float?
  annualPrice     Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([featureType])
  @@index([isActive])
}

model PlanChangeLog {
  id              String   @id @default(cuid())
  companyId       String
  fromPlan        String // Plan anterior
  toPlan          String // Nuevo plan
  reason          String? // Motivo del cambio

  // Cambios en l铆mites
  changesApplied  Json // Objeto con los cambios aplicados

  // Informaci贸n del cambio
  effectiveDate   DateTime @default(now())
  requestedById   String // Usuario que solicit贸 el cambio
  processedAt     DateTime @default(now())

  // Facturaci贸n
  prorationAmount Float? // Importe de prorrateo
  nextBillingDate DateTime?

  createdAt       DateTime @default(now())

  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([effectiveDate])
  @@index([fromPlan])
  @@index([toPlan])
}

// ============================================
// SISTEMA DE BILLING - PLANES CONFIGURABLES
// ============================================

model PlanConfig {
  id            String   @id @default(cuid())

  // Identificador 煤nico del plan (BASIC, STANDARD, PREMIUM, EMPRESARIAL)
  planType      String   @unique

  // Informaci贸n del plan
  nombre        String // "Pla Bsic"
  nombreCorto   String // "Bsic"
  descripcion   String // Descripci贸n completa

  // Precios
  precioMensual Float // 39.00
  precioAnual   Float? // 390.00 (opcional)

  // Configuraci贸n en JSON
  limitesJSON     String // {"maxUsuarios": 1, "maxStorage": 5, ...}
  caracteristicas String // ["Perfil bsic", "1 membre", ...]

  // Apariencia
  color         String // "#3B82F6"
  icono         String // ""

  // Configuraci贸n
  orden         Int      @default(0)
  destacado     Boolean  @default(false)
  activo        Boolean  @default(true)
  visible       Boolean  @default(true)
  esSistema     Boolean  @default(false) // No se puede eliminar

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([planType])
  @@index([activo, visible])
  @@index([orden])
  @@map("plan_configs")
}

// ============================================================================
// OFERTAS GRUPALES - MODELO BASE AADIDO
// ============================================================================

model Offer {
  id              String             @id @default(cuid())
  companyId       String
  title           String
  description     String             @db.Text
  price           Float
  status          String             @default("PENDING") // o un Enum espec铆fico
  comunidadSlug   String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relaci贸n con Company
  company         Company            @relation(fields: [companyId], references: [id])

  // Campos y relaciones de OFERTAS GRUPALES
  tipo            OfferType          @default(INDIVIDUAL)
  grupalConfig    GroupOfferConfig?
  participantes   GroupParticipant[]
  requestOrigin   GroupOfferRequest?

  @@index([companyId])
  @@index([status])
  @@index([tipo])
}

// 
// TABLA: SOLICITUDES DE OFERTAS GRUPALES
// 

model GroupOfferRequest {
  id                     String          @id @default(cuid())

  //  PASO 1: EMPRESA SOLICITA 

  companyId              String
  company                Company         @relation("CompanyGroupRequests", fields: [companyId], references: [id], onDelete: Cascade)

  // Datos de la solicitud
  productType            String          // "Cotxe el猫ctric Tesla Model 3"
  description            String          // Descripci贸n detallada
  estimatedPrice         Float           // Precio unitario estimado
  minPeople              Int             // M铆nimo deseado
  idealPeople            Int             // Ideal
  startDate              DateTime?       // Fecha deseada de inicio
  duration               Int?            // D铆as de duraci贸n
  needsDeposit           Boolean?        // 驴Necesita dep贸sito?
  observations           String?         // Comentarios adicionales

  //  PASO 2: ADMIN ANALIZA 

  adminReviewedBy        String?
  adminReviewer          User?           @relation("AdminReviewer", fields: [adminReviewedBy], references: [id], onDelete: SetNull)
  adminReviewedAt        DateTime?

  // An谩lisis del admin
  adminViability         String?         // "ALTA" | "MITJANA" | "BAIXA"
  adminComplexity        String?         // "SIMPLE" | "MITJANA" | "ALTA"
  adminRisk              String?         // "BAIX" | "MIG" | "ALT"
  adminNotes             String?         // Notas internas

  // Presupuesto generado por admin
  budgetServiceFee       Float?          // Precio del servicio (ej: 900)
  budgetCommission       Float?          // % comisi贸n (ej: 2%)
  budgetTimeline         Int?            // D铆as totales (ej: 30)
  budgetPhase1Days       Int?            // D铆as fase inscripci贸n
  budgetPhase2Days       Int?            // D铆as fase confirmaci贸n
  budgetPhase3Days       Int?            // D铆as fase entrega
  budgetDeposit          Float?          // Dep贸sito sugerido
  budgetMinPeople        Int?            // M铆nimo sugerido
  budgetMaxPeople        Int?            // M谩ximo sugerido
  budgetPriceScales      Json?           // [{people: 50, price: 33000}, ...]
  budgetPdfUrl           String?         // URL del PDF presupuesto
  budgetNotes            String?         // Notas para el gestor

  //  PASO 3: GESTOR NEGOCIA 

  assignedToGestorId     String?
  assignedToGestor       User?           @relation("GestorAssignments", fields: [assignedToGestorId], references: [id], onDelete: SetNull)
  assignedAt             DateTime?

  // Reuni贸n empresa-gestor
  meetingDate            DateTime?
  meetingNotes           String?         // Notas de la reuni贸n

  // Condiciones finales negociadas
  finalServiceFee        Float?          // Precio negociado
  finalCommission        Float?          // Comisi贸n negociada
  finalTimeline          Int?            // Timeline final
  finalPhase1Days        Int?
  finalPhase2Days        Int?
  finalPhase3Days        Int?
  finalDeposit           Float?
  finalMinPeople         Int?
  finalMaxPeople         Int?
  finalPriceScales       Json?
  finalNotes             String?

  //  PASO 4: OFERTA CREADA 

  createdOfferId         String?         @unique
  createdOffer           Offer?          @relation(fields: [createdOfferId], references: [id], onDelete: SetNull)
  offerCreatedAt         DateTime?

  // Estado del proceso
  status                 RequestStatus   @default(PENDING_ADMIN_REVIEW)

  // Motivos de rechazo
  rejectionReason        String?
  rejectedAt             DateTime?

  // Tracking
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt

  @@index([companyId, status])
  @@index([assignedToGestorId, status])
  @@index([adminReviewedBy])
  @@index([status, createdAt])
  @@map("group_offer_requests")
}

// 
// TABLA: CONFIGURACIN DE OFERTA GRUPAL
// 

model GroupOfferConfig {
  id                      String           @id @default(cuid())
  offerId                 String           @unique
  offer                   Offer            @relation(fields: [offerId], references: [id], onDelete: Cascade)

  //  CONFIGURACIN FINANCIERA 

  // Precio del servicio (pago 煤nico a La P煤blica)
  serviceFee              Float            // Ej: 900
  servicePaid             Boolean          @default(false)
  servicePaymentId        String?          // Stripe Payment Intent ID
  servicePaymentDate      DateTime?

  // Comisi贸n sobre ventas
  commissionRate          Float            // Ej: 2 (significa 2%)

  // Precios y escalas
  precioBase              Float            // Precio inicial sin descuento
  escalas                 Json             // [{minPersonas: 60, precio: 33000}, ...]
  precioActual            Float            // Precio actual seg煤n personas

  //  LMITES Y PERSONAS 

  minPersonas             Int              // M铆nimo para activar
  maxPersonas             Int              // M谩ximo de plazas
  personasActuales        Int              @default(0)
  personasInteresadas     Int              @default(0) // Fase 1
  personasDepositadas     Int              @default(0) // Fase 2
  personasConfirmadas     Int              @default(0) // Fase 3

  maxPorUsuario           Int              @default(1) // M谩ximo por usuario

  //  TIMELINE (3 FASES) 

  // Fase 1: Inscripci贸n (gratis)
  phase1StartDate         DateTime
  phase1EndDate           DateTime
  phase1Days              Int              // Duraci贸n en d铆as

  // Fase 2: Confirmaci贸n con dep贸sito
  phase2StartDate         DateTime?
  phase2EndDate           DateTime?
  phase2Days              Int              // Duraci贸n en d铆as

  // Fase 3: Entrega
  phase3Days              Int              // D铆as desde pago final hasta entrega
  estimatedDeliveryDate   DateTime?

  //  SISTEMA DE PAGOS 

  requiresDeposit         Boolean          // 驴Requiere dep贸sito?
  depositAmount           Float?           // Cantidad del dep贸sito
  depositPercentage       Float?           // O porcentaje del precio

  //  POLTICA DE REEMBOLSOS 

  autoRefundIfNotReached  Boolean          @default(true)
  cancellationHoursBefore Int              @default(48) // Horas antes para cancelar
  refundPolicy            String?          // Texto de la pol铆tica

  //  ESTADO 

  estado                  GroupOfferStatus @default(PROGRAMADA)

  //  ORIGEN Y RESPONSABLES 

  createdByGestorId       String
  createdByGestor         User             @relation("GestorCreatedOffers", fields: [createdByGestorId], references: [id])

  requestOriginId         String?          // Link a la solicitud original

  negotiationNotes        String?          // Notas de la negociaci贸n
  internalNotes           String?          // Notas internas admin/gestor

  //  GAMIFICACIN (OPCIONAL - FASE 7) 

  referralReward          Float?           // Recompensa por referido
  allowReferrals          Boolean          @default(false)

  // Tracking
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  @@index([offerId])
  @@index([estado])
  @@index([createdByGestorId])
  @@index([phase1StartDate, phase1EndDate])
  @@map("group_offer_configs")
}

// 
// TABLA: PARTICIPANTES
// 

model GroupParticipant {
  id                      String            @id @default(cuid())
  offerId                 String
  offer                   Offer             @relation(fields: [offerId], references: [id], onDelete: Cascade)
  userId                  String
  user                    User              @relation("UserGroupParticipations", fields: [userId], references: [id], onDelete: Cascade)

  //  POSICIN Y ESTADO 

  posicion                Int               // N煤mero de inscripci贸n (ej: #37)
  estado                  ParticipantStatus @default(INTERESADO)

  //  PRECIOS 

  precioReservado         Float             // Precio cuando se apunt贸
  precioFinal             Float?            // Precio final al cerrar

  //  PAGOS 

  depositoPagado          Boolean           @default(false)
  montoDepositado         Float?
  stripeDepositId         String?           // Payment Intent del dep贸sito
  fechaDepositoPagado     DateTime?

  pagoCompleto            Boolean           @default(false)
  montoPagoFinal          Float?
  stripeFinalPaymentId    String?           // Payment Intent del pago final
  fechaPagoFinal          DateTime?

  //  TRACKING 

  fechaInscripcion        DateTime          @default(now())
  fechaConfirmacion       DateTime?         // Cuando pag贸 dep贸sito
  fechaCancelacion        DateTime?
  fechaEntrega            DateTime?

  //  NOTIFICACIONES 

  notificarBajadas        Boolean           @default(true)
  notificarCierre         Boolean           @default(true)
  notificarProximoNivel   Boolean           @default(true)

  //  REFERIDOS (OPCIONAL - FASE 7) 

  referidoPor             String?           // userId que lo invit贸
  codigoReferido          String?           // C贸digo 煤nico de referido
  referidosCount          Int               @default(0)

  //  REEMBOLSOS 

  reembolsado             Boolean           @default(false)
  montoReembolsado        Float?
  stripeRefundId          String?
  fechaReembolso          DateTime?
  motivoReembolso         String?

  // Tracking
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt

  @@unique([offerId, userId])
  @@index([userId])
  @@index([offerId, estado])
  @@index([fechaInscripcion])
  @@index([estado])
  @@map("group_participants")
}

// ============================================================================
// ENUMS
// ============================================================================

enum ContentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  EMPLEADO_PUBLICO
  ADMINISTRADOR_GRUPO
  MODERADOR_GRUPO
  GESTOR_CONTENIDO
  GESTOR_EMPRESAS
  GESTOR_ADMINISTRACIONES
  COMPANY_MANAGER
  EMPRESA
  ADMINISTRACION_PUBLICA
}

enum AdministrationType {
  LOCAL
  AUTONOMICA
  CENTRAL
}

enum PermissionType {
  MANAGE_USERS
  MANAGE_ROLES
  MANAGE_PERMISSIONS
  VIEW_ADMIN_DASHBOARD
  MANAGE_SYSTEM_CONFIG
  CREATE_CONTENT
  EDIT_CONTENT
  DELETE_CONTENT
  PUBLISH_CONTENT
  MODERATE_CONTENT
  PIN_CONTENT
  CREATE_POST
  EDIT_POST
  DELETE_POST
  MODERATE_POST
  PIN_POST
  CREATE_COMMENT
  EDIT_COMMENT
  DELETE_COMMENT
  MODERATE_COMMENT
  CREATE_GROUP
  EDIT_GROUP
  DELETE_GROUP
  MANAGE_GROUP_MEMBERS
  MODERATE_GROUP_CONTENT
  PIN_GROUP_CONTENT
  CREATE_FORUM
  EDIT_FORUM
  DELETE_FORUM
  CREATE_FORUM_TOPIC
  EDIT_FORUM_TOPIC
  DELETE_FORUM_TOPIC
  MODERATE_FORUM
  PIN_FORUM_TOPIC
  LOCK_FORUM_TOPIC
  CREATE_ANNOUNCEMENT
  EDIT_ANNOUNCEMENT
  DELETE_ANNOUNCEMENT
  PUBLISH_ANNOUNCEMENT
  PIN_ANNOUNCEMENT
  MANAGE_COMPANIES
  CREATE_COMPANY_PROFILE
  EDIT_COMPANY_PROFILE
  MANAGE_COMPANY_SERVICES
  MANAGE_PUBLIC_ADMINISTRATIONS
  CREATE_ADMIN_PROFILE
  EDIT_ADMIN_PROFILE
  VIEW_REPORTS
  HANDLE_REPORTS
  VIEW_MODERATION_STATS
  BULK_MODERATE
  IMPERSONATE_USER
  VIEW_AUDIT_LOGS
  MANAGE_TRANSLATIONS
  MANAGE_COMMUNITIES
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  EMAIL
  URL
  SELECT
  MULTISELECT
  BOOLEAN
  TEXTAREA
  FILE
}

enum CourseLevel {
  PRINCIPIANT
  INTERMEDI
  SUPERIOR // Corregido: Sin caracteres especiales
}

enum CourseMode {
  ONLINE
  PRESENCIAL
  HIBRID
}

enum CourseCategory {
  TECNOLOGIA
  DISSENY
  MARQUETING_DIGITAL
  GESTIO_I_LIDERATGE
  IDIOMES
  OFIMATICA
  COMPTABILITAT_I_FINANCES
  COMUNICACIO
  RECURSOS_HUMANS
  CIBERSEGURETAT
  DESENVOLUPAMENT_PERSONAL
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum EnrollmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  DROPPED_OUT
}

enum NotificationType {
  REMINDER
  ALERT
  SUCCESS
  INFO
  // Tipos para Ofertas Grupales:
  GROUP_REQUEST_RECEIVED
  GROUP_REQUEST_ASSIGNED
  GROUP_OFFER_APPROVED
  GROUP_OFFER_REJECTED
  GROUP_PHASE1_STARTED
  GROUP_PHASE2_STARTED
  GROUP_PRICE_DROP
  GROUP_NEXT_LEVEL
  GROUP_CLOSING_SOON
  GROUP_MINIMUM_REACHED
  GROUP_COMPLETED
  GROUP_CANCELLED
  GROUP_PAYMENT_DUE
  GROUP_DELIVERED
  GROUP_REFERRAL_JOINED
}

enum NotificationPriority {
  HIGH
  MEDIUM
  LOW
}

enum ConversationType {
  INDIVIDUAL
  GROUP
  ADMIN_CHANNEL
  COMPANY_CHANNEL
}

enum ParticipantRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  VIDEO
  SYSTEM
}

enum MessageStatus {
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum EventType {
  MEETING
  CALL
  PRESENTATION
  TRAINING
  FOLLOW_UP
  DEADLINE
  REMINDER
  OTHER
}

enum EventStatus {
  CONFIRMED
  TENTATIVE
  CANCELLED
  COMPLETED
}

enum EventVisibility {
  PRIVATE
  PUBLIC
  CONFIDENTIAL
}

enum AttendeeResponse {
  PENDING
  ACCEPTED
  DECLINED
  TENTATIVE
}

enum ReminderType {
  NOTIFICATION
  EMAIL
  SMS
}

// 
// ENUMS DE OFERTAS GRUPALES
// 

enum OfferType {
  INDIVIDUAL  // Oferta normal existente
  GRUPAL      // Nueva: Oferta grupal
}

enum GroupOfferStatus {
  PROGRAMADA  // A煤n no ha empezado
  ACTIVA      // Aceptando inscripciones
  COMPLETADA  // Alcanz贸 m铆nimo, cerrada con 茅xito
  CANCELADA   // No alcanz贸 m铆nimo
  FINALIZADA  // Productos entregados
}

enum ParticipantStatus {
  INTERESADO  // Apuntado en Fase 1 (gratis)
  RESERVADO   // Pag贸 dep贸sito en Fase 2
  CONFIRMADO  // Pag贸 total
  CANCELADO   // Usuario cancel贸
  REEMBOLSADO // Dinero devuelto
  ENTREGADO   // Recibi贸 producto/servicio
}

enum PaymentStage {
  DEPOSITO    // Pago de dep贸sito
  FINAL       // Pago final
  COMPLETO    // Pago 煤nico (sin dep贸sito)
  REEMBOLSO   // Devoluci贸n
}

enum RequestStatus {
  PENDING_ADMIN_REVIEW
  ADMIN_REVIEWING
  ASSIGNED_TO_GESTOR
  NEGOTIATING
  NEGOTIATED
  OFFER_CREATED
  PENDING_FINAL_APPROVAL
  APPROVED
  REJECTED_BY_ADMIN
  REJECTED_BY_COMPANY
  CANCELLED
}

// ============================================================================
// MODELO DE CONFIGURACIN GLOBAL (Faltante)
// ============================================================================

model SystemSettings {
  id                   String     @id @default(cuid())
  key                  String     @unique // Clave 煤nica si manejas m煤ltiples ajustes, o 'GLOBAL' si solo es un registro
  value                Json?      // Almacena la configuraci贸n como JSON
  lastUpdatedBy        String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  @@map("system_settings") // Puedes cambiar el nombre de la tabla si lo conoces
}